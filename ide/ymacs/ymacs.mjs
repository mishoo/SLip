let e;let t=document.createElement("template");class i{constructor(e){this._value=e}toString(){return this._value}valueOf(){return this._value}}let r=new class{fromHTML(e){t.innerHTML=e.trim();let i=t.content;return i.children.length>1?i:i.children[0]}addClass(e,t){e.classList.add(t)}delClass(e,t){t instanceof RegExp?e.className=e.className.replace(t,""):e.classList.remove(t)}hasClass(e,t){return e.classList.contains(t)}condClass(e,t,i,r){e.classList.toggle(i,!!t),r&&e.classList.toggle(r,!t)}toggleClass(e,...t){e.classList.toggle(...t)}trash(e){e&&e.remove()}on(e,t,i,s){"string"==typeof t?e.addEventListener(t,i,s||{}):Object.keys(t).forEach(s=>r.on(e,s,t[s],i||{}))}off(e,t,i,s){"string"==typeof t?e.removeEventListener(t,i,s||{}):Object.keys(t).forEach(s=>r.off(e,s,t[s],i||{}))}overlayOn(t){return document.body.appendChild(e),t&&(e.className=t),e}overlayOff(){e.remove()}mousePos(e,t){let i=t.getBoundingClientRect();return{x:e.clientX-i.left,y:e.clientY-i.top}}relPos(e,t=e.offsetParent){let i=e.getBoundingClientRect(),r=t.getBoundingClientRect();return{x:i.left-r.left,y:i.top-r.top}}htmlEscape(e){return e instanceof i?e+"":(e+"").replace(/&/g,"&amp;").replace(/\x22/g,"&quot;").replace(/\x27/g,"&#x27;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u00A0/g,"&#xa0;")}htmlSafe(e){return new i(e)}},s={next:()=>({done:!0})},n=new class{car=null;cdr=this;toString(){return"NIL"}valueOf(){return null}[Symbol.iterator](){return s}get length(){return 0}};class o{constructor(e,t=n){this.car=e,this.cdr=t}[Symbol.iterator](){let e=this;return{next(){if(e===n)return{done:!0};let t=e.car;return e=e.cdr,{value:t}}}}get length(){let e=this,t=0;for(;e!==n;)++t,e=e.cdr;return t}}e=r.fromHTML('<div style="position: fixed; z-index: 20000; left: 0; top: 0; right: 0; bottom: 0"></div>');class a{constructor(e){this._ev_handlers=Object.create(null),this.o=Object.assign(Object.create(this.constructor.options||null),e)}addEventListener(e,t){if("string"==typeof e){let i=this._getHandlers(e);h(i,t),i.push(t)}else Object.keys(e).forEach(t=>this.addEventListener(t,e[t]))}removeEventListener(e,t){"string"==typeof e?h(this._getHandlers(e),t):Object.keys(e).forEach(t=>this.removeEventListener(t,e[t]))}listenOnce(e,t){this.addEventListener(e,function i(...r){return this.removeEventListener(e,i),t.apply(this,r)})}callHooks(e,...t){this._getHandlers(e).forEach(e=>e.apply(this,t))}destroy(){this.callHooks("onDestroy")}_getHandlers(e){return this._ev_handlers[e]||(this._ev_handlers[e]=[])}}class l extends a{constructor(...e){super(...e),this.createElement()}createElement(){let e=document.createElement("div");return e.className=this.initClassName(),e._ymacs_object=this,this.el=e,e}initClassName(){return this.constructor.name}getContentElement(){return this.el}getElement(){return this.el}add(e){e instanceof l&&(e=e.getElement()),this.getContentElement().appendChild(e)}addClass(e){r.addClass(this.getElement(),e)}delClass(e){r.delClass(this.getElement(),e)}hasClass(e){return r.hasClass(this.getElement(),e)}condClass(e,t,i){r.condClass(this.getElement(),e,t,i)}toggleClass(...e){r.toggleClass(this.getElement(),...e)}setContent(e){this.getContentElement().innerHTML=e}setStyle(e,t){let i=this.getElement().style;"string"==typeof e?i[e]=t:Object.assign(i,e)}getBox(){return this.getElement().getBoundingClientRect()}destroy(){r.trash(this.getElement()),super.destroy(...arguments)}}function h(e,t){let i=0;for(;(i=e.indexOf(t,i))>=0;)e.splice(i,1)}function c(e,t=0,i,...r){arguments.length>2&&(e=e.bind(i,...r));let s=null;return function(){clearTimeout(s),s=setTimeout(e,t)}}function d(e,t){var i,r,s=e;return(s<1024?i="B":s<1048576?(s/=1024,i="K"):s<0x40000000?(s/=1048576,i="M"):s<0x10000000000&&(s/=0x40000000,i="G"),r=Math.round(s),t&&s!=r)?s.toFixed(t)+i:r+i}function _(e){return e.trim().split(/\s+/)}function f(e){return _(e).reduce((e,t,i)=>(e[t]=i+1,e),Object.create(null))}function u(e,t){return"string"==typeof e&&(e=_(e)),RegExp("^("+e.join("|")+")$",t)}class m{constructor({pos:e=null,editor:t=null,before:i=!1,name:r=null}={}){this.position=e,this.editor=t,this.before=i,this.name=r,this.editor.markers.push(this),this.rowcol=null,this.onChange=[]}destroy(){h(this.editor.markers,this),this.editor=null}editorChange(e,t,i){var r=this.position;this.before&&--r,0!=t&&e<=r&&(this.rowcol=null,this.position+=t,this.position<i&&(this.position=i),this.callHooks(this.onChange,this.position))}callHooks(e,t){for(var i=e.length;--i>=0;)e[i].call(this.editor,t)}getPosition(){return this.position}valueOf(){return this.position}setPosition(e,t,i){(i||this.position!=e)&&(this.rowcol=null,this.position=e,t||this.callHooks(this.onChange,this.position))}getRowCol(){return this.rowcol||(this.rowcol=this.editor._positionToRowCol(this.position))}swap(e,t,i){var r=this.getPosition();this.setPosition(e.getPosition(),t,i),e.setPosition(r,t,i)}}let p=Object.create(null);class g{constructor(e){this.definitions=Object.create(null),this.defineKeys(e)}static define(e,t){let i=e&&p[e];return!i&&(i=t instanceof this?t:new this(t),e&&(p[e]=i,i.name=e)),i}static get(e){return p[e]}static parseKey(e){let t={str:""},i=e;for(;;){let e=/^([CMS])-/.exec(i);if(e)"C"==e[1]&&(t.ctrlKey=!0),"M"==e[1]&&(t.metaKey=!0),"S"==e[1]&&(t.shiftKey=!0),i=i.substr(2);else{t.key="Space"==i?" ":1==i.length?i.toLowerCase():i;break}}return t.ctrlKey&&(t.str+="C-"),t.metaKey&&(t.str+="M-"),t.shiftKey&&(t.str+="S-"),t.str+=i,t}static unparseKey(e){var t,i=[];return"wheelDelta"in e?t=e.wheelDelta>0?"WheelUp":"WheelDown":((" "==(t=e.key)||"Unidentified"==t&&"Space"==e.code)&&(t="Space"),1==t.length&&(t=t.toLowerCase())),e.ctrlKey&&i.push("C"),(e.altKey||e.ymacsMeta)&&i.push("M"),e.shiftKey&&(t.length>1||t.toLowerCase()!=t.toUpperCase())&&i.push("S"),i.sort(),i.push(t),i.join("-")}defineKey(e,t,i){if(t instanceof Array&&(i=t.slice(1),t=t[0]),(e=e.trim().split(/\s*&&\s*/)).length>1)e.forEach(e=>this.defineKey(e,t,i));else{e=e[0].trim();var r=this.definitions;if(e.indexOf(" ")>=0){var s=e.split(/\s+/);e=s.pop(),s.forEach(e=>{r[e=this.parseKey(e).str]||(r[e]={}),r=r[e]})}r[(e=this.parseKey(e)).str]=[t,i]}}defineKeys(e){Object.keys(e).forEach(t=>this.defineKey(t,e[t]))}getHandler(e){let t=null,i=this.definitions;for(let r of e){let e=t?t[r]:i[r];if(e){if(Array.isArray(t=e))break}else{t=null;break}}return t}attached(){}detached(){}}function b(e){this.message=e}function w(e,t){if(1==arguments.length)t=e,e=null;else{let e;t instanceof Function||(e=t,t=arguments[2],t.ymacsDoc=e)}if(t.ymacsInteractive=!0,null!=e){if(!Array.isArray(e)){var i=/^[\^\@\*]+/.exec(e);i&&(i=i[0],e=e.substr(i.length),i.indexOf("^")>=0&&(t.ymacsMarkExtend=!0),i.indexOf("*")>=0&&(t.ymacsWarnReadonly=!0),i.indexOf("@")>=0&&(t.ymacsSelectFrame=!0)),e&&(e=e.split(/\n+/))}if(e){let i,r=function(...e){return i=i.concat(e),this.callInteractively(t,i,!0)};for(;e.length>0;){let t=r;r=function(e,t){let i=M[e.charAt(0)];return e=e.substr(1),function(){return i.call(this,e,t)}}(e.pop(),function(...e){return i=i.concat(e),t.call(this)})}t.ymacsCallInteractively=function(){return i=[],r.call(this)}}}return t}function k(e){return w("p",function(t){for(null==t&&(t=1);t-- >0;)e.call(this)})}g.prototype.parseKey=g.parseKey;var y=function(){};function v(e){var t=this.getPrefixArg(!0);return t&&(e=t+" "+e),this.cmd("minibuffer_prompt",e)}function x(e,t){return v.call(this,e),this.cmd("minibuffer_read_string",null,t)}function C(e,t){return v.call(this,e),this.cmd("minibuffer_read_number",t)}y.toString=function(){return""},y.empty=!0;var M={a:function(e,t){return console.log("read_function_name",e),v.call(this,e),this.cmd("minibuffer_read_function",t)},b:function(e,t){return v.call(this,e),this.cmd("minibuffer_read_buffer",t)},B:function(e,t){return v.call(this,e),this.cmd("minibuffer_read_buffer",t)},c:function(e,t){},C:function(e,t){return v.call(this,e),this.cmd("minibuffer_read_command",t)},d:function(e,t){return t.call(this,this.point())},e:function(e,t){},i:function(e,t){return t.call(this,null)},k:function(e,t){},K:function(e,t){},m:function(e,t){return t.call(this,this.markMarker.getPosition())},M:x,n:C,N:function(e,t){var i=parseInt(this.getPrefixArg(),10);return isNaN(i)?C.call(this,e,t):t.call(this,i)},p:function(e,t){var i=parseInt(this.getPrefixArg(),10);return isNaN(i)&&(i=null),t.call(this,i)},P:function(e,t){return""===(e=this.getPrefixArg())&&(e=y),t.call(this,e)},r:function(e,t){var i=this.getRegion();return t.call(this,i.begin,i.end)},s:x,U:function(e,t){},v:function(e,t){return v.call(this,e),this.cmd("minibuffer_read_variable",t)},f:function(e,t){return v.call(this,e),this.cmd("minibuffer_read_existing_file",t)},F:function(e,t){return v.call(this,e),this.cmd("minibuffer_read_file",t)},G:function(e,t){return v.call(this,e),this.cmd("minibuffer_read_file_or_directory",t)},D:function(e,t){return v.call(this,e),this.cmd("minibuffer_read_directory",t)}};let E={"ArrowLeft   && C-b":"backward_char","ArrowRight  && C-f":"forward_char",Home:"beginning_of_indentation_or_line","End && C-e":"end_of_line","C-a":"beginning_of_line","C-Home && M-<":"beginning_of_buffer","C-End && M->":"end_of_buffer","C-ArrowRight && M-f":"forward_word","C-ArrowLeft && M-b":"backward_word","S-ArrowLeft     && S-C-b":"backward_char_mark","S-ArrowRight    && S-C-f":"forward_char_mark","S-C-ArrowRight  && S-M-f":"forward_word_mark","S-C-ArrowLeft   && S-M-b":"backward_word_mark","S-Home":"beginning_of_indentation_or_line_mark","S-C-a":"beginning_of_line_mark","S-End && S-C-e":"end_of_line_mark","S-C-Home":"beginning_of_buffer_mark","S-C-End":"end_of_buffer_mark",Backspace:"backward_delete_char","Delete && C-d":"delete_char","M-d && C-Delete":"kill_word","C-Backspace && M-Backspace && M-Delete":"backward_kill_word","C-k":"kill_line","C-y && S-Insert":"yank","M-y":"yank_pop","C-Space":"set_mark_command","C-x C-x":"exchange_point_and_mark","C-w":"kill_region","M-t":"transpose_words","C-t":"transpose_chars","M-w":"copy_region_as_kill","M-c":"capitalize_word","M-u":"upcase_word","M-l":"downcase_word",F11:"nuke_trailing_whitespace","C-/ && C-x u && C-_ && C-z":"undo",Insert:"overwrite_mode","M-/":"dabbrev_expand","C-g":"keyboard_quit",Escape:"keyboard_quit","C-S-y && C-v":"yank_from_operating_system","M-S-w":"copy_for_operating_system","C-c /":"close_last_xml_tag","S-Backspace":"backward_delete_whitespace","S-Delete":"delete_whitespace","C-x =":"what_cursor_position"},T=Object.assign({},E,{"ArrowUp     && C-p":"backward_line","ArrowDown   && C-n":"forward_line","ArrowLeft   && C-b":"backward_char","ArrowRight  && C-f":"forward_char",Home:"beginning_of_indentation_or_line","End && C-e":"end_of_line","C-a":"beginning_of_line","C-Home && M-<":"beginning_of_buffer","C-End && M->":"end_of_buffer","C-ArrowRight && M-f":"forward_word","C-ArrowLeft && M-b":"backward_word","C-ArrowDown":"forward_paragraph","C-ArrowUp":"backward_paragraph","M-h":"mark_paragraph","C-l":"recenter_top_bottom",PageUp:"scroll_up_half",PageDown:"scroll_down_half",WheelUp:"scroll_up",WheelDown:"scroll_down","S-ArrowUp       && S-C-p":"backward_line_mark","S-ArrowDown     && S-C-n":"forward_line_mark","S-ArrowLeft     && S-C-b":"backward_char_mark","S-ArrowRight    && S-C-f":"forward_char_mark","S-C-ArrowRight  && S-M-f":"forward_word_mark","S-C-ArrowLeft   && S-M-b":"backward_word_mark","S-C-ArrowDown":"forward_paragraph_mark","S-C-ArrowUp":"backward_paragraph_mark","S-Home":"beginning_of_indentation_or_line_mark","S-C-a":"beginning_of_line_mark","S-End && S-C-e":"end_of_line_mark","S-C-Home":"beginning_of_buffer_mark","S-C-End":"end_of_buffer_mark",Backspace:"backward_delete_char","Delete && C-d":"delete_char","Enter && C-m":"newline","M-d && C-Delete":"kill_word","C-Backspace && M-Backspace && M-Delete":"backward_kill_word","C-k":"kill_line","C-y && S-Insert":"yank","M-y":"yank_pop","C-Space":"set_mark_command","C-x C-x":"exchange_point_and_mark","C-w":"kill_region","M-t":"transpose_words","C-t":"transpose_chars","C-x C-t":"transpose_lines","M-w":"copy_region_as_kill","M-c":"capitalize_word","M-u":"upcase_word","M-l":"downcase_word",F11:"nuke_trailing_whitespace",Tab:"indent_line","C-M-\\":"indent_region","M-q":"fill_paragraph","C-/ && C-x u && C-_ && C-z":"undo",Insert:"overwrite_mode","M-s":"center_line","M-/":"dabbrev_expand","C-s":"isearch_forward","C-r":"isearch_backward","C-S-s":"isearch_yank_word_or_char","M-C-s":"isearch_forward_regexp","M-C-r":"isearch_backward_regexp","M-%":"query_replace","C-M-%":"query_replace_regexp","C-u":"universal_argument","M-g":"goto_line","C-x h":"mark_whole_buffer","C-g":"keyboard_quit","M-^":"delete_indentation","M-;":"comment_dwim","C-x =":"what_cursor_position","C-x f":"set_fill_column","C-x C-\\":"goto_last_change","C-x r t":"string_rectangle","C-x r c":"clear_rectangle","C-x r k":"kill_rectangle","C-x r y":"yank_rectangle","C-x C-ArrowRight && C-x ArrowRight && C-Tab":"next_buffer","C-x C-ArrowLeft && C-x ArrowLeft && C-S-Tab":"previous_buffer","C-x b":"switch_to_buffer","C-x k":"kill_buffer","C-x 0":"delete_frame","C-x 1":"delete_other_frames","C-x 2":"split_frame_vertically","C-x 3":"split_frame_horizontally","C-x o && M-o":"other_frame","C-x l":"toggle_line_numbers","M-x":"execute_extended_command","C-S-y && C-v":"yank_from_operating_system","M-S-w":"copy_for_operating_system","M-S-y":"yank_shift","C-c /":"close_last_xml_tag","S-Backspace":"backward_delete_whitespace","S-Delete":"delete_whitespace","C-M-d":"delete_region_or_line","M-Enter":"start_next_paragraph","C-M-|":"cperl_lineup","C-F4":"kill_buffer","M-ArrowLeft":["windmove","left"],"M-ArrowRight":["windmove","right"],"M-ArrowUp":["windmove","up"],"M-ArrowDown":["windmove","down"],"C-x e":"kmacro_end_and_call_macro","C-x (":"kmacro_start_macro","C-x )":"kmacro_end_macro","C-x C-f":"find_file","C-x C-w":"write_file","C-x C-s":"save_buffer","C-x s":"save_some_buffers","C-x r w":"window_configuration_to_register","C-x r j":"jump_to_register","C-h m":"describe_mode"}),P=g.define("emacs_mb",E);P.defaultHandler=["self_insert_command"];let S=g.define("emacs",T);S.defaultHandler=["self_insert_command"];let A=g.define("universal_arg",{});A.defaultHandler=[w("^",function(){var e=this.interactiveEvent(),t=e.key,i=this.getPrefixArg(!0);return!/^[0-9]$/.test(t)&&("-"!==t||""!==i)||e.altKey||e.ctrlKey?(this.popKeymap(A),!1):(i+=t,this.setPrefixArg(i),this.isMinibuffer||this.whenMinibuffer(function(e){e.cmd("insert"," ",t)}),!0)})],A.attached=e=>e.setPrefixArg("");class L extends a{constructor({buffer:e}){super(...arguments),this.buffer=e,this.reset()}reset(){this.props=[]}insertLine(e){this.props.length<e?this.props[e]=null:this.props.splice(e,0,null)}deleteLine(e){this.props.splice(e,1)}replaceLine(e,t){var i=this.props[e];i&&i.length>t.length&&i.splice(t.length)}addLineProps(e,t,i,r,s){var n,o=this.props,a=!1;if(t<i){for(o=o[e]||(o[e]=[]);t<i;)(n=o[t]||(o[t]={}))[r]!=s&&(a=!0),n[r]=s,++t;a&&this.callHooks("onChange",e)}return a}removeLineProps(e,t,i,r){var s,n=this.props[e],o=!1;if(n&&t<i){for(;t<i;)(s=n[t])&&r in s&&(o=!0,delete s[r]),++t;o&&this.callHooks("onChange",e)}return o}spliceLineProps(e,t,i){let r=this.props[e];r&&(i>0?r.splice(t,0,...Array(i)):i<0&&r.splice(t,-i))}getLineHTML(e,t,i){var s=this.props[e];if(null===i){if(""==t)return"<br/>";if(!s||0==s.length)return r.htmlEscape(t)}else{if(""==t)return"<span class='Ymacs-caret'>&nbsp;</span>";if(!s||0==s.length)return i===t.length?r.htmlEscape(t)+"<span class='Ymacs-caret'>&nbsp;</span>":r.htmlEscape(t.substr(0,i))+"<span class='Ymacs-caret'>"+r.htmlEscape(t.charAt(i))+"</span>"+r.htmlEscape(t.substr(i+1))}for(var n,o,a=0,l=t.length,h=null,c="";a<l;){if(n=(n=s[a])&&n.css,a===i&&(n=n?n+" Ymacs-caret":"Ymacs-caret"),n&&n!=h){h&&(c+="</a>"),c+="<a ";let e=n;n=n.replace(/:href-([^\s]*)/g,function(e,t){return t&&(c+=`href="${t}" `),""}),c+="class='"+n+"'>",n=e}else!n&&h&&(c+="</a>");switch(h=n,o=t.charAt(a)){case"<":c+="&lt;";break;case">":c+="&gt;";break;case"&":c+="&amp;";break;default:c+=o}++a}return h&&(c+="</a>"),a===i&&(c+="<span class='Ymacs-caret'>&nbsp;</span>"),c}}let O={case_fold_search:null,case_replace:!0,line_movement_requested_col:0,fill_column:78,tab_width:8,indent_level:4,sticky_mark:!1,syntax_word:/^[\p{N}\p{L}]$/u,syntax_capitalize_word:/([\p{N}\p{L}])([\p{N}\p{L}]*)/ug,syntax_word_dabbrev:/^[\p{N}_$\p{L}]$/u,syntax_word_sexp:/^[\p{N}_$\p{L}]$/u,syntax_paragraph_sep:/\n(?:[^\S\r\n]*\n)+/g};function I(e,t){if("string"==typeof e)return void 0===t?delete this[e]:this[e]=t,t instanceof Function&&(t.ymacsCommand=e),t;var i=Object.create(null);for(var r in e)i[r]=this[r],I.call(this,r,e[r]);return i}function N(e){return e instanceof m?e.getPosition():e}class R extends a{static options={name:"*scratch*",code:"",ymacs:null,tokenizer:null};static COMMANDS=Object.create(null);static newCommands(...e){return I.apply(this.COMMANDS,e)}static replaceCommands(e){this.COMMANDS=Object.assign(Object.create(null),this.COMMANDS);let t=Object.create(null);return Object.keys(e).forEach(i=>{let r=e[i];"string"==typeof r&&(r=this.COMMANDS[r]),t[i]=r}),this.newCommands(t)}static newMode(e,t){let i="*"+e+"*",r=i+"hooks";R.setGlobal(r,[]),this.COMMANDS[e]=w("P",function(s){let n=this.getq(i);if(n)!0!==s&&(this.getq(r).forEach(e=>e.call(this,!1)),n instanceof Function&&n.call(this),this.setq(i,null),h(this.modes,e));else if(!1!==s){let s=t.apply(this,arguments);s instanceof Function||(s=!0),this.setq(i,s),this.modes.push(e),this.getq(r).forEach(e=>e.call(this,!0))}return n})}static getVariable(e){return O[e]}static setVariable(){return I.apply(O,arguments)}constructor(...e){super(...e),this.isMinibuffer=this instanceof F,this.COMMANDS=Object.assign(Object.create(null),this.COMMANDS),this.name=this.o.name,this.ymacs=this.o.ymacs,this.tokenizer=this.o.tokenizer,this.__savingExcursion=0,this.__preventUpdates=0,this.__preventUndo=0,this.__undoInProgress=0,this.__dirtyLines=[],this.__undoQueue=[],this.__undoPointer=0,this.markers=[],this.caretMarker=this.createMarker(0,!1,"point"),this.markMarker=this.createMarker(0,!0,"mark"),this.matchData=[],this.previousCommand=null,this.currentCommand=null,this.currentKeys=[],this.variables=Object.create(null),this.globalVariables=O,this.modes=[],this.caretMarker.onChange.push(function(e){this._rowcol=this.caretMarker.getRowCol(),this.__preventUpdates||this.callHooks("onPointChange",this._rowcol,this.point())}),this._tokenizerEvents={onFoundToken:this._on_tokenizerFoundToken.bind(this)},this._textProperties=new L({buffer:this}),this._textProperties.addEventListener("onChange",this._on_textPropertiesChange.bind(this)),this.keymap=[],this.pushKeymap(this.makeDefaultKeymap()),this.setCode(this.o.code),this._lastCommandWasKill=0}addModeHook(e,t){"string"==typeof t&&(t=this.COMMANDS[t]),this.getq("*"+e+"*hooks").pushUnique(t)}removeModeHook(e,t){"string"==typeof t&&(t=this.COMMANDS[t]),h(this.getq("*"+e+"*hooks"),t)}withVariables(e,t){var i=this.variables;this.variables=Object.assign(Object.create(this.variables),e);try{if(t instanceof Function)return t.apply(this,[...arguments].slice(2));return this.cmdApply(t,[...arguments].slice(2))}finally{this.variables=i}}withCommands(e,t){var i=this.COMMANDS;this.COMMANDS=Object.assign(Object.create(this.COMMANDS),e);try{if(t instanceof Function)return t.apply(this,[...arguments].slice(2));return this.cmdApply(t,[...arguments].slice(2))}finally{this.COMMANDS=i}}getVariable(e){return e in this.variables?this.variables[e]:O[e]}setVariable(){return I.apply(this.variables,arguments)}lastIndexOfRegexp(e,t,i,r=0){let s;for(t.global||(t=RegExp(t.source,t.flags+"g")),t.lastIndex=r;;){let r=t.lastIndex,n=t.exec(e);if(!n||t.lastIndex>i)break;if((s=n).after=t.lastIndex,t.lastIndex<=r){let i=/[^]/ug;i.lastIndex=t.lastIndex,i.exec(e),t.lastIndex=i.lastIndex}}if(s)return this.matchData=s}pushKeymap(e){e instanceof Array?e.forEach(this.pushKeymap,this):(this.popKeymap(e),this.keymap.push(e),e.attached(this))}popKeymap(e){h(this.keymap,e),e.detached(this)}makeDefaultKeymap(){return this.isMinibuffer?P:S}signalError(e,t,i){this.ymacs.indicateError(),this.callHooks("onMessage",{type:"error",text:e,isHtml:t,timeout:i})}signalInfo(e,t,i){this.callHooks("onMessage",{type:"info",text:e,isHtml:t,timeout:i})}popupMessage(e){this.callHooks("onMessage",e)}createMarker(e,t,i){return null==e&&(e=this.point()),new m({editor:this,pos:e,name:i,before:t})}point(){return this.caretMarker.getPosition()}dirty(e){return null!=e&&(this.__isDirty=e,this.updateModeline()),this.__isDirty}setCode(e){this.dirty(!1),this.__code=e,this.__size=e.length,this.__undoQueue=[],this.__undoPointer=0,this.markers.map(e=>e.setPosition(0,!0,!0)),this.code=e.split(/\n/),this._textProperties.reset(),this.tokenizer&&this.tokenizer.reset(),this.callHooks("onResetCode",this.code),this.caretMarker.setPosition(0,!1,!0),this.markMarker.setPosition(0,!0),this.forAllFrames(e=>{e.ensureCaretVisible(),e.redrawModelineWithTimer()})}setTokenizer(e){null!=this.tokenizer&&this.tokenizer.removeEventListener(this._tokenizerEvents),this.tokenizer=e,e?(e.addEventListener(this._tokenizerEvents),e.reset()):(this._textProperties.reset(),this.callHooks("onResetCode",this.code))}getCode(){return this.__code||(this.__code=this.code.join("\n"))}getCodeSize(){if(this.__size)return this.__size;for(var e=this.code.length,t=e>0?-1:0;--e>=0;)t+=this.code[e].length+1;return this.__size=t}getLine(e){return null==e&&(e=this._rowcol.row),this.code[e]}charAtRowCol(e,t){let i=this.code.length;if(e>=i--)return null;var r=this.code[e];return t==r.length?e==i?null:"\n":r.charAt(t)}charAt(e){null==e?e=this.point():(e=N(e))<0&&(e+=this.point());var t=this._positionToRowCol(e);return this.charAtRowCol(t.row,t.col)}callInteractively(e,t,i){var r;if(t||(t=[]),e instanceof Function?r=e.ymacsCommand||null:(r=e,e=this.COMMANDS[e]),e.ymacsCallInteractively&&!i)return e.ymacsCallInteractively.apply(this,t);this.currentCommand=r,this.previousCommand!=r?(this.sameCommandCount(0),"undo"!=r&&this._placeUndoBoundary()):("self_insert_command"!=r||this.sameCommandCount()%20==0)&&"undo"!=r&&this._placeUndoBoundary(),this.preventUpdates();try{return this.callHooks("beforeInteractiveCommand",r,e),e.ymacsMarkExtend||this.getq("sticky_mark")||this.clearTransientMark(),e.apply(this,t)}catch(e){if(e instanceof b)this.signalError(e.message);else throw e}finally{this.getq("sticky_mark")&&this.ensureTransientMark(),"undo"!=r&&(this.__undoPointer=this.__undoQueue.length),this.resumeUpdates(),this.callHooks("afterInteractiveCommand",r,e),this.previousCommand=r,this.sameCommandCount(1),this.tokenizer&&this.tokenizer.start()}}resetOverwriteMode(e){0==arguments.length&&(e=this.overwriteMode),this.callHooks("onOverwriteMode",this.overwriteMode=!e),this.signalInfo(e?"Insert mode":"Overwrite mode")}getMinibuffer(){return this.whenYmacs(function(e){return e.minibuffer})}getMinibufferFrame(){return this.whenYmacs(function(e){return e.minibuffer_frame})}setMinibuffer(e){this.whenMinibuffer(function(t){t.setCode(e),t.cmd("end_of_buffer")})}cmd(e,...t){return this.COMMANDS[e].apply(this,t)}cmdApply(e,t){return this.COMMANDS[e].apply(this,t)}forEachLine(e,t=this.markMarker(),i=this.point()){if(t=N(t),(i=N(i))<t){let e=t;t=i,i=e}t=this._positionToRowCol(t),i=this._positionToRowCol(i);for(let r=t.row;r<=i.row;++r){let s=r==t.row?t.col:0,n=r==i.row?i.col:this.getLine(r).length;e(r,s,n)}}getActiveFrame(){return this.whenYmacs("getActiveFrame")}when(e,t,...i){if(null!=(e=this[e]||this.getq(e)))if(t instanceof Function)return t.call(this,e);else return e[t].apply(e,i)}whenActiveFrame(){var e=this.getActiveFrame();if(e.buffer===this){this.activeFrame=e;var t=["activeFrame",...arguments];return this.when.apply(this,t)}this.activeFrame=null}forAllFrames(e){this.ymacs&&this.ymacs.getBufferFrames(this).forEach(e)}whenYmacs(){var e=["ymacs",...arguments];return this.when.apply(this,e)}whenMinibuffer(e){return this.whenYmacs(function(t){if(t.minibuffer)return e.call(this,t.minibuffer)})}withMarkers(e,...t){let i=t.map(e=>this.createMarker(e));try{return e.apply(this,i)}finally{i.forEach(e=>e.destroy())}}preventUpdates(){++this.__preventUpdates}resumeUpdates(){0==(this.__preventUpdates=Math.max(this.__preventUpdates-1,0))&&this.redrawDirtyLines()}getRegion(e=this.caretMarker,t=this.markMarker){if(e=N(e),(t=N(t))<e){var i=e;e=t,t=i}return{begin:e,end:t}}redrawDirtyLines(){this.callHooks("beforeRedraw"),this.__dirtyLines.forEach((e,t)=>{e&&this.callHooks("onLineChange",t)}),this.__dirtyLines=[],this.callHooks("afterRedraw")}setOverlay(e,t){this.callHooks("onOverlayChange",e,t)}deleteOverlay(e){this.callHooks("onOverlayDelete",e)}setMark(e=this.point()){this.markMarker.setPosition(e)}ensureTransientMark(){var e,t=this._rowcol;this.transientMarker||(this.transientMarker=this.createMarker(),this.markMarker.setPosition(this.point()),e=t),e||(e=this.transientMarker.getRowCol()),this.setOverlay("selection",{line1:e.row,col1:e.col,line2:t.row,col2:t.col})}clearTransientMark(){this.transientMarker&&(this.transientMarker.destroy(),this.transientMarker=null,this.deleteOverlay("selection"),this.setq("sticky_mark",!1))}deleteTransientRegion(){if(this.transientMarker)return this._deleteText(this.caretMarker,this.transientMarker),this.clearTransientMark(),this._placeUndoBoundary(),!0}static #e=0;sameCommandCount(e){return null==e?R.#e:0==e?R.#e=0:R.#e+=e}static #t=null;interactiveEvent(e){return 0==arguments.length?R.#t:R.#t=e}getPrefixArg(e){var t=this.getq("universal_prefix");return!e&&void 0!==t&&(this.setq("universal_prefix",void 0),this.isMinibuffer||this.setMinibuffer("")),t}setPrefixArg(e){return this.setq("universal_prefix",e)}updateModeline(){this.callHooks("onModelineChange")}renderModelineContent(e,t){var i=(this.dirty()?"**":"--")+` <span class="mode-line-buffer-id">${r.htmlEscape(this.name)}</span>`+"  "+t+" of "+d(this.getCodeSize(),2).toLowerCase()+"  ("+(e.row+1)+","+e.col+") ",s=this.getq("modeline_custom_handler");return s&&(s=s.call(this,this,e))&&(i+="["+s+"] "),i}_recordChange(e,t,i,r){if(i>0){var s=this.__undoQueue;this.__preventUndo?s.forEach(r=>{3==r.type?r.markers.forEach(r=>{r[1]>=t&&(r[1]+=1==e?i:-i)}):r.pos>=t&&(r.pos+=1==e?i:-i)}):(s.push({type:e,pos:t,len:i,text:r,dirty:this.dirty()}),s.length>5e4&&s.shift(),this.dirty(!0))}}_placeUndoBoundary(){var e=this.__undoQueue,t=this.markers.map(e=>[e,e.getPosition()]),i=e.at(-1);i&&3==i.type?i.markers=t:e.push({type:3,markers:t})}_playbackUndo(){var e=this.__undoQueue;if(0==e.length)return!1;++this.__undoInProgress;for(var t,i=!1;--this.__undoPointer>=0;){if(3==(t=e[this.__undoPointer]).type){if(t.markers.forEach(e=>e[0].setPosition(e[1])),!i)continue;break}i=!0;var r=t.pos;switch(t.type){case 1:this._deleteText(r,r+t.len);break;case 2:this._insertText(t.text,r)}this.dirty(t.dirty)}return--this.__undoInProgress,i}_replaceLine(e,t){this.code[e]=t,this._textProperties.replaceLine(e,t),this.__preventUpdates?this.__dirtyLines[e]=!0:this.callHooks("onLineChange",e)}_deleteLine(e){this.code.splice(e,1),this._textProperties.deleteLine(e),this.tokenizer&&this.tokenizer.quickDeleteLine(e),this.__dirtyLines.splice(e,1),this.callHooks("onDeleteLine",e)}_insertLine(e,t){this.code.splice(e,0,t),this._textProperties.insertLine(e),this.tokenizer&&this.tokenizer.quickInsertLine(e);var i=!this.__preventUpdates;this.callHooks("onInsertLine",e,i),i||(this.__dirtyLines.length<=e?this.__dirtyLines[e]=!0:this.__dirtyLines.splice(e,0,!0))}_insertText(e,t){if(0!=e.length){null==t&&(t=this.caretMarker.getPosition()),t=N(t),this._recordChange(1,t,e.length);var i=t==this.point()?this._rowcol:this._positionToRowCol(t),r=i.row;if(/^\n+$/.test(e)&&0==i.col)for(let t=0;t<e.length;++t)this._insertLine(r+t,"");else{var s=e.split("\n"),n=this.code[r],o=n.substr(i.col);s.length>1?(this._replaceLine(r,n.substr(0,i.col)+s.shift()),s.forEach(e=>this._insertLine(++r,e)),this._replaceLine(r,this.code[r]+o)):this._replaceLine(r,n.substr(0,i.col)+s[0]+n.substr(i.col))}this._updateMarkers(t,e.length),this.callHooks("onChange",1,t,e)}}_deleteText(e,t){if(e=this._boundPosition(N(e)),t=this._boundPosition(N(t)),e!=t){if(t<e){var i=e;e=t,t=i}this._recordChange(2,e,t-e,this._bufferSubstring(e,t));var r=this._positionToRowCol(e),s=this._positionToRowCol(t),n=this.code[r.row];if(r.row==s.row)n=n.substr(0,r.col)+n.substr(s.col),this._replaceLine(r.row,n);else{n=n.substr(0,r.col)+this.code[s.row].substr(s.col),this._replaceLine(r.row,n),n=r.row+1;for(let e=s.row-r.row;e-- >0;)this._deleteLine(n)}this._updateMarkers(e,e-t,e),this.callHooks("onChange",2,e,t)}}_replaceText(e,t,i){this._deleteText(e,t),this._insertText(i,e)}_swapAreas(e){var t=(e=e.map(N).sort((e,t)=>e-t))[0],i=e[1],r=e[2],s=e[3],n=this._bufferSubstring(t,i),o=this._bufferSubstring(r,s);return this._replaceText(r,s,n),this._replaceText(t,i,o),s}_bufferSubstring(e,t){if(e=null==e?this.point():N(e),(t=null==t?this.getCodeSize():N(t))<e){var i=e;e=t,t=i}return this.getCode().substring(e,t)}_killingAction(e,t,i,r){e=N(e),t=N(t);var s=this._bufferSubstring(e,t);this._saveKilledText(s,i),r||this._deleteText(e,t),this.clearTransientMark()}_saveKilledText(e,t){if(this._lastCommandWasKill||this.ymacs.killRingToMaster(),this.ymacs.pushToKillRing(e,t),this._lastCommandWasKill++,this.interactiveEvent())try{navigator.clipboard.writeText(this.ymacs.killRingText())}catch{}}_positionToRowCol(e){for(var t=0,i=this.code,r=i.length;e>0&&t<r;){var s=i[t].length;if(s>=e)break;e-=s+1,t++}return{row:t,col:e}}_rowColToPosition(e,t){var i=0,r=this.code,s=Math.min(e,r.length-1),n=s;if(s<0)return 0;for(;--s>=0;)i+=r[s].length+1;return i+Math.min(t,r[n].length)}_boundPosition(e){return e<0?0:Math.min(e,this.getCodeSize())}_repositionCaret(e){var t=this.caretMarker.getPosition();return null==e&&(e=t),e=N(e),e=this._boundPosition(e),this.caretMarker.setPosition(e),e!=t}_updateMarkers(e,t,i=0){if(this.__size=null,this.__code=null,this.markers.map(r=>r.editorChange(e,t,i)),this.tokenizer){let i=this._positionToRowCol(Math.min(e,e+t)).row;this.tokenizer.truncate(i)}}_saveExcursion(e,t){var i=this.createMarker(null,t);++this.__savingExcursion;try{return e.call(this)}finally{--this.__savingExcursion,this.caretMarker.swap(i,!1,!0),i.destroy()}}_disableUndo(e){++this.__preventUndo;try{return e.call(this)}finally{--this.__preventUndo}}_handleKeyEvent(e){var t=!1;this.interactiveEvent(e);var i=this._lastCommandWasKill;this.__nextIsMeta&&(e.ymacsMeta=!0),this.__nextIsMeta=!1;var r=g.unparseKey(e),s=this.currentKeys,n=!1;s.push(r);for(let e=this.keymap.length;--e>=0;){let i=this.keymap[e],r=i.getHandler(s);if(r instanceof Array?(this.callInteractively(r[0],r[1]),t=!0):r?t=n=!0:i.defaultHandler&&1==s.length&&(t=this.callInteractively(i.defaultHandler[0],i.defaultHandler[1])),t)break}return n||(!t&&s.length>1&&(this.signalError(s.join(" ").bold()+" is undefined",!0),t=!0),s.splice(0,s.length)),this._lastCommandWasKill!=i||"object"==typeof t||this.__nextIsMeta||(this._lastCommandWasKill=0),this.callHooks("finishedEvent",t),this.interactiveEvent(null),t||this.isMinibuffer}_on_tokenizerFoundToken(e,t,i,r){r?this._textProperties.addLineProps(e,t,i,"css",r):this._textProperties.removeLineProps(e,t,i,"css")}_on_textPropertiesChange(e){this.__preventUpdates?this.__dirtyLines[e]=!0:this.callHooks("onLineChange",e)}formatLineHTML(e,t){var i=this._rowcol;return t instanceof m&&(i=t.getRowCol()),t=e==i.row?i.col:null,this._textProperties.getLineHTML(e,this.code[e],t)}looking_at(e){var t=this.getCode();if(e instanceof RegExp){var i=e.lastIndex=this.point(),r=e.exec(t);if(r&&r.index==i)return r.after=e.lastIndex,this.matchData=r}else if("string"==typeof e)return t.substr(this.point(),e.length)==e}looking_back(e){var t=this.getCode();if(e instanceof RegExp){var i=this.lastIndexOfRegexp(t,e,this.point());if(i&&i.after==this.point())return i}else if("string"==typeof e)return t.substr(this.point()-e.length,e.length)==e}capitalize(e){return e.replace(this.getq("syntax_capitalize_word"),(e,t,i)=>t.toUpperCase()+i.toLowerCase())}}R.prototype.COMMANDS=R.COMMANDS,R.prototype.newCommands=R.newCommands,R.prototype.replaceCommands=R.replaceCommands,R.prototype.newMode=R.newMode,R.prototype.addModeHook=R.addModeHook,R.prototype.removeModeHook=R.removeModeHook,R.setq=R.setGlobal=R.prototype.setGlobal=R.setVariable,R.prototype.setq=R.prototype.setVariable,R.prototype.getq=R.prototype.getVariable,R.getq=R.getVariable;class F extends R{constructor(...e){super(...e),this.promptMarker=this.createMarker(0,!0,"prompt"),this.setq("minibuffer_validation",e=>!0)}prompt(e){e=e.trim()+" ",this._disableUndo(()=>{let t=this.promptMarker.getPosition();this.promptMarker.setPosition(0,!0,!0),this._replaceText(0,t,e),this.promptMarker.setPosition(e.length,!0,!0),this._textProperties.spliceLineProps(0,0,e.length-t),this._textProperties.addLineProps(0,0,e.length-1,"css","minibuffer-prompt")})}_boundPosition(e){return Math.max(N(this.promptMarker),Math.min(e,this.getCodeSize()))}}let q=Symbol("MENU");class z extends l{static options={};constructor(...e){super(...e),this._cont=r.fromHTML('<div class="Ymacs_Menu"></div>'),this.getElement().appendChild(this._cont)}getContentElement(){return this._cont}initClassName(){return"Ymacs_Popup"}}var B=g.define(null,{"ArrowDown && C-n":$,"ArrowUp && C-p":D,PageDown:$,PageUp:D,"C-End && M->":function(){this[q],K(this,-1)},"C-Home && M-<":function(){this[q],K(this,0)},Enter:H,Escape:function(){this[q].kill()}});function D(){K(this,this[q].selectedIndex-1)}function $(){K(this,this[q].selectedIndex+1)}function H(){let e=this[q];!1!==e.onSelect(e.selectedIndex)&&e.kill()}function K(e,t){let i=e[q],s=[...i.widget.getContentElement().querySelectorAll(".Ymacs_Menu_Item")],n=s.length;t=i.selectedIndex=(t%n+n)%n,s.forEach(e=>{let s=e.dataset.index==t;s&&(i.selectedItem=e),r.condClass(e,s,"selected")}),i.selectedItem.scrollIntoView({block:"nearest"})}B.defaultHandler=[function(){return this[q].kill(),!1}],R.newCommands({popup_menu:function(e){e.buffer=this,function({buffer:e,items:t,onSelect:i}={}){let s=new z;s.addClass("with-arrow"),t.forEach((e,t)=>{let i=e;"string"!=typeof e&&(i=e.value,e=e.label);let n=r.fromHTML(`<div class="Ymacs_Menu_Item" data-value="${r.htmlEscape(i)}"
                                          data-index="${t}">${r.htmlEscape(e)}</div>`);s.add(n)}),e[q]={items:t,widget:s,onSelect:i,kill(){s.destroy(),e[q]=null}};let n=document.activeElement,o=e.ymacs;r.on(s.getContentElement(),{click:t=>{n.focus();let i=t.target;r.hasClass(i,"Ymacs_Menu_Item")&&(K(e,+i.dataset.index),H.call(e))}}),o._popupAtCaret(s.getElement()),K(e,0),e.pushKeymap(B),s.addEventListener("onDestroy",()=>{e.popKeymap(B)})}(e)}});var U=0,j=null;function Y(){U=null}var W=r.fromHTML('<div class="line"><br/></div>'),V=0;class Q extends l{static options={buffer:null,ymacs:null,isMinibuffer:!1,point:null};constructor(...e){super(...e),this.buffer=this.o.buffer,this.ymacs=this.o.ymacs,this.isMinibuffer=this.o.isMinibuffer,this.id=`ymacs-frame-${++V}`,this.__caretId=`ymacs-caret-${V}`,this.redrawModelineWithTimer=c(this.redrawModeline.bind(this)),this.getElement().tabIndex=0,this.getElement().innerHTML="<div class='Ymacs-frame-overlays'><div class='Ymacs-frame-content'></div></div><div class='Ymacs_Modeline'></div>",this.addEventListener({onDestroy:this._on_destroy}),this._dragSelectHandlers={mousemove:this._dragSelect_onMouseMove.bind(this),mouseup:this._dragSelect_onMouseUp.bind(this)},this._bufferEvents={onLineChange:this._on_bufferLineChange.bind(this),onInsertLine:this._on_bufferInsertLine.bind(this),onDeleteLine:this._on_bufferDeleteLine.bind(this),onPointChange:this._on_bufferPointChange.bind(this),onResetCode:this._on_bufferResetCode.bind(this),onOverwriteMode:this._on_bufferOverwriteMode.bind(this),onModelineChange:this._on_bufferModelineChange.bind(this),beforeInteractiveCommand:this._on_bufferBeforeInteractiveCommand.bind(this),afterInteractiveCommand:this._on_bufferAfterInteractiveCommand.bind(this),onOverlayChange:this._on_bufferOverlayChange.bind(this),onOverlayDelete:this._on_bufferOverlayDelete.bind(this)},this._moreBufferEvents={onMessage:this._on_bufferMessage.bind(this),afterInteractiveCommand:(function(){this.__ensureCaretVisible&&this.ensureCaretVisible()}).bind(this)};var t=this.buffer;this.buffer=null,t&&this.setBuffer(t,this.o.point),r.on(this.getOverlaysContainer(),"scroll",this._on_scroll.bind(this)),r.on(this.getElement(),{mousedown:this._dragSelect_onMouseDown.bind(this),focus:this._on_focus.bind(this),blur:this._on_blur.bind(this),keydown:this._on_keyDown.bind(this),keyup:this._on_keyUp.bind(this),wheel:this._on_mouseWheel.bind(this)})}initClassName(){return`Ymacs_Frame${this.o.isMinibuffer?" Ymacs_Minibuffer":""}`}focus(e){this.getElement().focus()}blur(e){}getOverlaysContainer(){return this.getElement().firstChild}getModelineElement(){return this.getElement().childNodes[1]}getContentElement(){return this.getElement().firstChild.firstChild}getCaretElement(){return document.getElementById(this.__caretId)}getLineDivElement(e){return this.getContentElement().childNodes[e]||null}ensureCaretVisible(){let e=this.getOverlaysContainer(),t=e.scrollTop;this.redrawCaret();let i=this.getCaretElement();return i&&(i.scrollIntoView({block:"nearest",inline:"nearest"}),i.offsetLeft<e.clientWidth/2&&(e.scrollLeft=0)),t!=e.scrollTop}focusInside(){return document.activeElement===this.getElement()}setBuffer(e,t){e!==this.buffer&&(this.buffer&&(this.caretMarker&&!this.o.isMinibuffer&&(this.caretMarker.destroy(),this.caretMarker=null),this.buffer.removeEventListener(this._bufferEvents),this.buffer.removeEventListener(this._moreBufferEvents)),this.buffer=e,e&&(e.addEventListener(this._bufferEvents),this.focusInside()&&e.addEventListener(this._moreBufferEvents),this.o.isMinibuffer?this.caretMarker=e.caretMarker:this.caretMarker=e.createMarker(t??+e.caretMarker,!1,"framecaret"),this._redrawBuffer(),this.redrawCaret(!0),this.centerOnCaret()))}recenterTopBottom(e=1){let t=this.buffer._rowcol.row,i=this.getLineDivElement(t),r=this.getOverlaysContainer(),s=Math.round(i.offsetTop-r.clientHeight/2+i.offsetHeight/2),n=Math.round(i.offsetTop),o=Math.round(i.offsetTop-r.clientHeight+i.offsetHeight);0==e?r.scrollTop=s:1==e?r.scrollTop=n:r.scrollTop=o}centerOnCaret(){this.centerOnLine(this.buffer._rowcol.row)}centerOnLine(e){var t=this.getLineDivElement(e),i=this.getOverlaysContainer();i.scrollTop=Math.round(t.offsetTop-i.clientHeight/2+t.offsetHeight/2)}setModelineContent(e){this.getModelineElement().innerHTML=e}deleteOtherFrames(){this.ymacs.keepOnlyFrame(this)}deleteFrame(){this.ymacs.deleteFrame(this)}_split(e){let t=this.getOverlaysContainer(),i=t.scrollTop,r=this.ymacs.createFrame({buffer:this.buffer}),s=new G({horiz:e});return this.getElement().replaceWith(s.getElement()),s.setSplit(this,r),t.scrollTop=i,r.getOverlaysContainer().scrollTop=i,this.focus(),r}vsplit(){return this._split(!0)}hsplit(e){return this._split(!1)}__showCaret(){r.addClass(this.getCaretElement(),"Ymacs-caret")}redrawCaret(e){this.o.isMinibuffer&&(e=!0);var t=this.ymacs.getActiveFrame()===this;if(e||t){t&&!this.o.isMinibuffer&&this.focusInside()&&this.caretMarker.setPosition(this.buffer.caretMarker.getPosition());var i=this.buffer._rowcol;[...this.getElement().querySelectorAll(".Ymacs-caret, #"+this.__caretId)].forEach(e=>{e.id="",e.className=""}),null!=this.__prevCaretLine&&this._on_bufferLineChange(this.__prevCaretLine),this.__prevCaretLine!=i.row&&(this.__prevCaretLine=i.row,this._on_bufferLineChange(i.row)),this.callHooks("onPointChange",i.row,i.col),this.redrawModelineWithTimer(i)}}_getLineHTML(e){var t=this.buffer.formatLineHTML(e,this.caretMarker),i=t.indexOf("Ymacs-caret'>");return i>=0&&(t=t.substr(0,i+12)+" id='"+this.__caretId+"'"+t.substr(i+12)),t}_redrawBuffer(){this.setContent(this.buffer.code.map((e,t)=>`<div class="line">${this._getLineHTML(t)}</div>`).join(""))}coordinatesToRowCol(e,t){var i=this,r=function e(r,s){if(r>=s)return r;var n=Math.floor((r+s)/2),o=i.getLineDivElement(n),a=o.offsetTop;return a+o.offsetHeight<t?e(n+1,s):t<a?e(r,n-1):n}(0,this.buffer.code.length-1),s=function t(s,n){if(s>=n)return s;var o=Math.floor((s+n)/2),a=i.coordinates(r,o);return i.coordinates(r,o+1).x<e?t(o+1,n):e<a.x?t(s,o-1):o}(0,this.buffer.code[r].length);return{row:r,col:s}}coordinates(e,t){var i=this.getContentElement().getBoundingClientRect(),r=this.getLineDivElement(e);return{x:function(e,t){let i=document.createRange();i.selectNodeContents(e);let r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),s=0;for(;r.nextNode();){let e=r.currentNode,n=e.nodeValue.length;if(s+n>=t){i.setStart(e,t-s),i.setEnd(e,t-s);break}s+=n}return i.getBoundingClientRect().right}(r,t)-i.left,y:r.offsetTop,h:r.offsetHeight}}heightInLines(){return Math.floor(this.getOverlaysContainer().clientHeight/this.getContentElement().firstChild.offsetHeight)}redrawModeline(e){e||(e=this.caretMarker.getRowCol());var t=this.buffer.code.length-1,i=this.firstLineVisible(),r=this.lastLineVisible(),s=0==i?"Top":r==t?"Bot":Math.round(r/t*100)+"%";this.setModelineContent(this.buffer.renderModelineContent(e,s))}_on_bufferLineChange(e){var t=this.getLineDivElement(e);t&&(t.innerHTML=this._getLineHTML(e))}_on_bufferInsertLine(e,t){var i=W.cloneNode(!0);this.getContentElement().insertBefore(i,this.getLineDivElement(e)),t&&(i.innerHTML=this._getLineHTML(e))}_on_bufferDeleteLine(e){r.trash(this.getLineDivElement(e))}_on_bufferPointChange(e,t){this.redrawCaret()}_on_bufferResetCode(){this._redrawBuffer()}_on_bufferOverwriteMode(e){this.condClass(e,"Ymacs-overwrite-mode")}_on_bufferMessage(e){this.ymacs.popupMessage(e)}_on_bufferBeforeInteractiveCommand(){this.__ensureCaretVisible=!0,this.ymacs.clearPopupMessage()}_on_bufferAfterInteractiveCommand(){}_on_bufferModelineChange(){this.redrawModelineWithTimer(null)}getOverlayId(e){return this.id+"-ovl-"+e}getOverlayHTML(e,t){var i="";return t.forEach(t=>{if(t.line1!=t.line2||t.col1!=t.col2){t=(r=t).line1>r.line2||r.line1==r.line2&&r.col1>r.col2?{line1:r.line2,col1:r.col2,line2:r.line1,col2:r.col1}:r;var r,s=this.coordinates(t.line1,t.col1),n=this.coordinates(t.line2,t.col2),o=0==t.col1?s:this.coordinates(t.line1,0);t.line1==t.line2?i+=`<div class="${e}" style="
                    top: ${s.y}px;
                    left: ${s.x}px;
                    height: ${s.h}px;
                    width: ${n.x-s.x}px;
                "></div>`:(i+=`<div class="${e}" style="
                    top: ${s.y}px;
                    left: ${s.x}px;
                    height: ${t.col1>0?s.h:n.y-s.y}px;
                "></div>`,t.col1>0&&t.line2-t.line1>1&&(i+=`<div class="${e}" style="
                        top: ${s.y+s.h}px;
                        left: ${o.x}px;
                        height: ${n.y-s.y-s.h}px;
                    "></div>`),t.col2>0&&(i+=`<div class="${e}" style="
                        top: ${n.y}px;
                        left: ${o.x}px;
                        height: ${n.h}px;
                        width: ${n.x-o.x}px;
                    "></div>`))}}),i?`<div id="${this.getOverlayId(e)}" data-ymacs-overlay="${e}" class="Ymacs_Overlay ${e}">${i}</div>`:null}getOverlaysCount(){return this.getOverlaysContainer().childNodes.length-1}_on_bufferOverlayChange(e,t){let i=this.getOverlayHTML(e,Array.isArray(t)?t:[t]);if(i){let t=r.fromHTML(i),s=document.getElementById(this.getOverlayId(e));s?s.replaceWith(t):this.getOverlaysContainer().appendChild(t),this._setOverlayClasses()}else this._on_bufferOverlayDelete(e)}_on_bufferOverlayDelete(e){r.trash(document.getElementById(this.getOverlayId(e))),this._setOverlayClasses()}_setOverlayClasses(){let e=[...this.getOverlaysContainer().querySelectorAll(":scope > [data-ymacs-overlay]")].map(e=>e.dataset.ymacsOverlay);this.condClass(e.length>0,"Ymacs_Frame-hasOverlays"),this.getElement().dataset.ymacsOverlays=e.join(" ")}_on_destroy(){this.setBuffer(null)}_on_focus(){this.ymacs.setActiveFrame(this,!0),this.o.isMinibuffer||this.buffer.cmd("goto_char",this.caretMarker.getPosition()),this.buffer.addEventListener(this._moreBufferEvents)}_on_blur(){this.o.isMinibuffer||this.caretMarker.setPosition(this.buffer.caretMarker.getPosition()),this.buffer.removeEventListener(this._moreBufferEvents)}_dragSelect_onMouseDown(e){if(e.ctrlKey&&e.shiftKey)return;if(0!=e.button)return void setTimeout(()=>this.focus());this.focus(),e.stopPropagation(),e.preventDefault(),clearTimeout(j),U++,j=setTimeout(Y,300);let t=r.mousePos(e,this.getContentElement()),i=this.coordinatesToRowCol(t.x,t.y),s=this.buffer;setTimeout(()=>{s.clearTransientMark(),s.cmd("goto_char",s._rowColToPosition(i.row,i.col)),s.callInteractively("keyboard_quit"),1==U?(s.ensureTransientMark(),r.on(window,this._dragSelectHandlers)):2==U?(s.cmd("forward_word"),s.cmd("backward_word"),s.cmd("forward_word_mark")):3==U?(s.cmd("beginning_of_line"),s.cmd("end_of_line_mark")):4==U&&(s.cmd("backward_paragraph"),s.cmd("forward_whitespace"),s.cmd("beginning_of_line"),s.cmd("forward_paragraph_mark"))})}_dragSelect_onMouseMove(e){let t=r.mousePos(e,this.getContentElement()),i=this.coordinatesToRowCol(t.x,t.y);this.buffer.cmd("goto_char",this.buffer._rowColToPosition(i.row,i.col)),this.buffer.ensureTransientMark(),this.ensureCaretVisible()}_dragSelect_onMouseUp(e){r.off(window,this._dragSelectHandlers)}_on_keyDown(e){var t;t=e.key,!/^(?:Alt|AltGraph|CapsLock|Control|Fn|FnLock|Hyper|Meta|NumLock|ScrollLock|Shift|Super|Symbol|SymbolLock)$/.test(t)&&this.ymacs.processKeyEvent(e)&&(e.preventDefault(),e.stopPropagation())}_on_keyUp(e){}_on_scroll(){this.redrawModelineWithTimer()}_on_mouseWheel(e){e.preventDefault(),this.buffer._handleKeyEvent(e)}firstLineVisible(){var e=this.getOverlaysContainer();return this.coordinatesToRowCol(1,e.scrollTop+1).row}lastLineVisible(){var e=this.getOverlaysContainer();return this.coordinatesToRowCol(e.clientWidth-2,e.scrollTop+e.clientHeight-2).row}scrollUp(e){var t=this.getOverlaysContainer(),i=Math.max(this.firstLineVisible()-e,0);t.scrollTop=(i=this.getLineDivElement(i)).offsetTop,this.__ensureCaretVisible=!1}scrollDown(e){var t=this.getOverlaysContainer(),i=Math.min(this.firstLineVisible()+e,this.buffer.code.length-1);t.scrollTop=(i=this.getLineDivElement(i)).offsetTop,this.__ensureCaretVisible=!1}}class G extends l{static options={horiz:!1};#i=null;initClassName(){return"Ymacs_SplitCont "+(this.o.horiz?"horiz":"vert")}createElement(){super.createElement(),this._dragHandlers={mousemove:this._onMouseMove.bind(this),mouseup:this._onMouseUp.bind(this)},this._rb=r.fromHTML('<div class="bar" tabindex="0"></div>'),r.on(this._rb,"mousedown",this._onMouseDown.bind(this))}setSplit(e,t,i){if(this.add(e),this.add(this._rb),this.add(t),null!=i){let e=this.getElement();this.o.horiz?e.style.gridTemplateRows=`${i}fr auto ${1-i}fr`:e.style.gridTemplateColumns=`${i}fr auto ${1-i}fr`}}_onMouseDown(e){if(this.#i=document.activeElement,e.target===this._rb){let t=this.getContentElement().children[0];this._start=this.o.horiz?e.clientY:e.clientX,this._orig_sz=this.o.horiz?t.offsetHeight:t.offsetWidth,this.addClass("dragging"),e.stopPropagation(),r.on(window,this._dragHandlers),r.overlayOn(this.o.horiz?"Ymacs_Resize_horiz":"Ymacs_Resize_vert")}else this.#i&&this.#i.focus()}_onMouseUp(e){r.off(window,this._dragHandlers),this.delClass("dragging"),r.overlayOff(),this.#i&&this.#i.focus(),this.#i=null}_onMouseMove(e){let t=this.getElement(),i=this.o.horiz?t.offsetHeight:t.offsetWidth,r=(this.o.horiz?e.clientY:e.clientX)-this._start,s=Math.min(.9,Math.max(.1,Math.min(i,Math.max(0,this._orig_sz+r))/i));this.o.horiz?t.style.gridTemplateRows=`${s}fr auto ${1-s}fr`:t.style.gridTemplateColumns=`${s}fr auto ${1-s}fr`}}function X(e,t,i,r){if(0==e.length)return null;for(var s,n=0,o=e[0],a=t.call(i,o),l=0;++n<e.length;)(s=t.call(i,e[n]))<a&&(a=s,l=n,o=e[n]);return r&&e.splice(l,1),o}function J(e,t){if(e.length>0){for(var i=e.at(-1).getBox().left,r=[e.pop()];e.length>0&&e.at(-1).getBox().left==i;)r.push(e.pop());return X(r,function(e){return Math.abs(t.top-e.getBox().top-e.getBox().height/2)})}}function Z(e,t){if(e.length>0){for(var i=e.at(-1).getBox().top,r=[e.pop()];e.length>0&&e.at(-1).getBox().top==i;)r.push(e.pop());return X(r,function(e){return Math.abs(t.left-e.getBox().left-e.getBox().width/2)})}}class ee extends l{static options={buffers:[],frames:[],cf_frameStyle:Object.create(null),ls_keyName:".ymacs"};constructor(...e){super(...e),this.buffers=[...this.o.buffers],this.frames=[...this.o.frames],this.registers=Object.create(null),this.cf_frameStyle={...this.o.cf_frameStyle},this.buffers.forEach(e=>{e.ymacs=this,this._addBufferListeners(e)}),this.killRing=[],this.killMasterOfRings=[],this.__macro_recording=null,this.__macro_finished=null,this.__error_thrown=!1,this.__running_macro=null,this.__macro_times=0,this.__macro_step=0,this.__macro_timer=null,this.__input_frame=null,this.minibuffer=new F({ymacs:this}),this.minibuffer.cmd("minibuffer_mode"),this.minibuffer_frame=this.createFrame({isMinibuffer:!0,buffer:this.minibuffer,hidden:!0}),0==this.buffers.length&&this.createBuffer();var t=this.createFrame({buffer:this.buffers[0]});this.add(t),this.add(this.minibuffer_frame),this.setActiveFrame(t),t.redrawCaret()}initClassName(){return"Ymacs Ymacs-cursor-block"}_addBufferListeners(e){e.addEventListener("onDestroy",()=>{var t=this.getActiveFrame();this.getBufferFrames(e).forEach(e=>{e!==t&&this.deleteFrame(e)}),h(this.buffers,e),this.getActiveBuffer()===e&&this.nextHiddenBuffer(e)})}pushToKillRing(e,t){t?this.killRing.unshift(e):this.killRing.push(e)}killRingToMaster(){this.killRing.length&&(0==this.killMasterOfRings.length||this.killMasterOfRings.at(-1).join("")!=this.killRing.join(""))&&this.killMasterOfRings.push(this.killRing),this.killRing=[]}killRingText(){return this.killRing.join("")}rotateKillRing(e){e?(this.killMasterOfRings.push(this.killRing),this.killRing=this.killMasterOfRings.shift()):(this.killMasterOfRings.unshift(this.killRing),this.killRing=this.killMasterOfRings.pop())}getBuffer(e){return e instanceof R||(e=this.buffers.find(t=>t.name==e)),e}killBuffer(e){e=this.getBuffer(e),this.callHooks("onDeleteBuffer",e),e.destroy()}renameBuffer(e,t){(e=this.getBuffer(e)).name=t,e.callHooks("onModelineChange")}_do_switchToBuffer(e){this.getActiveFrame().setBuffer(e),this.callHooks("onBufferSwitch",e)}switchToBuffer(e){var t=this.getBuffer(e),i=this.buffers;return t||(t=this.createBuffer({name:e})),h(i,t),i.unshift(t),this._do_switchToBuffer(t),t}nextHiddenBuffer(e){var t=this.buffers.filter(t=>{if(t===e)return!1;var i=!0;return t.forAllFrames(()=>i=!1),i});if(t.length>0){var i=t[0];h(this.buffers,i),this.buffers.push(i),this._do_switchToBuffer(i)}else this.switchToBuffer("*scratch*")}switchToNextBuffer(){var e=this.buffers;if(e.length>1){var t=e.shift();e.push(t),this._do_switchToBuffer(e[0])}}switchToPreviousBuffer(){var e=this.buffers;if(e.length>1){var t=e.pop();e.unshift(t),this._do_switchToBuffer(t)}}getNextBuffer(e,t){null==t&&(t=1);var i=this.buffers;return i[(i.indexOf(e)+t)%i.length]}getPrevBuffer(e,t){return null==t&&(t=1),this.getNextBuffer(e,-t)}getBufferFrames(e){return e=this.getBuffer(e),this.frames.filter(t=>t.buffer===e)}createBuffer(e={}){var t=new R({...e,ymacs:this});return this._addBufferListeners(t),e.hidden||this.buffers.push(t),this.callHooks("onCreateBuffer",t),t}createFrame(e={}){var t=new Q({...e,ymacs:this});return e.hidden||this.frames.unshift(t),t.setStyle(this.cf_frameStyle),t}setFrameStyle(e){[this.minibuffer_frame,...this.frames].forEach(t=>t.setStyle(e))}keepOnlyFrame(e){if(this.frames.length>1){let t=e.getElement();for(;t.parentNode!=this.getContentElement();)t=t.parentNode;t!==e&&(t.replaceWith(e.getElement()),this.setActiveFrame(e),e.centerOnCaret(),this.frames=[e])}}deleteFrame(e){if(this.frames.length>1){h(this.frames,e);let t=e.getElement().parentNode,i=[...t.children].find(t=>{let i=t._ymacs_object;return i instanceof G||i instanceof Q&&i!==e});t.replaceWith(i),r.hasClass(i,"Ymacs_Frame")||(i=i.querySelector(".Ymacs_Frame")),i=i._ymacs_object,this.setActiveFrame(i),i.centerOnCaret()}}focusOtherFrame(){this.setActiveFrame(this.frames[0])}getMainElement(){return this.getElement().querySelector(":scope > .Ymacs_Frame:not(.Ymacs_Minibuffer), :scope > .Ymacs_SplitCont")}getFrameConfig(){let e=t=>{if(r.hasClass(t,"Ymacs_Frame")){let e=t._ymacs_object,i=e.getOverlaysContainer();return{buffer:e.buffer.name,point:+e.caretMarker,scroll:i.scrollTop/i.scrollHeight,active:e===this.getActiveFrame()}}{let i=t._ymacs_object.o.horiz,r=window.getComputedStyle(t),s=/^\s*(\d*(?:\.\d+)?)px\s+(?:\d*(?:\.\d+)?)px\s+(\d*(?:\.\d+)?)px\s*$/.exec(i?r.gridTemplateRows:r.gridTemplateColumns);return[i,+s[1]/(+s[1]+ +s[2]),e(t.children[0]),e(t.children[2])]}};return e(this.getMainElement())}setFrameConfig(e){this.getMainElement()?.remove();let t=[],i=[...this.frames];!function e(r){if(Array.isArray(r))e(r[2]),e(r[3]);else for(let e=i.length;--e>=0;)if(i[e].buffer?.name==r.buffer){t.push([r.buffer,i[e]]),i.splice(e,1);break}}(e);let r=e=>this.getBuffer(e)||this.createBuffer({name:e}),s=(e,s)=>{let n=t.findIndex(([t])=>t==e);if(n<0)if(!(i.length>0))return this.createFrame({buffer:r(e),point:s});else{let t=i.pop();return t.setBuffer(r(e,s)),t}{let e=t[n][1];return t.splice(n,1),e}},n=[],o=null,a=function e(t){if(Array.isArray(t)){let i=new G({horiz:t[0]}),r=e(t[2]),s=e(t[3]);return n.push(()=>i.setSplit(r,s,t[1])),i}{let e=s(t.buffer,t.point);return t.active&&(o=e),n.push(()=>{let i=e.getOverlaysContainer();i.scrollTop=t.scroll*i.scrollHeight}),e}}(e);i.forEach(e=>{h(this.frames,e),e.destroy()});let l=this.getElement();l.insertBefore(a.getElement(),l.firstElementChild),n.reverse().forEach(e=>e()),this.setActiveFrame(o||this.frames[0])}focus(){this.frames.at(-1).focus()}setInputFrame(e){this.__input_frame=e}setActiveFrame(e,t){if(!e.isMinibuffer){var i=this.getActiveFrame();i&&i.delClass("Ymacs_Frame-active"),h(this.frames,e),this.frames.push(e),e.addClass("Ymacs_Frame-active")}this.__input_frame=e,t||e.focus()}getActiveFrame(){return this.frames.at(-1)}getActiveBuffer(){var e=this.getActiveFrame();return e?e.buffer:this.buffers.at(-1)}setColorTheme(e){this.delClass(/Ymacs-Theme-[^\s]*/g),e instanceof Array||(e=[e]),e.forEach(e=>{this.addClass("Ymacs-Theme-"+e)})}cursorBar(){this.delClass("Ymacs-cursor-block"),this.addClass("Ymacs-cursor-bar")}cursorBlock(){this.delClass("Ymacs-cursor-bar"),this.addClass("Ymacs-cursor-block")}toggleBarCursor(){this.hasClass("Ymacs-cursor-block")?this.cursorBar():this.cursorBlock()}getFrameInDirection(e){let t=this.getActiveFrame(),i=t.getCaretElement().getBoundingClientRect();var r=[...this.frames].sort((e,t)=>e.getBox().left-t.getBox().left),s=[...this.frames].sort((e,t)=>e.getBox().top-t.getBox().top);switch(e){case"left":return this._get_frameInDir_left(r,s,i,t);case"right":return this._get_frameInDir_right(r,s,i,t);case"up":return this._get_frameInDir_up(r,s,i,t);case"down":return this._get_frameInDir_down(r,s,i,t)}return this["_get_frameInDir_"+e](r,s,i,t)}_get_frameInDir_left(e,t,i,r){return J(e=e.filter(e=>{let t=e.getBox();return e!==r&&t.left<i.left&&t.top-i.height<=i.top&&t.top+t.height>i.top}),i)}_get_frameInDir_right(e,t,i,r){return e.reverse(),J(e=e.filter(e=>{let t=e.getBox();return e!==r&&t.left>i.left&&t.top-i.height<=i.top&&t.top+t.height>i.top}),i)}_get_frameInDir_up(e,t,i,r){return Z(t=t.filter(e=>{let t=e.getBox();return e!==r&&t.top<i.top&&t.left-i.width<=i.left&&t.left+t.width>i.left}),i)}_get_frameInDir_down(e,t,i,r){return t.reverse(),Z(t=t.filter(e=>{let t=e.getBox();return e!==r&&t.top>i.top&&t.left-i.width<=i.left&&t.left+t.width>i.left}),i)}ls_get(){return this.ls_store||(this.ls_store=JSON.parse(localStorage.getItem(this.o.ls_keyName)||"{}"))}ls_set(e){this.ls_store=e,localStorage.setItem(this.o.ls_keyName,JSON.stringify(e))}ls_getFileContents(e,t){var i,r=this.ls_getFileDirectory(e),s=r.other;if(1==s.length&&(i=r.dir[s[0]]),null==i&&!t)throw new b("File not found");return i}ls_setFileContents(e,t){var i=this.ls_getFileDirectory(e,"file");i.dir[i.other[0]]=t,this.ls_set(i.store)}ls_getFileDirectory(e,t){var i,r=i=this.ls_get(),s=[];e=e.replace(/^[~\x2f]+/,"").split(/\x2f+/);for(var n=[],o=[];e.length>0;){var a=e.shift();"."!=a&&(".."==a?(n.pop(),r=s.pop()):"~"==a?(n=[],o=[],s=[],r=i):Object.hasOwn(r,a)&&"string"!=typeof r[a]?(s.push(r),r=r[a],n.push(a)):o.push(a))}if(t){for(var l=+("file"==t);o.length>l;)r=r[o.shift()]={};this.ls_set(i)}return{store:i,dir:r,path:n,other:o,full:n.concat(o).join("/")}}ls_deleteFile(e){var t=this.ls_getFileDirectory(e);delete t.dir[t.other.join("/")],this.ls_set(t.store)}fs_normalizePath(e){e=e.replace(/^[~\x2f]+/,"").split(/\x2f+/);for(var t=[];e.length>0;){var i=e.shift();"."!=i&&(".."==i?t.pop():"~"==i?t=[]:t.push(i))}return t.join("/")}fs_fileType(e,t){let{other:i,dir:r}=this.ls_getFileDirectory(e);return i.length>0?t(i[0]?"string"==typeof r[i[0]]?"file":"new":"directory"):t("directory")}fs_getFileContents(e,t,i){var r=this.ls_getFileContents(e,t);i(r,r)}fs_setFileContents(e,t,i,r){i&&(this.ls_getFileContents(e,!0)||"")!=i?r(null):(this.ls_setFileContents(e,t),r(t))}fs_sortDirectoryEntries(e){return Object.keys(e).sort((t,i)=>{t=t.toLowerCase(),i=i.toLowerCase();let r="string"!=typeof e[t],s="string"!=typeof e[i];if(r&&!s)return -1;if(s&&!r)return 1;if(!r&&!s){let e=this.fs_isObjectFileName(t),r=this.fs_isObjectFileName(i);if(e&&!r)return 1;if(r&&!e)return -1}return t<i?-1:+(t>i)})}fs_isObjectFileName(e){return/\.fasl$/i.test(e)}fs_getDirectory(e,t){var i=this.ls_getFileDirectory(e,!1);if(e=i.path.join("/"),i){var r={};for(let t of this.fs_sortDirectoryEntries(i.dir))r[t]={name:t,path:e+"/"+t,type:"string"==typeof i.dir[t]?"file":"directory"};t(r)}else t(null)}fs_deleteFile(e,t){this.ls_deleteFile(e),t()}fs_remapDir(e,t){t(e)}isRunningMacro(){return!!this.__running_macro}isRecordingMacro(){return!!this.__macro_recording}indicateError(){this.__error_thrown=!0}startMacro(e){return!this.isRecordingMacro()&&(e?(this.__macro_recording=this.__macro_finished||[],this.__macro_finished=null):this.__macro_recording=[],!0)}stopMacro(){this.__macro_recording&&(this.__macro_finished=this.__macro_recording,this.__macro_recording=null)}getLastMacro(){return this.__macro_finished}stepMacro(){for(;;){if(this.__macro_step>=this.__running_macro.length&&(this.__macro_times--,this.__macro_step=0),0==this.__macro_times||this.__error_thrown){this.__macro_times=0,this.__macro_step=0,this.__running_macro=null;return}var e=this.__running_macro[this.__macro_step];this.processKeyEvent(e),this.__macro_step++}}runMacro(e,t){if(this.isRecordingMacro())return!1;this.__error_thrown=!1,this.__running_macro=t,this.__macro_step=0,this.__macro_times=e;var i=this;return setTimeout(function(){i.stepMacro()},0),!0}processKeyEvent(e){var t=this.__input_frame.buffer;return this.__macro_recording&&this.__macro_recording.push(e),t._handleKeyEvent(e)}#r=null;popupMessage({type:e="info",text:t,isHtml:i=!1,atCaret:s=!1,timeout:n}){let o=this.__popup||(this.__popup=new z),a=o.getElement();o.condClass(s,"with-arrow"),s||(a.style.removeProperty("left"),a.style.removeProperty("top"),a.style.removeProperty("bottom"),a.style.removeProperty("right"),a.style.removeProperty("transform")),i||(t=r.htmlEscape(t)),o.setContent(t),s?this._popupAtCaret(o.getElement()):this.add(o),clearTimeout(this.#r),n&&(this.#r=setTimeout(this.clearPopupMessage.bind(this),n))}clearPopupMessage(){this.__popup&&this.__popup.getElement().remove()}requestFullScreen(){return this.getElement().requestFullscreen()}_popupAtCaret(e){e.style.visibility="hidden",r.delClass(e,/ppos-[a-z-]+/ig),this.add(e);let t=this.getElement().getBoundingClientRect(),i=this.__input_frame.getCaretElement().getBoundingClientRect(),s={x:(i.left+i.right)/2,y:(i.top+i.bottom)/2},n={x:(t.left+t.right)/2,y:(t.top+t.bottom)/2};s.y>n.y?s.x<n.x?(r.addClass(e,"ppos-top-right"),e.style.transform=`translate(0, calc(-100% - ${i.height/2}px))`):(r.addClass(e,"ppos-top-left"),e.style.transform=`translate(-100%, calc(-100% - ${i.height/2}px))`):s.x<n.x?(r.addClass(e,"ppos-bot-right"),e.style.transform=`translate(0, ${i.height/2}px)`):(r.addClass(e,"ppos-bot-left"),e.style.transform=`translate(-100%, ${i.height/2}px)`),e.style.left=s.x-t.left+"px",e.style.top=s.y-t.top+"px",e.style.removeProperty("visibility")}jumpToRegister(e){let t=this.registers[e];return null!=t&&(t.frames?(this.setFrameConfig(t.frames),!0):void 0)}makeDialog(e){let t=new ei({...e,ymacs:this});return this.add(t),t}}function et(e){return"number"==typeof e&&(e<=1&&e>0?e=100*e+"%":e+="px"),e}class ei extends l{static options={draggable:!1,resizable:!1,closable:!1,content:null,centered:!1,width:"40%",height:"50%",ymacs:null};constructor(...e){super(...e),this.ymacs=this.o.ymacs;let t=this.getElement(),i=this.o.content;if("function"==typeof i&&(i=i.call(this,t,this)),i&&t.appendChild(i),this.o.resizable&&(t.style.resize="both"),this.o.width&&(t.style.width=et(this.o.width)),this.o.height&&(t.style.height=et(this.o.height)),this.o.closable){if(!0===this.o.closable){let e=r.fromHTML('<div class="close-button"></div>');t.appendChild(e),this.o.closable=e}r.on(this.o.closable,{mousedown:e=>e.stopPropagation(),click:this._closeClick.bind(this)})}this.o.draggable&&(!0===this.o.draggable&&(this.o.draggable=t),this._dragHandlers={mousemove:this._dragMouseMove.bind(this),mouseup:this._dragMouseUp.bind(this)},r.on(this.o.draggable,"mousedown",this._dragMouseDown.bind(this)))}initClassName(){let e=["Ymacs_Dialog"];return this.o.centered&&e.push("centered"),e.join(" ")}close(){this.getElement().remove(),this.destroy(),this.ymacs.focus(),this.callHooks("onClose")}_closeClick(e){e.stopPropagation(),this.close()}_dragMouseDown(e){e.stopPropagation();let t=this.getElement();this._dragging={orig:r.relPos(t),start:r.mousePos(e,t.offsetParent),focus:document.activeElement},r.on(window,this._dragHandlers),r.overlayOn("Ymacs_Resize_move")}_dragMouseMove(e){let t=this.getElement(),i=r.mousePos(e,t.offsetParent),s=this._dragging,n=i.x-s.start.x,o=i.y-s.start.y;t.style.removeProperty("bottom"),t.style.removeProperty("right"),t.style.left=s.orig.x+n+"px",t.style.top=s.orig.y+o+"px"}_dragMouseUp(e){r.off(window,this._dragHandlers),r.overlayOff(),this._dragging.focus?.focus(),this._dragging=null}}class er{constructor({buffer:e=null,line:t=0,col:i=0}={}){this.buffer=e,this.line=t,this.col=i}nextLine(){return++this.line,this.col=0,this.line<this.buffer.code.length}prevLine(){return--this.line,this.col=0,this.line>=0}peek(e=0){if(this.line<this.buffer.code.length){let t=this.col+e,i=this.buffer.code[this.line];if(t<i.length)return i.charAt(t);if(t==i.length)return"\n"}}lineText(e=this.line){return this.buffer.code[e]}lineIndentation(e=this.line){return/^\s*/.exec(this.lineText(e))[0].length}lookingAt(e){if(this.line<this.buffer.code.length){var t=this.buffer.code[this.line];return e instanceof RegExp?e.exec(t.substr(this.col)):t.substr(this.col,e.length)==e?[e]:null}}textBefore(e){return null==e&&(e=this.buffer._rowColToPosition(this.line,this.col)),this.buffer.getCode().substr(0,e)}textAfter(e){return null==e&&(e=this.buffer._rowColToPosition(this.line,this.col)),this.buffer.getCode().substr(e)}substring(e,t){return this.buffer.getCode().substring(e,t)}substr(e,t){return this.buffer.getCode().substr(e,t)}eol(){return this.col>=this.buffer.code[this.line].length}eof(){var e=this.buffer.code.length,t=this.line;return t>=e||t==e-1&&this.eol()}stopAt(e,t,i=this.EOF){this.__stop={line:e,col:t,stop:i}}length(){return this.buffer.code.length}lineLength(e){return null==e&&(e=this.line),this.buffer.code[e].length}save(){return{buffer:this.buffer,line:this.line,col:this.col}}restore(e){this.buffer=e.buffer,this.line=e.line,this.col=e.col}checkStop(){if(this.eof())throw this.EOF;if(this.eol())throw this.EOL;let e=this.__stop;if(e&&(this.line>e.line||this.line==e.line&&this.col>=e.col))throw this.__stop=null,e.stop??this.EOF}}er.prototype.EOL={},er.prototype.EOF={};class es{constructor({buffer:e=null,line:t=0,col:i=0,pos:r=null}={}){if(this.buffer=e,this.line=t,this.col=i,this.pos=r,null==this.pos)this.pos=this.buffer._rowColToPosition(this.line,this.col);else{var s=this.buffer._positionToRowCol(this.pos);this.line=s.row,this.col=s.col}}static is_whitespace(e){switch(e){case" ":case"\n":case"	":case"\f":case"\u2028":case"\u2029":case" ":return!0}}peek(){var e=this.buffer.code,t=e[this.line];return null==t?null:this.col==t.length?this.line==e.length-1?null:"\n":t.charAt(this.col)}next(){var e=this.peek();return e&&(++this.pos,++this.col,this.col>this.buffer.code[this.line].length&&(this.col=0,++this.line)),e}read_while(e){for(var t,i="";(t=this.peek())&&e(t);)i+=this.next();return i}skip_ws(){return this.read_while(this.is_whitespace)}looking_at(e){var t=this.buffer.code[this.line];return e instanceof RegExp?e.exec(t.substr(this.col)):t.substr(this.col,e.length)==e}}es.prototype.is_whitespace=es.is_whitespace;let en=Object.create(null);class eo extends a{static define(e,t){en[e.toLowerCase()]=t}constructor({buffer:e,type:t}){super(),"string"==typeof t&&(t=en[t.toLowerCase()]),this.buffer=e,this.type=t}reset(){this.stream=new er({buffer:this.buffer}),this.theParser=this.type(this.stream,this),this.parsers=[this.theParser.copy()],this.timerUpdate=null,this.start()}stop(){clearTimeout(this.timerUpdate)}getLanguage(e,t){return en[e](this.stream,this,t)}start(){this.stop();let e=this.stream,t,i=this.parsers;for(e.line=i.length-1,e.col=0;!(t=i[e.line]);)e.prevLine();t=t();let r=()=>{this.buffer.preventUpdates();let s=100;for(;;)try{for(;;)t.next()}catch(n){if(n===e.EOL){if(e.nextLine(),i[e.line]=t.copy(),0==--s){this.buffer.resumeUpdates(),this.timerUpdate=setTimeout(r,10);return}}else if(n===e.EOF){this.buffer.resumeUpdates();break}else throw n}};r()}quickInsertLine(e){this.truncate(e)}quickDeleteLine(e){this.truncate(e)}onToken(e,t,i,r){this.callHooks("onFoundToken",e,t,i,r)}getParserForLine(e,t=0){this.stop();let i=this.stream,r,s=this.parsers;for(i.line=e,i.col=0;!(r=s[i.line]);)i.prevLine();null!=t&&i.stopAt(e,t),r=r();try{for(this.buffer.preventUpdates();;){if(null==t&&i.line==e)return r;try{for(;;)r.next()}catch(e){if(e===i.EOL)i.nextLine(),s[i.line]=r.copy();else if(e===i.EOF)return r;else throw e}}}finally{this.buffer.resumeUpdates(),i.line<i.length()&&(this.timerUpdate=setTimeout(this.start.bind(this,i.line),10))}}parseUntil(e,t){return this.getParserForLine(e,t)}reparseAll(){return this.truncate(0),this.finishParsing()}finishParsing(){return this.getParserForLine(this.stream.length(),null),this.getLastParser()}getLastParser(){return this.parsers.at(-1)}getIndentation(e,t){var i=this.getParserForLine(e,null);if(i&&i.indentation instanceof Function)return i.indentation(t)}truncate(e){e++,this.parsers.length>e&&(this.parsers.length=e)}getPP(){let e=this.theParser.passedParens;return e instanceof Function&&(e=e()),e?[...e].sort(ea):[]}}function ea(e,t){return(e.row??e.line)<(t.row??t.line)?-1:(e.row??e.line)>(t.row??t.line)?1:(e.col??e.c1)-(t.col??t.c1)}function el(e,t){return i=>i.closed&&"outer"==t&&i.outer?0>ea({line:i.outer.l1,col:i.outer.c1},e)&&ea({line:i.outer.l2,col:i.outer.c2},e)>=0:"inner"==t&&i.inner?0>=ea({line:i.inner.l1,col:i.inner.c1},e)&&ea({line:i.inner.l2,col:i.inner.c2},e)>=0:0>ea(i,e)&&ea(i.closed,e)>=0}let eh=g.define("help",{q:"bury_buffer"}),ec=g.define("read_register",{"Escape && C-g":function(){this.popKeymap(ec),this.setMinibuffer("")}});function ed(e,t,i,r){e.cmd("save_excursion",function(){for(var e=this._positionToRowCol(t),s=this._positionToRowCol(i),n=Math.abs(s.col-e.col),o=e.row;o<=s.row;++o){this.cmd("goto_char",this._rowColToPosition(o,0));var a=this.code[o],l=e.col,h=s.col,c=this.point(),d=0;if(l>h){var _=l;l=h,h=_}l>a.length&&(d=l-a.length,l=a.length),h>a.length&&(h=a.length),r.call(this,c+l,c+h,d,n)}},t==e.point())}ec.defaultHandler=[function(){var e=this.interactiveEvent().key;return 1!=e.length?this.signalError("Non-character input event"):(this.getq("read_register_callback")(e),this.setq("read_register_callback")),this.popKeymap(ec),this.setMinibuffer(""),!0}],R.newCommands({forward_char:w("p",function(e){return null==e&&(e=1),this.cmd("goto_char",this.point()+e)}),backward_char:w("p",function(e){return null==e&&(e=1),this.cmd("forward_char",-e)}),forward_line:w("p",function(e){null==e&&(e=1);var t=this._rowcol;/^(forward|backward)_line$/.test(this.previousCommand)||this.setq("line_movement_requested_col",t.col);var i=this.cmd("goto_char",this._rowColToPosition(t.row+e,Math.max(t.col,this.getq("line_movement_requested_col"))));return i||this.setq("line_movement_requested_col",t.col),i}),backward_line:w("p",function(e){return null==e&&(e=1),this.cmd("forward_line",-e)}),forward_whitespace:w("P",function(e){return this.cmd("search_forward_regexp",e?/[^\x20\t\xA0]/g:/[^\s]/g)?(this.cmd("backward_char"),!0):e?void 0:this.cmd("end_of_buffer")}),backward_whitespace:w("P",function(e){return this.cmd("search_backward_regexp",e?/[^\x20\t\xA0]/g:/[^\s]/g)?(this.cmd("forward_char"),!0):e?void 0:this.cmd("beginning_of_buffer")}),beginning_of_line:w(function(){return this.cmd("goto_char",this._rowColToPosition(this._rowcol.row,0))}),back_to_indentation:w(function(){var e=this._rowcol,t=this.code[e.row],i=/\S/.exec(t);if(i)return this.cmd("goto_char",this._rowColToPosition(e.row,i.index))}),beginning_of_indentation_or_line:w(function(){return this.cmd("back_to_indentation")||this.cmd("beginning_of_line")}),end_of_line:w(function(){var e=this._rowcol;return this.cmd("goto_char",this._rowColToPosition(e.row,this.code[e.row].length))}),beginning_of_buffer:w(function(){return this.cmd("goto_char",0)}),end_of_buffer:w(function(){return this.cmd("goto_char",this.getCodeSize())}),eob_p:function(){return this.point()==this.getCodeSize()},bob_p:function(){return 0==this.point()},eol_p:function(){var e=this._positionToRowCol(this.point());return e.col==this.code[e.line].length},bol_p:function(){return 0==this._positionToRowCol(this.point()).col},backward_delete_char:w("^p",function(e){if(!this.deleteTransientRegion()){null==e&&(e=1);var t=this.point();t>0&&this._deleteText(t-e,t)}}),delete_char:w("^p",function(e){if(!this.deleteTransientRegion()){null==e&&(e=1);var t=this.point();this._deleteText(t,t+e)}}),delete_whitespace:w("^P",function(e){if(!this.deleteTransientRegion()){var t=this.point();if(this.cmd("forward_whitespace",e))return this._deleteText(t,this.point()),!0}}),backward_delete_whitespace:w("^P",function(e){if(!this.deleteTransientRegion()){var t=this.point();if(this.cmd("backward_whitespace",e))return this._deleteText(this.point(),t),!0}}),delete_indentation:w("P",function(e){e&&this.cmd("forward_line"),this.cmd("back_to_indentation"),this.cmd("backward_delete_whitespace"),this.cmd("insert"," ")}),universal_argument:w("^",function(){this.pushKeymap(A),this.isMinibuffer||this.setMinibuffer("C-u")}),overwrite_mode:w(function(){this.resetOverwriteMode()}),self_insert_command:w("^p",function(e){var t=this.interactiveEvent(),i=t.key,r=this._rowcol;if(1==i.length&&!t.altKey&&!t.ctrlKey){if(this.deleteTransientRegion(),null!=e&&(i=i.repeat(e)),this.overwriteMode){var s=this.code[r.row].length-r.col;s>0&&this.cmd("delete_char",Math.min(s,e||1))}return this.cmd("insert",i),!0}return!1}),newline:w("^p",function(e){null==e&&(e=1),this.deleteTransientRegion(),this.cmd("insert","\n".repeat(e))}),newline_and_indent:w("^p",function(e){e?this.cmd("newline",e):(this.cmd("backward_delete_whitespace",!0),this.cmd("newline"),this.cmd("indent_line"))}),stupid_indent:w(function(){}),indent_line:w("P",function(e){if(this.tokenizer){let t=this.tokenizer.getIndentation(this._rowcol.row,this);if(null!=t){let i=this.getLine();if(!e||/\S/.test(i)){let e=this._rowcol,r=this.point()-e.col,s=/[^\S\r\n]*/.exec(i)[0].length;s>t?this._deleteText(r,r+s-t):t>s&&this._insertText(" ".repeat(t-s),r),e.col<=s&&this.cmd("goto_char",r+t)}}}else this.cmd("insert"," ".repeat(this.getq("indent_line")))}),indent_region:w("r",function(e,t){t<e&&([e,t]=[t,e]),this.cmd("save_excursion",function(){var i=this.createMarker(t);for(this.cmd("goto_char",e);this.point()<i.getPosition()&&(this.cmd("indent_line",!0),this.cmd("beginning_of_line"),this.cmd("forward_line")););i.destroy()})}),make_marker:function(e){return this.createMarker(e)},looking_at:function(){return this.looking_at.apply(this,arguments)},looking_back:function(){return this.looking_back.apply(this,arguments)},search_forward:w("sSearch: ",function(e,t){var i=this.getCode(),r=this.point();this.getq("case_fold_search")&&(i=i.toLowerCase(),e=e.toLowerCase());var s=i.indexOf(e,r);if(s>=0&&(null==t||s<=t))return this.cmd("goto_char",s+e.length)}),search_backward:w("sSearch backward: ",function(e,t){var i=this.getCode(),r=this.point();this.getq("case_fold_search")&&(i=i.toLowerCase(),e=e.toLowerCase());var s=i.lastIndexOf(e,r);if(s==r&&(s=i.lastIndexOf(e,r-1)),s>=0&&s!=r&&(null==t||s>=t))return this.cmd("goto_char",s)}),make_regexp:function(e){if(!(e instanceof RegExp)){var t=!this.getq("case_fold_search");try{e=new RegExp(e,t?"mug":"mugi")}catch(e){throw new b("Invalid regexp")}}return e},search_forward_regexp:w("sRegExp search: ",function(e){let t=(e=this.cmd("make_regexp",e)).lastIndex=this.point(),i=e.exec(this.getCode());if(i&&e.lastIndex!=t)return i.after=e.lastIndex,this.matchData=i,this.cmd("goto_char",e.lastIndex),!0}),search_backward_regexp:w("sBackward RegExp search: ",function(e){e=this.cmd("make_regexp",e);var t=this.lastIndexOfRegexp(this.getCode(),e,this.point());if(t&&t.index!=this.point())return this.cmd("goto_char",t.index),!0}),forward_word:k(function(){for(var e=this.getq("syntax_word"),t=!1;!t&&!e.test(this.charAt());)this.cmd("forward_char")||(t=!0);for(;!t&&e.test(this.charAt());)this.cmd("forward_char")||(t=!0)}),backward_word:k(function(){for(var e=this.getq("syntax_word"),t=!1;!t&&!e.test(this.charAt(-1));)this.cmd("backward_char")||(t=!0);for(;!t&&e.test(this.charAt(-1));)this.cmd("backward_char")||(t=!0)}),forward_paragraph:k(function(){let e=this.getq("syntax_paragraph_sep");this.cmd("beginning_of_line"),this.cmd("backward_char"),this.cmd("looking_at",e)&&this.cmd("goto_char",this.cmd("match_end")),this.cmd("search_forward_regexp",e)?this.cmd("goto_char",this.cmd("match_beginning")+1):this.cmd("end_of_buffer")}),backward_paragraph:k(function(){let e=this.point(),t=this.getq("syntax_paragraph_sep");if(this.cmd("beginning_of_line"),this.cmd("looking_back",t)){let t=this.cmd("match_end");t==e&&(t=this.cmd("match_beginning")),this.cmd("goto_char",t)}this.cmd("search_backward_regexp",t)?this.cmd("goto_char",this.cmd("match_end")):this.cmd("beginning_of_buffer")}),mark_paragraph:w("^r",function(e,t){this.transientMarker?this.cmd("save_excursion",function(){this.transientMarker&&this.cmd("goto_char",t),this.ensureTransientMark(),this.cmd("forward_paragraph"),this.setMark(this.point()),this.transientMarker.swap(this.caretMarker)}):(this.cmd("forward_paragraph"),this.setMark(this.point()),this.ensureTransientMark(),this.cmd("backward_paragraph")),this.ensureTransientMark(),this.setq("sticky_mark",!0)}),transpose_words:k(function(){this.cmd("backward_char"),this.getq("syntax_word").test(this.charAt())&&this.cmd("forward_word");var e=[];this.cmd("forward_word"),e.push(this.point()),this.cmd("backward_word"),e.push(this.point()),this.cmd("backward_word"),e.push(this.point()),this.cmd("forward_word"),e.push(this.point()),this.cmd("goto_char",this._swapAreas(e))}),transpose_lines:k(function(){var e=[];this.cmd("backward_line"),this.cmd("beginning_of_line"),e.push(this.point()),this.cmd("end_of_line"),e.push(this.point()),this.cmd("forward_char"),e.push(this.point()),this.cmd("end_of_line"),e.push(this.point()),this.cmd("goto_char",this._swapAreas(e)+1)}),transpose_chars:k(function(){var e=this.point();this.cmd("backward_char")&&this.cmd("goto_char",this._swapAreas([e-1,e,e,e+1]))}),kill_word:w("^p",function(e){if(this.transientMarker){var t=this.getRegion();this.cmd("kill_region",t.begin,t.end),this.clearTransientMark()}else{var i=this.point();this.cmd("forward_word",null==e?1:e);var r=this.point();this._killingAction(i,r,!1)}}),backward_kill_word:k(function(){var e=this.point();this.cmd("backward_word");var t=this.point();this._killingAction(e,t,!0)}),_apply_operation_on_word:function(e,t){var i=this.point();if(this.getq("syntax_word").test(this.charAt())){var r=this.cmd("save_excursion",function(){return this.cmd("forward_word"),this.point()}),s=e.call(this._bufferSubstring(i,r));this._deleteText(i,r),this._insertText(s)}else this.cmd("forward_word"),this.cmd("backward_word"),i!=this.point()&&this.cmd(t)},capitalize_word:k(function(){this.cmd("_apply_operation_on_word",function(){return this.charAt(0).toUpperCase()+this.substr(1).toLowerCase()},"capitalize_word")}),downcase_word:k(function(){this.cmd("_apply_operation_on_word",String.prototype.toLowerCase,"downcase_word")}),upcase_word:k(function(){this.cmd("_apply_operation_on_word",String.prototype.toUpperCase,"upcase_word")}),goto_char:w("NGoto char: ",function(e){return this._repositionCaret(e)}),goto_line:w("NGoto line: ",function(e){var t=this._rowColToPosition(e-1,0);return this.cmd("goto_char",t)}),move_to_column:w("NMove to column: ",function(e,t){var i=this._positionToRowCol(this.point()),r=this.code[i.row];r.length<e?t?(this.cmd("end_of_line"),this.cmd("insert"," ".repeat(e-r.length))):this.cmd("end_of_line"):this.cmd("goto_char",this._rowColToPosition(i.row,e))}),delete_region:w("r",function(e,t){this._deleteText(e,t)}),insert:w("sInsert text: ",function(...e){return this._insertText(e.join(""))}),keyboard_quit:w(function(){this.clearTransientMark(),this.setPrefixArg(void 0),this.setMinibuffer("")}),buffer_substring:function(e,t){if(0==arguments.length){var i=this.getRegion();e=i.begin,t=i.end}return this._bufferSubstring(e,t)},kill_line:w("^p",function(e){if(this.transientMarker){var t=this.getRegion();this.cmd("kill_region",t.begin,t.end),this.clearTransientMark()}else if(null!=e)this._killingAction(this.point(),this.cmd("save_excursion",()=>(this.cmd("forward_line",e),this.cmd("beginning_of_line"),this.point())));else{var i=this.point(),r=this._rowcol,s=i+this.code[r.row].length-r.col;r.row<this.code.length-1&&this.cmd("looking_at",/\s*$/my)&&s++,this._killingAction(i,s)}}),save_excursion:function(){return this._saveExcursion.apply(this,arguments)},prevent_undo:function(){return this._disableUndo.apply(this,arguments)},point:function(){return this.caretMarker.getPosition()},kill_region:w("r",function(e,t){this._killingAction(e,t)}),copy_region_as_kill:w("r",function(e,t){this._killingAction(e,t,!1,!0)}),yank:w("^P",function(e){this.deleteTransientRegion();var t=this.point();this._insertText(this.ymacs.killRingText()),this.setMark(t),e&&this.caretMarker.swap(this.markMarker)}),yank_from_operating_system:w(async function(){try{let e=await navigator.clipboard.readText();this._saveKilledText(e),this.callInteractively("yank")}catch(e){console.error(e),this.signalError("Cannot read the system clipboard. Error in devtools console.")}}),copy_for_operating_system:w("r",async function(e,t){try{let i=this.cmd("buffer_substring",e,t);await navigator.clipboard.writeText(i)}catch(e){console.error(e),this.signalError("Cannot write to system clipboard. Error in devtools console.")}}),yank_pop:w(function(){/^yank/.test(this.previousCommand)?(this.ymacs.rotateKillRing(!1),this._deleteText(this.caretMarker,this.markMarker),this.cmd("yank")):this.signalError("Previous command was not a yank")}),yank_shift:w(function(){/^yank/.test(this.previousCommand)?(this.ymacs.rotateKillRing(!0),this._deleteText(this.caretMarker,this.markMarker),this.cmd("yank")):this.signalError("Previous command was not a yank")}),mark:function(){return this.markMarker.getPosition()},set_mark_command:w("d",function(e){this.clearTransientMark(),this.setMark(e),"set_mark_command"==this.currentCommand&&(this.signalInfo("Mark set",null,1e3),this.setq("sticky_mark",!0))}),exchange_point_and_mark:w("^",function(){this.transientMarker=this.createMarker(),this.caretMarker.swap(this.markMarker),this.ensureTransientMark(),this.setq("sticky_mark",!0)}),mark_whole_buffer:w(function(){this.clearTransientMark(),this.cmd("end_of_buffer"),this.ensureTransientMark(),this.cmd("beginning_of_buffer"),this.ensureTransientMark()}),recenter_top_bottom:w("^",function(){this.whenActiveFrame(function(e){e.recenterTopBottom(this.sameCommandCount()%3)})}),recenter:w("^",function(){this.whenActiveFrame(function(e){e.centerOnCaret()})}),ensure_caret_visible:w(function(){this.whenActiveFrame(function(e){e.ensureCaretVisible()&&e.centerOnCaret()})}),get_fill_paragraph_region:function(){let e=this.cmd("save_excursion",()=>{this.cmd("looking_at",this.getq("syntax_paragraph_sep"))||this.cmd("forward_paragraph");let e=this.point()-1;return this.cmd("backward_paragraph"),{begin:this.point(),end:e}}),t=this.cmd("base_limit_fill_paragraph_region")||this.cmd("xml_limit_fill_paragraph_region");return t?{begin:Math.max(e.begin,t.begin),end:Math.min(e.end,t.end)}:e},fill_paragraph:w("^rP",function(e,t,i){this.cmd("save_excursion",function(){if(this.transientMarker)this.clearTransientMark();else{let i=this.cmd("get_fill_paragraph_region");e=i.begin,t=i.end}this.cmd("goto_char",e);var r=this.createMarker(t),s="",n=/\s+/y;for(this.cmd("looking_at",/\s*\/\/+\s*/y)?(s=this.matchData[0],n=/\s*\/\/+\s*/y):this.cmd("looking_at",/\s*\/\*\s*/y)?(s=" ".repeat(this.matchData[0].length),n=/\s*\**\s*/y):this.cmd("looking_at",/\s*[#>;\s]+\s*/y)?(s=this.matchData[0],n=/\s*[#>;\s]*\s*/y):this.cmd("looking_at",/\s*([-*]|[0-9]+\.|\(?[a-z][\).])?\s+/iy)&&(s=" ".repeat(this.matchData[0].length),n=/\s*[#>;\s]*\s*/y),i&&(this._deleteText(this.point(),this.point()+this.matchData[0].length),s="");this.cmd("end_of_line"),this.cmd("backward_delete_whitespace"),!(this.point()>=r.getPosition());)this._replaceText(this.point(),this.point()+1," "),n&&this.cmd("looking_at",n)&&this._deleteText(this.point(),this.point()+this.matchData[0].length);this.cmd("beginning_of_line");for(var o=this.point(),a=!1;!a;){var l=this.point();this.cmd("search_forward_regexp",/\s/g)||(a=!0),this.point()>=r.getPosition()&&(this.cmd("goto_char",r),a=!0),this._rowcol.col>this.getq("fill_column")+1&&(l>o&&this.cmd("goto_char",l),this.cmd("backward_delete_whitespace"),this.cmd("newline"),this.cmd("insert",s),o=this.point())}r.destroy()})}),start_next_paragraph:w(function(){this.cmd("backward_paragraph");var e="";this.cmd("looking_at",/(\s*)([0-9]+)(\.\s+)/y)?e=this.matchData[1]+(parseInt(this.matchData[2],10)+1)+this.matchData[3]:this.cmd("looking_at",/(\s*\(?)([a-z])([\.\)]\s+)/iy)?e=this.matchData[1]+String.fromCharCode(this.matchData[2].charCodeAt(0)+1)+this.matchData[3]:this.cmd("looking_at",/\s*[#>;*\s-]+\s*/y)&&(e=this.matchData[0]),this.cmd("forward_paragraph"),this.cmd("eob_p")&&this.cmd("newline"),this.cmd("insert","\n",e),this.cmd("looking_at",/\n\n/y)||(this.cmd("newline"),this.cmd("backward_char"))}),scroll_down_half:k(function(){this.whenActiveFrame(function(e){var t=e.heightInLines();this.cmd("forward_line",Math.round(t/1.33)),this.cmd("recenter")})}),scroll_up_half:k(function(){this.whenActiveFrame(function(e){var t=e.heightInLines();this.cmd("backward_line",Math.round(t/1.33)),this.cmd("recenter")})}),scroll_up:w("p",function(e){null==e&&(e=3),this.whenActiveFrame(function(t){t.scrollUp(e)})}),scroll_down:w("p",function(e){null==e&&(e=3),this.whenActiveFrame(function(t){t.scrollDown(e)})}),nuke_trailing_whitespace:w(function(){this.cmd("save_excursion",function(){for(this.cmd("goto_char",0);this._rowcol.row<this.code.length;){var e=this.code[this._rowcol.row],t=/\s+$/.exec(e);if(t&&(this.cmd("beginning_of_line"),this._deleteText(this.point()+t.index,this.point()+e.length)),!this.cmd("forward_line"))break}})}),match_string:function(e){return this.matchData[e]},match_beginning:function(){return this.matchData.index},match_end:function(){return this.matchData.index+this.matchData[0].length},undo:k(function(){this._placeUndoBoundary(),this._playbackUndo()||this.signalError("No further undo information")}),goto_last_change:w(function(){let e=[];if(this.point(),this.__undoQueue.forEach(t=>{if(3==t.type){let i=t.markers.find(e=>e[0]===this.caretMarker);i&&e.push(i[1])}}),e.length){e=e.reverse();let t=this.sameCommandCount()%e.length;this.cmd("goto_char",e[t])}}),center_line:w("p",function(e){null==e&&(e=1);for(let t=0;t<e;++t)t>0&&this.cmd("forward_line"),this.cmd("save_excursion",function(){this.cmd("end_of_line"),this.cmd("backward_delete_whitespace",!0),this.cmd("beginning_of_line"),this.cmd("delete_whitespace",!0);var e=this.code[this._rowcol.row],t=Math.floor((this.getq("fill_column")-e.length)/2);this.cmd("insert"," ".repeat(t))})}),dabbrev_expand:k(function(){"dabbrev_expand"!=this.previousCommand&&this.setq("dabbrev_context",null);var e,t=this.getq("dabbrev_context");if(!t){t=this.setq("dabbrev_context",{});var i=this.cmd("save_excursion",function(){return this.cmd("bind_variables",{syntax_word:this.getq("syntax_word_dabbrev")},"backward_word"),this.point()});if(i==this.point())return this.signalError("Nothing to expand");t.search=this.cmd("buffer_substring",i,this.point()),t.point=i,t.length=this.point()-i,t.lastSearch=i,t.encountered=Object.create(null),t.forward=!1,t.buffer=this,t.seenBuffers=[this],t.startBuffer=this}t.buffer.cmd("save_excursion",function i(){var r,s=this.getq("syntax_word_dabbrev"),n=!1;if(this.cmd("goto_char",t.lastSearch),t.forward){for(;this.cmd("search_forward",t.search);)if(!s.test(this.charAt(-t.search.length-1))){n=!0;break}if(n)t.lastSearch=this.point(),r=this.point()-t.search.length;else{if(t.buffer=this.whenYmacs("getNextBuffer",this),t.seenBuffers.includes(t.buffer)){e=t.search,t.startBuffer.signalError("No more completions"),t.lastSearch=t.point+t.length,t.startBuffer.setq("dabbrev_context",null);return}t.seenBuffers.push(t.buffer),t.lastSearch=0,t.buffer.cmd("save_excursion",i);return}}else{for(;this.cmd("search_backward",t.search);)if(!s.test(this.charAt(-1))){n=!0;break}if(n)r=this.point(),t.lastSearch=r,this.cmd("goto_char",r+t.search.length);else{t.forward=!0,t.lastSearch=t.point+t.length,i.call(this);return}}null!=r&&(this.cmd("bind_variables",{syntax_word:this.getq("syntax_word_dabbrev")},"forward_word"),e=this.cmd("buffer_substring",r,this.point()),t.encountered[e]&&i.call(this))}),null!=e&&(this._replaceText(t.point,t.point+t.length,e),t.length=e.length,t.encountered[e]=!0)}),split_frame_vertically:w("p",function(e){null==e?e="50%":e+="%",this.whenActiveFrame("vsplit",e)}),split_frame_horizontally:w("p",function(e){null==e?e="50%":e+="%",this.whenActiveFrame("hsplit",e)}),delete_other_frames:w(function(){this.whenActiveFrame("deleteOtherFrames")}),delete_frame:w(function(){this.whenActiveFrame("deleteFrame")}),other_frame:w(function(){this.whenYmacs("focusOtherFrame")}),windmove:function(e){this.whenYmacs(function(t){var i=t.getFrameInDirection(e);i&&i.focus()})},next_buffer:w(function(){this.whenYmacs("switchToNextBuffer",this.sameCommandCount()+1)}),previous_buffer:w(function(){this.whenYmacs("switchToPreviousBuffer",this.sameCommandCount()+1)}),switch_to_buffer:w("BSwitch to buffer: ",function(e){this.whenYmacs(function(t){if(!/\S/.test(e)){if(t.buffers.length<2)return;e=t.buffers[1]}t.switchToBuffer(e)})}),kill_buffer:w(function(){var e=this;function t(){e.whenYmacs(function(t){t.switchToNextBuffer(),t.killBuffer(e)})}if(e.dirty()){var i="Buffer "+e.name+" modified; kill anyway?";e.cmd("minibuffer_yn",i,function(e){e&&t()})}else t()}),rename_buffer:w("sRename current buffer to: ",function(e){this.whenYmacs(function(t){t.renameBuffer(this,e)})}),delete_region_or_line:w("^",function(){if(!this.deleteTransientRegion()){this.cmd("beginning_of_line");var e=this.point();if(this.cmd("end_of_line"),this.cmd("forward_char"),this.point()!=e)return this._deleteText(e,this.point()),!0}}),close_last_xml_tag:k(function(){var e;if(this.cmd("save_excursion",function(){for(var t=1;0!=t&&this.cmd("search_backward_regexp",/<\x2f?([a-zA-Z0-9:_-]+)/g);)e=this.cmd("match_string",1),this.cmd("looking_at",/<\x2f/y)?++t:!this.cmd("looking_at",/<[^\x2f][^>]*?\x2f>/y)&&--t;0!=t&&(e=null)}),e)this.cmd("insert","</",e,">");else throw new b("Couldn't find a tag to close")}),bind_variables:function(){return this.withVariables.apply(this,arguments)},for_region:w("^r\nCExecute command within region: ",function(e,t,i){if(t<e){var r=e;e=t,t=r}i instanceof Function||(i=this.COMMANDS[i]),this.clearTransientMark(),this.cmd("goto_char",e),e=this.createMarker(e,!0),t=this.createMarker(t),this.withCommands({goto_char:function(i){if(i>=e.getPosition()&&i<=t.getPosition())return this._repositionCaret(i);throw"YMACS_RESTRICT"}},function(){try{for(;;){var r=this.point();if(i.call(this),this.point()==r&&!this.cmd("forward_line"))break}}catch(e){if("YMACS_RESTRICT"!==e)throw e}finally{e.destroy(),t.destroy()}})}),comment_region:w("^r",function(e,t){var i=this.getq("syntax_comment_line")||this.getq("syntax_comment_multi");i&&(this.clearTransientMark(),this.cmd("save_excursion",function(){t=this.createMarker(t),this.cmd("goto_char",e);var r=1e5;e:for(;this.point()<t.getPosition();){for(;this.cmd("looking_at",/\s*$/my);)if(!this.cmd("forward_line"))break e;for(var s=this._rowcol.col;this.cmd("looking_at",/\s/y)&&s<r;){if(!this.cmd("forward_char"))break e;++s}if(s<r&&(r=s),Array.isArray(i.ch)?(this.cmd("insert",i.ch[0]," "),this.cmd("end_of_line"),this.cmd("insert"," ",i.ch[1])):this.cmd("insert",i.ch," "),this.cmd("beginning_of_line"),!this.cmd("forward_line"))break}this.cmd("goto_char",t),this._rowcol.col>0&&!this.cmd("looking_at",/\s*$/my)&&this.cmd("newline_and_indent")}))}),uncomment_region:w("r",function(e,t){var i=this.getq("syntax_comment_line"),r=this.getq("syntax_comment_multi");(i||r)&&(this.clearTransientMark(),this.cmd("save_excursion",function(){for(t=this.createMarker(t),this.cmd("goto_char",e);this.point()<t.getPosition()&&(this.cmd("forward_whitespace"),i&&this.cmd("looking_at",i.rx)?this.cmd("delete_char",this.matchData[0].length):r&&this.cmd("looking_at",r.rx)&&this._replaceText(this.point(),this.point()+this.matchData[0].length,this.matchData[1]),this.cmd("beginning_of_line"),this.cmd("forward_line")););}))}),comment_dwim:w("^r",function(e,t){var i=this.getq("syntax_comment_line"),r=this.getq("syntax_comment_multi");(i||r)&&(this.transientMarker?this.cmd("save_excursion",function(){this.cmd("goto_char",e),i&&this.cmd("looking_at",i.rx)||r&&this.cmd("looking_at",r.rx)?this.cmd("uncomment_region",e,t):this.cmd("comment_region",e,t)}):(this.cmd("end_of_line"),i?this.cmd("insert"," ",i.ch," "):(this.cmd("insert"," ",r.ch[0],r.ch[1]),this.cmd("backward_char",r.ch[1].length)),this.cmd("indent_line")))}),what_cursor_position:w("^",function(){var e=this.charAt(),t=e;null==e?t="EOF":" "==e?t="Space":"\n"==e&&(t="Newline"),this.popupMessage({isHtml:!0,atCaret:!0,text:function({ch:e,code:t,codeHex:i,point:r,sizeKB:s}){return`
<table>
  <tr><td style='text-align: right; font-weight: bold'>Char:</td><td><tt> ${e} </tt></td></tr>
  ${null!=t?`
    <tr><td style='text-align: right; font-weight: bold'>Char code:</td><td> ${t} / 0x${i} </td></tr>
  `:""}
  <tr><td style='text-align: right; font-weight: bold'>Position:</td><td> ${r} </td></tr>
  <tr><td style='text-align: right; font-weight: bold'>Buffer size:</td><td> ${s} </td></tr>
</table>`}({ch:r.htmlEscape(t),code:e?e.charCodeAt(0):null,codeHex:e?e.charCodeAt().toString(16).toUpperCase():null,point:this.point(),size:this.getCodeSize(),sizeKB:d(this.getCodeSize(),2)})})}),set_fill_column:w("p",function(e){let t=e=>{let t=this.getq("fill_column");this.setq("fill_column",+e),this.signalInfo(`Fill column set to ${e} (was ${t})`,!1,5e3)};null==e?this.whenMinibuffer(e=>{this.cmd("minibuffer_prompt","Set fill column to: "),e.setMark(),e.transientMarker=e.createMarker(e.point(),!0),e.cmd("insert",String(this._rowcol.col)),e.ensureTransientMark(),this.cmd("minibuffer_read_number",t)}):t(e)}),bury_buffer:w(function(){this.ymacs.switchToNextBuffer()}),describe_mode:w(function(){let e=this.ymacs,t=e.switchToBuffer("*Help*");e.switchToBuffer(t),t.pushKeymap(eh),t._disableUndo(()=>{t.setCode(`Active keymaps in buffer "${this.name}".
Press \`q\` to go back.

`),t.cmd("end_of_buffer");let e=(i,r)=>{for(let[s,n]of Object.entries(r)){let r=(i?i+" ":"")+s;if(Array.isArray(n)){let e="  ";e+=r;for(let t=20-r.length;t-- >=0;)e+=" ";e+=" : "+("function"==typeof n[0]?"(lambda)":JSON.stringify(n)),t.cmd("insert",e),t.cmd("newline")}else n&&"object"==typeof n&&e(r,n)}};[...this.keymap].reverse().forEach((i,r)=>{r>0&&t.cmd("insert","\n"),t.cmd("insert",`Keymap: ${i.name||"(unnamed)"}
`),t.cmd("newline"),e("",i.definitions)})}),t.dirty(!1),t.cmd("goto_char",0)}),window_configuration_to_register:w(function(){this.whenMinibuffer(e=>{e.prompt("Window configuration to register:"),this.setq("read_register_callback",e=>{let t=this.ymacs;t.registers[e]={frames:t.getFrameConfig()},this.signalInfo(`Saved to register "${e}"`,null,2e3)}),this.pushKeymap(ec)})}),jump_to_register:w(function(){this.whenMinibuffer(e=>{e.prompt("Jump to register:"),this.setq("read_register_callback",e=>this.ymacs.jumpToRegister(e)),this.pushKeymap(ec)})})}),R.newCommands({string_rectangle:w("r\nsString rectangle: ",function(e,t,i){ed(this,e,t,function(e,t,r){r>0?this._insertText(" ".repeat(r),e):this._deleteText(e,t),this._insertText(i,e+r)})}),kill_rectangle:w("r",function(e,t){var i=[];ed(this,e,t,function(e,t,r,s){var n=this._bufferSubstring(e,t);t-e<s&&(n+=" ".repeat(s-t+e)),i.push(n),this._deleteText(e,t)}),this.setq("killed_rectangle",i)}),clear_rectangle:w("r",function(e,t){this.cmd("string_rectangle",e,t," ".repeat(Math.abs(this._positionToRowCol(t).col-this._positionToRowCol(e).col)))}),insert_rectangle:function(e,t){var i=this._positionToRowCol(e).col;this.setMark(e),t.forEach((e,t)=>{t>0&&(this.cmd("forward_line")||(this.cmd("end_of_line"),this.cmd("newline")),this.cmd("move_to_column",i,!0)),this.cmd("insert",e)})},yank_rectangle:w("d",function(e){var t=this.getq("killed_rectangle");if(null==t)throw new b("No killed rectangle");this.cmd("insert_rectangle",e,t)}),_next_is_meta:function(){this.__nextIsMeta||(this.__nextIsMeta=!0,this.currentKeys.pop())}}),R.newCommands({kmacro_start_macro:w("p",function(e){if(!this.ymacs.isRunningMacro()){if(this.ymacs.isRecordingMacro())return void this.signalError("Already defining keyboard macro.");this.signalInfo("Defining keyboard macro"),this.ymacs.startMacro(null!==e)}}),kmacro_end_macro:w(function(){if(!this.ymacs.isRunningMacro()){if(!this.ymacs.isRecordingMacro())return void this.signalInfo("Not defining kbd macro");this.signalInfo("Keyboard macro defined"),this.ymacs.stopMacro()}}),kmacro_end_and_call_macro:w("p",function(e){this.ymacs.stopMacro(),null===e&&(e=1);var t=this.ymacs.getLastMacro();this.interactiveEvent(null),this.ymacs.runMacro(e,t)})}),["forward_char","forward_word","forward_line","forward_paragraph","forward_sexp","beginning_of_line","beginning_of_indentation_or_line","beginning_of_buffer","backward_char","backward_word","backward_line","backward_paragraph","backward_sexp","end_of_line","end_of_buffer"].forEach(function(e){R.COMMANDS[e+"_mark"]=w("^",function(){this.ensureTransientMark(),this.cmdApply(e,arguments),this.ensureTransientMark()})});var e_=null,ef=null,eu=null;function em(e,t,{noError:i=!1,noPrefix:s=!1}={}){ep();let n=document.activeElement,o=this.ymacs;(e_=new z).addClass("with-arrow"),t.forEach((e,t)=>{let i=e;"string"!=typeof e&&(i=e.value,e=e.label);let s=r.fromHTML(`<div class="Ymacs_Menu_Item" data-value="${r.htmlEscape(i)}"
                                          data-index="${t}">${r.htmlEscape(e)}</div>`);e_.add(s)}),r.on(e_.getContentElement(),{click:e=>{n.focus();let t=e.target;r.hasClass(t,"Ymacs_Menu_Item")&&(eg(+t.dataset.index),ev.call(this))}}),o._popupAtCaret(e_.getElement()),eg(0);let a=this.getq("ivy_completion")&&c(()=>{ep(),this.cmd("minibuffer_complete",{noError:i,noPrefix:s})},1);this.pushKeymap(eM),a&&this.addEventListener("onChange",a),e_.addEventListener("onDestroy",()=>{this.popKeymap(eM),a&&this.removeEventListener("onChange",a)})}function ep(){e_&&e_.destroy(),e_=null,eu=null,ef=null}function eg(e){let t=[...e_.getContentElement().querySelectorAll(".Ymacs_Menu_Item")],i=t.length;ef=(e%i+i)%i,t.forEach(e=>{let t=e.dataset.index==ef;t&&(eu=e),r.condClass(e,t,"selected")}),eu.scrollIntoView({block:"nearest"})}function eb(e,t,i){this.whenMinibuffer(function(r){let s=e!==ew;var n=r.setq({ivy_completion:s,completion_list:e,minibuffer_validation:(e,t)=>{null==e&&(e=r.cmd("minibuffer_contents")),i?i.call(this,r,e,t):t(!0)},minibuffer_continuation:e=>{r.setq(n),t&&t.call(this,e)}});r.cmd("minibuffer_complete",{noError:!0,noPrefix:!s})})}function ew(e,t,i,{noPrefix:r=!1}={}){var s=t.lastIndexOf("/"),n=t.slice(0,s+1),o=t.slice(s+1);this.ymacs.fs_getDirectory(n,function(s){if(s){var a=[];for(let e of Object.keys(s))0==e.indexOf(o)&&a.push("directory"==s[e].type?e+"/":e);if(0==a.length)i([]);else{var l=function e(t){switch(t.length){case 0:return"";case 1:return t[0];case 2:let i=t[0],r=t[1],s=Math.min(i.length,r.length),n=0;for(;n<s&&i.charAt(n)===r.charAt(n);)++n;return i.substring(0,n);default:return e([t[0],e(t.slice(1))])}}(a);l==o||r?1==a.length?i([t]):i(a.map(e=>({label:e,value:n+e}))):(e.cmd("minibuffer_replace_input",n+l),i(a.map(e=>({label:e,value:n+e}))))}}else e.signalError("Not found"),i(null)})}function ek(){e_&&eg(ef+1)}function ey(){e_&&eg(ef-1)}function ev(){if(e_){let e=eu;e?(ep(),this.cmd("minibuffer_replace_input",e.dataset.value),this.cmd("minibuffer_complete_and_exit")):this.signalError("Select something...")}else this.cmd("minibuffer_complete_and_exit")}R.newCommands({minibuffer_prompt:function(e,t){this.whenMinibuffer(function(i){var r=this.getMinibufferFrame();this.ymacs.setInputFrame(r),i.prompt(e),t||r.focus()})},minibuffer_yn:function(e,t){this.cmd("minibuffer_prompt",e+" (yes or no) "),this.cmd("minibuffer_read_yn",function(e){t("yes"==e)})},minibuffer_read_yn:function(e){eb.call(this,["yes","no"],e,function(e,t,i){"yes"==t||"no"==t?i(!0):e.signalError("Please enter yes or no")})},minibuffer_read_number:function(e){eb.call(this,null,e,function(e,t,i){var r=parseInt(t,10);isNaN(r)&&e.signalError("Please enter a number"),i(!isNaN(r))})},minibuffer_read_command:function(e){var t=Object.keys(this.COMMANDS).filter(e=>this.COMMANDS[e].ymacsInteractive).sort();eb.call(this,t,e,function(e,t,i){var r=this.COMMANDS[t],s=r&&r.ymacsInteractive;s||e.signalError("No such command: "+t),i(s)})},minibuffer_read_function:function(e){var t=Array.hashKeys(R.COMMANDS).sort();eb.call(this,t,e,function(e,t,i){var r=!!this.COMMANDS[t];r||e.signalError("No such function: "+t),i(r)})},minibuffer_read_buffer:function(e){this.whenYmacs(function(t){var i=t.buffers.map(e=>e.name);i.push(i.shift()),eb.call(this,i,e)})},minibuffer_read_string:function(e,t,i){eb.call(this,e,t,i)},minibuffer_read_variable:function(e){var t=Object.keys(Object.assign({},this.globalVariables,this.variables)).filter(e=>!/^\*/.test(e)).sort();eb.call(this,t,function(t){let i=this.getq(t);return this.signalInfo(`Current value of <b>${r.htmlEscape(t)}</b> = <b>${r.htmlEscape(i)}</b>`,!0,3e3),e.apply(this,arguments)})},minibuffer_read_existing_file:function(e){var t=this;t.cmd("minibuffer_replace_input_by_current_dir",function(){eb.call(t,ew,e,function(e,i,r){t.ymacs.fs_fileType(i,function(t){"file"!=t?(e.signalError("No such file: "+i),r(!1)):r(!0)})})})},minibuffer_read_file:function(e){var t=this;t.cmd("minibuffer_replace_input_by_current_dir",function(){eb.call(t,ew,e,function(e,i,r){t.ymacs.fs_fileType(i,function(e){r("directory"!=e)})})})},minibuffer_read_file_or_directory:function(e){var t=this;t.cmd("minibuffer_replace_input_by_current_dir",function(){eb.call(t,ew,e)})},minibuffer_read_directory:function(e){var t=this;t.cmd("minibuffer_replace_input_by_current_dir",function(){eb.call(t,ew,e)})},minibuffer_prompt_end:function(){return this.whenMinibuffer(function(e){return e.promptMarker.getPosition()})},minibuffer_contents:function(){return this.whenMinibuffer(function(e){return e._bufferSubstring(e.promptMarker)})},minibuffer_replace_input:function(e){this.whenMinibuffer(function(t){t._replaceText(t.promptMarker,t.getCodeSize(),e),this.getMinibufferFrame().redrawCaret(!0)})},minibuffer_replace_input_by_current_dir:function(e){this.whenYmacs(function(t){var i=this,r=t.getActiveBuffer().name,s=r.slice(0,r.lastIndexOf("/")+1);t.fs_getDirectory(s,function(r){r&&Object.keys(r).length>0?t.fs_remapDir(s,function(t){i.cmd("minibuffer_replace_input",t),i.cmd("minibuffer_complete",{noError:!0,noPrefix:!0}),e()}):(i.cmd("minibuffer_replace_input",""),e())})})},minibuffer_complete:function({noError:e=!1,noPrefix:t=!1}={}){var i=this;i.whenMinibuffer(function(s){let n=s.cmd("minibuffer_contents"),o=s.getq("completion_list");function a(r){r&&0!=r.length?em.call(s,i.getMinibufferFrame(),r,{noError:e,noPrefix:t}):e||s.signalError("No completions",!1,2e3)}o instanceof Function?o.call(i,s,n,function(e){e&&a(e)},{noPrefix:t}):o&&o.length>0?a(function(e,t){if(!(t=t.trim()))return e;let i=RegExp([...t].map(e=>(e=e.replace(/[\]\[\}\{\)\(\*\+\?\.\\\^\$\|]/ug,"\\$&").replace(/[\s_-]/ug,"[\\s_-]"),`(${e})(.*?)`)).join(""),"guid"),s=/(?<![\p{L}\p{N}])/uy,n=[];return e.forEach(e=>{let t="string"==typeof e?e:e.label,o="string"==typeof e?e:e.value;for(i.lastIndex=0;;){let e=i.exec(t);if(!e)break;let a=0,l="",h=0;for(let i=1;i<e.indices.length;){let[n,o]=e.indices[i++],[c,d]=e.indices[i++];a+=d-c,s.lastIndex=n,s.test(t)&&(a-=2),l+=r.htmlEscape(t.substring(h,n))+`<b>${t.substring(n,o)}</b>`,h=o}null!=h&&(l+=r.htmlEscape(t.substr(h))),n.push({label:r.htmlSafe(l),value:o,score:a}),i.lastIndex=e.index+1}}),n.sort((e,t)=>e.score-t.score).reduce((e,t)=>(e.some(e=>e.value==t.value)||e.push(t),e),[])}(o,n)):a(o)})},minibuffer_complete_and_exit:function(){this.whenMinibuffer(e=>{e.getq("minibuffer_validation").call(e,null,t=>{t?e.cmd("minibuffer_keyboard_quit",this.getq("minibuffer_continuation")):e.cmd("minibuffer_complete")})})},minibuffer_keyboard_quit:function(e){this.whenMinibuffer(function(t){var i=this.cmd("minibuffer_contents");t.setCode(""),this.ymacs.setInputFrame(this.ymacs.getActiveFrame()),this.ymacs.getActiveFrame().focus(),e||t.callHooks("abort"),setTimeout(()=>{e&&e.call(this,i),this.getPrefixArg()},1)}),ep()}});var ex={Tab:function(){e_?ek.call(this):this.cmd("minibuffer_complete")},Enter:ev,"Home && C-a":function(){this.cmd("goto_char",this.promptMarker)},"~":function(){if(this.getq("completion_list")===ew&&this.cmd("looking_back","/")){ep(),this.cmd("minibuffer_replace_input","~/"),this.cmd("minibuffer_complete",{noError:!0,noPrefix:!0});return}this.cmd("self_insert_command")},"S-Home && S-C-a":w("^",function(){this.ensureTransientMark(),this.cmd("goto_char",this.promptMarker),this.ensureTransientMark()})},eC=g.define(null,Object.assign({"C-g && Escape":"minibuffer_keyboard_quit"},ex)),eM=g.define(null,Object.assign({"S-Tab":function(){ey.call(this)},"ArrowDown && ArrowRight && C-n && C-f":ek,"ArrowUp && ArrowLeft && C-p && C-b":ey,PageDown:ek,PageUp:ey,"C-End && M->":function(){e_&&eg(-1)},"C-Home && M-<":function(){e_&&eg(0)},Escape:function(){ep()}},ex));eM.defaultHandler=[function(){return this.getq("ivy_completion")||ep(),!1}],R.newMode("minibuffer_mode",function(){return this.pushKeymap(eC),function(){this.popKeymap(eC)}}),R.newCommands({get_region:function(){return this.getRegion()},figure_out_mode:function(e){e||(e=this.getCode());var t=e.split(/\n/);for(let e of(t.length>4&&t.splice(2,t.length-4),t)){let t=/-\*-\s*(.*?)\s*-\*-/i.exec(e);if(t)return t[1]}},mode_from_name:function(e){switch(!e&&(e=this.name),(/\.[^.]+$/.exec(e)||[""])[0]){case".css":return"css";case".js":return"javascript";case".lisp":case".scm":case".el":return"lisp";case".md":return"markdown";case".xml":return"xml";case".html":return"html";case".twig":return"twig_html"}return null},set_buffer_mode:function(e){e||(e=this.cmd("figure_out_mode")||this.cmd("mode_from_name")),e&&(this.COMMANDS[e]?this.cmd(e,!0):this.COMMANDS[e+"_mode"]&&this.cmd(e+"_mode",!0))},cperl_lineup:w("r",function(e,t){this.cmd("save_excursion",function(){var i=this._positionToRowCol(t),r=0,s=[];this.cmd("goto_char",e),this.cmd("forward_whitespace",!0);var n=this.charAt();if(n.toLowerCase()!=n.toUpperCase())return void this.signalError("Cannot lineup here");for(;this._rowcol.row<=i.row;){var o=this.getLine().indexOf(n);if(o>=0&&(o>r&&(r=o),s.push([this._rowcol.row,o])),!this.cmd("forward_line"))break}++r,s.forEach(e=>{this.cmd("goto_char",this._rowColToPosition(e[0],e[1])),this.cmd("insert"," ".repeat(r-e[1]))})})}),htmlize_region:w("r\nP",function(e,t,i){this.tokenizer.finishParsing();var r,s=this._positionToRowCol(e).row,n="",o=s;for(i&&!i.empty&&(o=parseInt(i,10)),r=String(t=this._positionToRowCol(t).row).length;s<=t;)n+="<div class='line'>",i&&(n+="<span class='line-number'>"+function(e,t,i="0"){"number"==typeof e&&(e=Math.round(e));for(var r=""+e;r.length<t;)r=i+r;return r}(o,r," ")+"</span>"),++o,n+=this._textProperties.getLineHTML(s,this.code[s],null)+"</div>\n",++s;var a=this.ymacs.switchToBuffer("*Htmlize*");a.setCode(n),a.cmd("xml_mode",!0)}),execute_extended_command:w("^CM-x ",function(e){this.callInteractively(e)}),set_variable:w("vSet variable: \nsTo value: ",function(e,t){var i=parseFloat(t);isNaN(i)||(t=i),this.setq(e,t)}),eval_string:w("^MEval string: ",function(e){try{var t=[this,this.ymacs];(e=Function("buffer","ymacs",e)).apply(this,t),this.clearTransientMark()}catch(e){this.signalError(e.type+": "+e.message),window.console&&console.log(e)}}),eval_region:w("^r",function(e,t){this.cmd("eval_string",this.cmd("buffer_substring",e,t))}),eval_buffer:w(function(){this.cmd("eval_string",this.getCode())}),toggle_line_numbers:w("^",function(){this.ymacs.toggleClass("Ymacs-line-numbers")}),save_file:w("FWrite file: ",function(e){this.ymacs.ls_setFileContents(e,this.getCode()),this.signalInfo("Saved in local storage")}),load_file:w("fFind file: ",function(e){var t=this.ymacs.ls_getFileContents(e),i=this.ymacs.createBuffer({name:e});i.setCode(t),i.cmd("set_buffer_mode"),i.cmd("switch_to_buffer",e)}),find_file:w("FFind file: ",function(e){var t=this;e=t.ymacs.fs_normalizePath(e),t.ymacs.fs_fileType(e,function(i){"directory"==i?t.signalInfo("Can't open directory"):t.ymacs.fs_getFileContents(e,!0,function(i,r){var s=t.ymacs.getBuffer(e);function n(){s.setCode(i||""),s.stamp=r,s.dirty(!1),s.cmd("set_buffer_mode"),s.cmd("switch_to_buffer",e)}if(s)if(null==r)n();else if(s.stamp==r)s.cmd("switch_to_buffer",e);else{var o="File "+e+" changed on disk.  "+(s.dirty()?"Discard your edits?":"Reread from disk?");s.cmd("minibuffer_yn",o,function(e){e&&n()})}else s=t.ymacs.createBuffer({name:e,stamp:r}),null==i&&t.signalInfo("New file"),n()})})}),write_file:w("FWrite file: ",function(e){var t=this;function i(){t.ymacs.fs_setFileContents(e,t.getCode(),null,function(i){t.cmd("rename_buffer",e),t.dirty(!1),t.stamp=i,t.signalInfo("Wrote "+e)})}var r=t.ymacs.getBuffer(e);if(r){var s="A buffer is visiting "+e+"; proceed?";r.cmd("minibuffer_yn",s,function(e){e&&(t.ymacs.killBuffer(r),i())})}else i()}),save_some_buffers:function(){this.cmd("save_some_buffers_with_continuation",!0,function(){})},save_some_buffers_with_continuation:function(e,t){var i=this.ymacs.buffers.slice();!function r(s){i.length>0?i.shift().cmd("save_buffer_with_continuation",e,r):t()}(!1)},save_buffer_with_continuation:function(e,t){var i=this;function r(e){i.dirty(!1),i.stamp=e,t(!0)}function s(){i.ymacs.fs_setFileContents(i.name,i.getCode(),i.stamp,function(e){null!=e?r(e):i.cmd("minibuffer_yn",i.name+" has changed since visited or saved.  Save anyway?",function(e){e?i.ymacs.fs_setFileContents(i.name,i.getCode(),null,function(e){r(e)}):t(!1)})})}!i.dirty()||e&&i.name.match(/^\*.*\*$/)?t(!1):e?i.cmd("minibuffer_yn","Save file "+i.name+"?",function(e){e?s():t(!1)}):s()},save_buffer:w("",function(){var e=this;e.dirty()?e.cmd("save_buffer_with_continuation",!1,function(t){t&&e.signalInfo("Wrote "+e.name)}):e.signalInfo("No changes need to be saved")}),delete_file:w("fDelete file: ",function(e){var t=this;t.ymacs.fs_deleteFile(e,function(){t.signalInfo("Deleted "+e)})}),eval_file:w("fEval file: ",function(e){var t=this;t.ymacs.fs_getFileContents(e,!1,function(e,i){t.cmd("eval_string",e)})}),request_full_screen:w(async function(){try{this.ymacs.requestFullScreen()}catch(e){console.error(e),this.signalError("Full-screen denied",!1,3e3)}}),set_color_theme:w(function(e){if(e)this.ymacs.setColorTheme(e);else{let e=(function(){let e=[];for(let t of document.styleSheets)(function t(i){for(let s of i.cssRules){var r=s;if(r instanceof CSSImportRule)t(r.styleSheet);else{let t=/\.Ymacs-Theme-([\p{L}0-9_-]+)/u.exec(r.selectorText);t&&0>e.indexOf(t[1])&&e.push(t[1])}}})(t);return e})().sort();this.cmd("minibuffer_prompt","Color theme: "),eb.call(this,e,e=>{this.ymacs.setColorTheme(e)},(t,i,r)=>{if(i=i.trim())if(0>e.indexOf(i))return t.signalError("No such theme"),r(!1);else return r(!0);t.cmd("minibuffer_complete")})}}),toggle_bar_cursor:w(function(){this.ymacs.toggleBarCursor()})});let eE=g.define("isearch",{Escape:["isearch_abort",!0],"C-g":"isearch_reset_or_abort","C-w && C-S-s":"isearch_yank_word_or_char","C-s":"isearch_forward","C-r":"isearch_backward","M-%":"query_replace","C-M-%":"query_replace_regexp","M-s w && M-w":"isearch_toggle_word","M-s c && M-c":"isearch_toggle_case_fold","M-s Space && M-Space":"isearch_toggle_lax_whitespace",Enter:"isearch_abort","C-l":"recenter_top_bottom",Backspace:function(){this.getMinibuffer().point()>this._isearchContext.mbMark.getPosition()&&(this.getMinibuffer().cmd("backward_delete_char"),this.cmd("goto_char",this._isearchContext.livepoint),eP.call(this),eS.call(this))}});function eT({forward:e=!0,regexp:t=!1,lax:i=!0,word:r=!1,case_fold:s=this.getq("case_fold_search"),case_replace:n=this.getq("case_replace"),qreplace:o=!1,region:a=null}={}){if(!this._isearchContext)return this._isearchContext={forward:e,regexp:t,lax:i,word:r,case_fold:s,case_replace:n,livepoint:this.point(),origpoint:this.point(),current:{begin:this.point(),end:this.point()},mbMark:this.getMinibuffer().promptMarker,query:"",qreplace:o,region:a},o||(this.pushKeymap(eE),eO.call(this)),!0}function eP(){return this._isearchContext.query=this.getMinibuffer()._bufferSubstring(this._isearchContext.mbMark)}function eS({forward:e}={}){var t=this._isearchContext.query;return!/\S/.test(t)&&this.getq("isearch_last_context")&&(this._isearchContext=this.getq("isearch_last_context"),t=this._isearchContext.query,this.getMinibuffer()._placeUndoBoundary(),this.getMinibuffer().cmd("insert",t),this._isearchContext.origpoint=this.point(),this._isearchContext.current={begin:this.point(),end:this.point()}),this._isearchContext.livepoint=this.point(),null!=e&&(this._isearchContext.forward=e),eI.call(this)}function eA(){let e=this._isearchContext,t=e.query;return e.case_fold??(e.regexp?t=t.replace(/\\./g,""):t)==t.toLowerCase()}function eL(e,t){let i=this._rowcol,r=this._rowColToPosition(i.row-50,0),s=this._rowColToPosition(i.row+50,1/0),n=this.getCode(),o=[],a=this._isearchContext,l=this.point(),h=0,c=0;for(e.lastIndex=a.region?.begin||0;;){let t=e.exec(n);if(t&&t[0].length){if(a.region&&e.lastIndex>a.region.end)break;if(h++,t.index>=r&&t.index<=s){let i=this._positionToRowCol(t.index),r=this._positionToRowCol(e.lastIndex);o.push({line1:i.row,col1:i.col,line2:r.row,col2:r.col})}(l>=t.index&&l<e.lastIndex||l==e.lastIndex&&a.forward)&&(c=h)}else break}eO.call(this,h,c,t),this.setOverlay("isearch-lazy",o)}function eO(e,t,i){let r=this._isearchContext;this.whenMinibuffer(s=>{if(i)s.prompt(i.call(this,e,t,r));else{let i=r.qreplace&&e?`[${e}] `:e&&t?`[${t}/${e}] `:"";s.prompt(`${i}${r.qreplace?"Query replace":"I-search"}${r.regexp?" regexp":r.word?" word":""}${r.forward?"":" backward"}:`)}let n=r.mbMark,o=n+r.lastFoundQuery?.length;null!=o&&(s.forEachLine((e,t,i)=>{s._textProperties.removeLineProps(e,t,i,"css")},n,o),s.forEachLine((e,t,i)=>{s._textProperties.addLineProps(e,t,i,"css","isearch-fail")},o))})}function eI({forward:e}=this._isearchContext){let t=this._isearchContext,i=t.query,r=!1;try{let s=eN.call(this);if(r=this.cmd(e?"search_forward_regexp":"search_backward_regexp",s)){t.lastFoundQuery=i,this.cmd("ensure_caret_visible");let r=this.point(),s=r+(e?-1:1)*this.matchData[0].length;e&&([r,s]=[s,r]),t.current={begin:r,end:s};let n=this._positionToRowCol(r),o=this._positionToRowCol(s);this.setOverlay("isearch",{line1:n.row,col1:n.col,line2:o.row,col2:o.col})}eL.call(this,s)}catch{}return r}function eN({query:e=null,regexp:t=!1,lax:i=!0,case_fold:r=!0,word:s=!1}=this._isearchContext||{}){let n=e;return!t&&(n=e.replace(/[\]\[\}\{\)\(\*\+\?\.\\\^\$\|]/g,"\\$&"),s&&(n="\\b"+n+"\\b")),i&&(n=n.replace(/\s+/g,"\\s+")),new RegExp(n,eA.call(this)?"mugi":"mug")}eE.defaultHandler=["isearch_printing_char"],R.newCommands({isearch_forward:w(function(){let e={forward:!0};eT.call(this,e)||eS.call(this,e)||this.signalError("No more forward occurrences of the search text")}),isearch_backward:w(function(){let e={forward:!1};eT.call(this,e)||eS.call(this,e)||this.signalError("No more backward occurrences of the search text")}),isearch_forward_regexp:w(function(){let e={forward:!0,regexp:!0};eT.call(this,e)||eS.call(this,e)||this.signalError("No more forward occurrences of the search text")}),isearch_backward_regexp:w(function(){let e={forward:!1,regexp:!0};eT.call(this,e)||eS.call(this,e)||this.signalError("No more forward occurrences of the search text")}),isearch_yank_word_or_char:w(function(){this._isearchContext||eT.call(this,{forward:!0});let e=this._isearchContext;var t=e.current.end,i=this.cmd("save_excursion",function(){return this.cmd("goto_char",t),this.cmd("forward_word"),this.point()});if(i!=t){var r=this._bufferSubstring(t,i);this.getMinibuffer()._placeUndoBoundary(),this.getMinibuffer().cmd("insert",r.toLowerCase()),r=eP.call(this),this.cmd("goto_char",e.current.begin),eI.call(this,{forward:!0})}}),isearch_toggle_word:w(function(){let e=this._isearchContext;e.word=!e.word,e.word&&(e.regexp=!1),this.signalInfo(`Search word: ${e.word?"ON":"OFF"}`,!1,2e3),this.cmd("goto_char",this._isearchContext.current.begin),eI.call(this)}),isearch_toggle_case_fold:w(function(){let e=this._isearchContext;null==e.case_fold?e.case_fold=!1:!1===e.case_fold?e.case_fold=!0:!0===e.case_fold&&(e.case_fold=null),this.signalInfo(`Case sensitive: ${null==e.case_fold?"AUTO":e.case_fold?"OFF":"ON"}`,!1,2e3),this.cmd("goto_char",this._isearchContext.current.begin),eI.call(this)}),isearch_toggle_lax_whitespace:w(function(){let e=this._isearchContext;e.lax=!e.lax,this.signalInfo(`Loose whitespace: ${e.lax?"ON":"OFF"}`,!1,2e3),this.cmd("goto_char",this._isearchContext.current.begin),eI.call(this)}),isearch_printing_char:w(function(){let e=this._isearchContext;var t=this.interactiveEvent();return t?.key?.length!=1||t.ctrlKey||t.altKey?(this.cmd("isearch_abort"),!1):(this.whenMinibuffer(t=>{t.cmd("self_insert_command"),this.cmd("goto_char",e.livepoint),eP.call(this),eI.call(this)}),!0)}),isearch_abort:w(function(e){return e||this.setGlobal("isearch_last_context",this._isearchContext),this.setMinibuffer(""),this.popKeymap(eE),e?this.cmd("goto_char",this._isearchContext.origpoint):this.markMarker.setPosition(this._isearchContext.origpoint),this._isearchContext=null,this.deleteOverlay("isearch"),this.deleteOverlay("isearch-lazy"),!0}),isearch_reset_or_abort:w(function(){let e=this._isearchContext;e.lastFoundQuery&&e.query!=e.lastFoundQuery?this.whenMinibuffer(t=>{t._replaceText(e.mbMark,t.getCode().length,e.lastFoundQuery),e.query=e.lastFoundQuery,eI.call(this)}):this.cmd("isearch_abort",!0)})});let eR=g.define("query_replace",{"y && Space":"query_replace_yes_this_occurrence",".":"query_replace_yes_this_occurrence_and_stop","n && Delete && Backspace":"query_replace_no_this_occurrence",u:"query_replace_undo_previous","!":"query_replace_yes_all_occurrences","q && Enter":["query_replace_abort",!0],"C-l":"recenter_top_bottom"});function eF(e={}){this.whenMinibuffer(t=>{eT.call(this,{...e,qreplace:!0});let i=this._isearchContext;this.cmd("minibuffer_prompt",`Query replace${i.regexp?" regexp":i.word?" word":""}: `);let r=()=>{eP.call(this);try{eL.call(this,eN.call(this))}catch{}};t.addEventListener("afterInteractiveCommand",r);let s=e=>{t.removeEventListener("afterInteractiveCommand",r),t.removeEventListener("abort",s),e||(this.deleteOverlay("isearch"),this.deleteOverlay("isearch-lazy"),this._isearchContext=null)};t.addEventListener("abort",s),this.cmd("minibuffer_read_string",null,e=>{this._isearchContext.query=e,eq.call(this),s(!0)},(e,t,r)=>{i.query=t;try{eL.call(this,eN.call(this)),r(t)}catch{e.popupMessage({type:"error",text:"Incomplete regexp",atCaret:!0})}})})}function eq(){let e=this.getMinibuffer(),t=this._isearchContext,i=t.query,r=eN.call(this);if(eL.call(this,r),r){this.cmd("minibuffer_prompt",`Replace ${t.regexp?"regexp ":""}\u{201C}${i}\u{201D} with: `);let s=()=>{this.deleteOverlay("isearch"),this.deleteOverlay("isearch-lazy"),this._isearchContext=null,e.removeEventListener("abort",s)};e.addEventListener("abort",s),this.cmd("minibuffer_read_string",null,t=>{this.clearTransientMark(),eB.call(this,e,r,t)})}}function ez(e){if(this._isearchContext.case_replace&&e==e.toLowerCase()){let t=this.matchData[0];if(t==t.toUpperCase())return e.toUpperCase();if(t==this.capitalize(t))return this.capitalize(e)}return e}function eB(e,t,i){let r=this._isearchContext;this.pushKeymap(eR);let s,n,o,a=0,l=[],h=r.region&&this.createMarker(r.region.end);this.cmd("goto_char",r.region?r.region.begin:r.current.begin);let c=e=>(r.regexp&&(e=e.replace(/(?:\\([\\\&\#]|\d+|<.+?>))/g,(e,t)=>"\\"==t?"\\":"#"==t?a:"&"==t?this.matchData[0]:"<"==t[0]?this.matchData.groups[t.substr(1,t.length-2)]:this.matchData[+t])),ez.call(this,e)),d=e=>{let s=this.point(),n=this.cmd("search_forward_regexp",t);if(n){let t=this.matchData;if(r.region&&(t.index<r.region.begin||t.after>h))return e||this.cmd("goto_char",s),null;let i=this.matchData.index;if(n={begin:i,end:this.point()},!e){this.cmd("ensure_caret_visible");let e=this._positionToRowCol(i);this.setOverlay("isearch",{line1:e.row,col1:e.col,line2:this._rowcol.row,col2:this._rowcol.col})}}return e||eL.call(this,t,(e,t)=>`[${e}] Replace with \u{201C}${c(i)}\u{201D}? (y/n/u/!)`),n};s=this.replaceCommands({query_replace_yes_this_occurrence:w(()=>{l.push(o),this._replaceText(o.begin,o.end,c(i)),a++,(o=d())||n()}),query_replace_yes_this_occurrence_and_stop:w(()=>{l.push(o),this._replaceText(o.begin,o.end,c(i)),a++,n()}),query_replace_no_this_occurrence:w(()=>{(o=d())||n()}),query_replace_yes_all_occurrences:w(()=>{let e;for(;o;)e=o,this._replaceText(o.begin,o.end,c(i)),a++,o=d(!0);e&&(this.cmd("goto_char",e.begin),this.cmd("ensure_caret_visible")),n()}),query_replace_undo_previous:w(()=>{let e=l.pop();if(e){a--,this.cmd("undo");let t=this.__undoPointer,i=this.__undoQueue.slice(0,t);setTimeout(()=>{this.__undoPointer=t,this.__undoQueue=i}),this.cmd("goto_char",e.begin),o=d()}else this.signalError("No more undo")}),query_replace_abort:w(e=>(n(),e))}),n=()=>{h&&h.destroy(),e.removeEventListener("abort",n),this.newCommands(s),this.deleteOverlay("isearch"),this.deleteOverlay("isearch-lazy"),this._isearchContext=null,this.popKeymap(eR),e.cmd("minibuffer_keyboard_quit"),this.signalInfo(`Replaced ${a} occurrences`)},(o=d())?e.addEventListener("abort",n):n()}function eD(e){return w("^P",function(t){let i=this._isearchContext,r={qreplace:!0,regexp:null==e&&i?i.regexp:!!e,word:i?i.word:!!t,region:this.transientMarker&&this.getRegion()};i?(this.cmd("isearch_abort"),this._isearchContext=Object.assign({},i,r),eq.call(this)):eF.call(this,r)})}eR.defaultHandler=["query_replace_abort"],R.newCommands({query_replace:eD(null),query_replace_regexp:eD(!0)});class e${_cont=n;_inParens=n;_parens=n;_inComment=null;_inString=!1;_pmeta=null;COMMENT=["//",["/*","*/","*"]];STRING=['"',"'"];NUMBER=/^[+-]?(?:0x[0-9a-fA-F]+|(?:\d*\.)?\d+(?:[eE][+-]?\d+)?)/u;NAME=/^[\p{L}_$][\p{L}0-9_$]*/iu;WHITESPACE=/^[ \u00a0\n\r\t\f\u000b\u200b\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000\uFEFF]+/;OPEN_PAREN={"(":")","{":"}","[":"]"};CLOSE_PAREN={")":"(","}":"{","]":"["};constructor({stream:e,tok:t}){this._stream=e,this._tok=t}next(){this._stream.checkStop(),this._cont!==n?this._cont.car.call(this):this.read()}copy(){let e=this._cont,t=this._inParens,i=this._parens,r=this._inComment,s=this._inString,n=this._pmeta;return()=>(this._cont=e,this._inParens=t,this._parens=i,this._inComment=r,this._inString=s,this._pmeta=n,this)}maybeSave(){let e=this._stream;if(e.eol()&&e.nextLine())return this._tok.parsers[e.line]=this.copy(),!0}skipWS(e=!0){let t=this._stream,i;for(;;)if((i=t.lookingAt(this.WHITESPACE))&&this.t(null,i[0].length),e){if(!this.maybeSave())break}else break}read(){this.readComment()||this.readString()||this.readOpenParen()||this.readCloseParen()||this.readCustom()||this.readTrailingWhitespace()||this.t()}readComment(){for(let e of this.COMMENT)if(Array.isArray(e)&&this.readCommentMulti(...e)||this.readCommentLine(e))return!0}readCommentLine(e){let t=this._stream,i=null,r=null;for(;t.lookingAt(e);)i||(i={line:t.line,col:t.col,c1:t.col,c2:t.col,comment:!0,type:"",inner:{l1:t.line,c1:t.col},outer:{l1:t.line,c1:t.col}}),this.t("comment-starter",e.length),this.token({line:t.line,c1:t.col,c2:t.col=t.lineLength()},"comment"),r={line:t.line,col:t.col,c1:t.col,c2:t.col,type:"",opened:i};return i&&(i.closed=r,i.inner.l2=i.outer.l2=r.line,i.inner.c2=i.outer.c2=r.c1,this.doneParen(i)),i}readCommentMulti(e,t,i,r="mcomment-starter",s="mcomment",n="mcomment-stopper"){let o=this._stream,a;if(this._inComment)if(a=o.lookingAt(t)){let t=this.popInParen(e,a[0].length,n);t.inner.l2=t.closed.line,t.inner.c2=t.closed.c1,t.outer.l2=t.closed.line,t.outer.c2=t.closed.c2,this.popCont(),this._inComment=null}else this.t(s);else if(o.lookingAt(e)){this._inComment={line:o.line,c1:o.col,inner:i};let a=this.pushInParen(e,r);return a.comment=!0,a.inner={l1:a.line,c1:a.c2},a.outer={l1:a.line,c1:a.c1},this.pushCont(this.readCommentMulti.bind(this,e,t,i,r,s,n)),!0}}readString(e,t,i,r,s){let n=this._stream;if(this._inString)if(n.lookingAt("\\"))this.t(s),this.t(s);else if(n.lookingAt(t))this.popCont(),this._inString=!1,this.popInParen(e,t.length,`${s}-stopper`);else if(i&&n.lookingAt(i)){this._inString=!1;let e=this.pushInParen(i);this.pushCont(()=>{n.lookingAt(r)&&this._inParens.car===e?(this.popInParen(i,r.length),this.popCont(),this._inString=!0):this.read()})}else this.t(s);else for(let e of this.STRING){let t=e,i=e,r,s,o="string";if(Array.isArray(e)&&([t,i,r,s,o="string"]=e),n.lookingAt(t))return this.pushInParen(t,`${o}-starter`),this._inString=!0,this.pushCont(this.readString.bind(this,t,i,r,s,o)),!0}}readCustom(){return this.readNumber()}readName(){let e=this._stream,t=e.lookingAt(this.NAME);if(t)return{line:e.line,c1:e.col,c2:e.col+=t[0].length,id:t[0]}}maybeName(e=null){let t=this.readName();return t&&this.token(t,t.type=e),t}readNumber(){let e=this._stream.lookingAt(this.NUMBER);if(e)return this.t("number",e[0].length),!0}setParenMeta(e){this._pmeta=e}readOpenParen(){let e=this._stream.peek();if(this.OPEN_PAREN[e])return this.pushInParen(e).meta=this._pmeta,this._pmeta=null,!0}readCloseParen(){let e=this.CLOSE_PAREN[this._stream.peek()];if(e)return this.popInParen(e,1),!0}readTrailingWhitespace(){let e=this._stream.lookingAt(/^\s+$/);if(e)return this.t("trailing-whitespace",e[0].length),!0}t(e=null,t=1){this.token({line:this._stream.line,c1:this._stream.col,c2:this._stream.col+=t},e)}token(e,t=e.type){this._tok.onToken(e.line,e.c1,e.c2,t)}pushInParen(e,t="open-paren"){let i=this._stream,r=e.length,s={line:i.line,col:i.col,c1:i.col,c2:i.col+r,type:e};return this._inParens=new o(s,this._inParens),r&&this.t(t,r),s}popInParen(e,t=e.length,i="close-paren"){let r=this._stream;if(this._inParens!==n){let s=this._inParens.car;return this._inParens=this._inParens.cdr,e!=s.type?t&&this.t("error",t):(s.closed={line:r.line,col:r.col,c1:r.col,c2:r.col+t,opened:s},this.doneParen(s),t&&this.t(i,t)),s}t&&this.t("error",t)}inParen(){return this._inParens.car}doneParen(e){this._parens=new o(e,this._parens)}pushCont(e){this._cont=new o(e,this._cont)}popCont(){this._cont=this._cont.cdr}indentation(){let e=this._stream,t=e.line,i=e.lineText(),r=0,s=()=>this._stream.buffer.getq("indent_level");if(this._inString)return t>0&&!/\S/.test(i)?e.lineIndentation(t-1):null;if(this._inComment){let t=e.lineText(this._inComment.line);if(r=this._inComment.c1+1,"*"==this._inComment.inner&&!/^\s*\*/.test(i)){let e=/[^\s*]/g;e.lastIndex=this._inComment.c1+1;let i=e.exec(t);i&&(r=i.index)}return r}let o=this._inParens.car;if(o){let t=RegExp("^\\s*\\"+this.OPEN_PAREN[o.type]),n=t.test(i);(t=/\S/g).lastIndex=o.col+1;let a=t.exec(e.lineText(o.line));if(a)r=n?o.col:a.index;else{let t=o.line;this._parens.car?.closed?.line==t&&(t=this._parens.car.line),r=e.lineIndentation(t)+s(),n?r-=s():this.C_STATEMENTS&&/^\s*(?:[.:?*=&|]|\+[^+]|-[^-])/.test(i)&&(r+=s())}}else{let i=t,s;for(;i-- >0;)if(s=/\S/.exec(e.lineText(i))){let e=this._tok.getParserForLine(i);if(!(e._inString||e._inComment))break}s&&(r=s.index)}if(t>0){let t=e.textBefore();if(/\)\s*$/.test(t)&&this._parens!==n){o=this._parens.car;let t=e.lineText(o.line);/^\s*(?:if|for|while)\W/.test(t)&&!/^\s*\{/.test(i)&&(r+=s())}else/\Welse\s*$/.test(t)&&!/^\s*\{/.test(i)&&(r+=s())}return/^\s*(?:case|default)\W/.test(i)&&(r-=s()/2),r}get passedParens(){return[...this._parens]}get buffer(){return this._stream.buffer}get caret(){return this.buffer._rowcol}}R.newCommands({base_limit_fill_paragraph_region:function(){if(!this.tokenizer)return;let e=()=>this.tokenizer.getPP().filter(el(this._rowcol)).findLast(e=>e.comment),t=e()||this.cmd("save_excursion",()=>(this.cmd("end_of_line"),e()));if(t?.closed){let e={begin:this._rowColToPosition(t.outer.l1,t.outer.c1),end:this._rowColToPosition(t.outer.l2,t.outer.c2)};return this.cmd("save_excursion",()=>{this.cmd("goto_char",e.begin),this.cmd("backward_whitespace",!0),e.begin=this.point()}),e}}});class eH extends e${readCustom(){let e=this._stream,t;for(let[i,...r]of this.CSSRX)if(t=e.lookingAt(i))return r.forEach((e,i)=>e&&t[i]&&this.t(e,t[i].length)),!0}CSSRX=[[/^(-?(?:\d*\.)?\d+)(px|pt|em|ex|in|cm|mm|rem|vw|vh|fr|s|%)?/u,,"number","type"],[/^((?:--+|\$)[\p{L}\p{N}-]+)(:)?/u,,"variable-name","operator"],[/^([\p{L}\p{N}-]+)(:)/u,,"keyword","operator"],[/^\.[\p{L}\p{N}_:-]+/u,"function-name"],[/^#[\p{L}\p{N}_:-]+/u,"constant"],[/^@[\p{L}\p{N}_:-]+/u,"builtin"],[/^(?:url|none|auto|bold|italic|underline|normal|inherit|print|screen|all|important|calc|var)/,"builtin"]]}eo.define("css",(e,t)=>new eH({stream:e,tok:t})),R.newMode("css_mode",function(){var e=this.tokenizer;this.setTokenizer(new eo({buffer:this,type:"css"}));var t=this.cmd("paren_match_mode",!0),i=this.setq({syntax_paragraph_sep:/\n(?:[ \t\/\*]*\n)+/g,syntax_comment_line:{rx:/[^\S\r\n]*\/\/+ ?/ygu,ch:"//"},syntax_comment_multi:{rx:/[^\S\r\n]*\/\*+(.*?)\*+\//ygu,ch:["/*","*/"]}});return function(){this.setTokenizer(e),t||this.cmd("paren_match_mode",!1),this.setq(i)}});let eK=f(`abstract break case catch class const async await
continue debugger default delete do else enum export final finally for
function goto if implements import in instanceof interface native new package
private protected public return super switch synchronized throw throws
transient try typeof var void let yield volatile while with`),eU=f(`boolean byte char double float int long short
void Array Date Function Math Number Object RegExp String`),ej=f("false null undefined Infinity NaN true"),eY=f(`this Packages decodeURI decodeURIComponent
encodeURI encodeURIComponent eval isFinite isNaN parseFloat parseInt window
document alert arguments fetch`),eW=/[\[({,;+\-*=?&|!:>][\x20\t\n\xa0]*$|(?:return|typeof|case)\s+$/;class eV extends e${STRING=['"',"'",["`","`","${","}"]];_isProp=null;copy(){let e=super.copy(),t=this._isProp;return()=>{let i=e();return i._isProp=t,i}}readCustom(){let e=this._stream;if("/"==e.peek()&&eW.test(e.textBefore())){let t={line:e.line,col:e.col,type:"/"};return this.t("regexp-starter"),this.pushCont(this.readLiteralRegexp.bind(this,t)),!0}if(e.lookingAt("..."))return this.t("operator",3),!0;let t=this._isProp;this._isProp="."==e.peek();let i=this.readName();return i?(this.skipWS(),t?(i.type=e.lookingAt("(")?"function-name":null,this.token(i)):e.lookingAt(":")?(i.type="default"==i.id?"keyword":null,this.token(i)):this.parseALittle(i)||(i.type=i.id in eK?"keyword":e.lookingAt("(")?"function-name":i.id in eU?"type":i.id in ej?"constant":i.id in eY?"builtin":null,this.token(i)),!0):this.readNumber()}parseALittle(e){let t,i=this._stream,r=this.inParen();switch(e.id){case"class":if(i.lookingAt("{")||(t=this.maybeName("type"))){this.token(e,"keyword"),this.skipWS();let i=this.readName();i&&("extends"==i.id?(this.token(i,i.type="keyword"),this.skipWS(),this.maybeName("type")):this.token(i,null)),this.setParenMeta({class:e,name:t})}return!0;case"for":return this.token(e,"keyword"),this.setParenMeta({for:e}),!0;case"of":if(r?.meta?.for)return this.token(e,"keyword"),!0;break;case"function":return this.token(e,"keyword"),this.maybeName("function-name"),!0;case"new":return this.token(e,"keyword"),i.lookingAt(/^class/)||this.maybeName("type"),!0;case"get":case"set":case"static":case"constructor":if(r?.meta?.class)return this.token(e,"keyword"),!0}if(r?.meta?.class&&i.lookingAt(/^\s*\(/))return this.token(e,"function-name"),!0}readLiteralRegexp(e){let t=this._stream,i,r=!1,s=0,n=t.col;for(;!t.eol();){if("["==(i=t.peek())&&!r&&!s&&s++,"]"==i&&!r&&s&&s--,"/"==i&&!r&&!s){let i=t.col;this.popCont(),this.token({line:t.line,c1:n,c2:t.col},"regexp"),this.t("regexp-stopper");let r=t.lookingAt(/^[dgimsuvy]+/);r&&this.t("regexp-modifier",r[0].length),e.closed={line:t.line,c1:i,c2:t.col,opened:e},this.doneParen(e);return}r=!r&&"\\"===i,++t.col}this.token({line:t.line,c1:n,c2:t.col},"regexp")}}eV.prototype.C_STATEMENTS=!0,eo.define("js",(e,t)=>new eV({stream:e,tok:t}));let eQ=g.define("js",{"`":["paredit_open_pair","`","`",/[\`\\]/g],"'":["paredit_open_pair","'","'",/[\'\\]/g],"M-`":["paredit_wrap_round","`","`",/[\`\\]/g],"M-'":["paredit_wrap_round","'","'",/[\'\\]/g]});function eG(e){this.value=e}function eX(e,t){var i=new es({buffer:e,pos:t});function r(){return i.peek()}function s(){return i.next()}function n(){return i.read_while(function(e){return(!!k||null==v||i.pos!=v)&&i.is_whitespace(e)})}function o(e){return i.read_while(e)}function a(e,t,i){s();for(var r=!1,n="";;){var o=s();if(!o)throw new eG(n);if(r)n+=o,r=!1;else if("\\"==o)i&&(n+=o),r=!0;else if(o==t)break;else n+=o}return n}function l(){return o(function(e){return e&&"\n"!=e})}function h(){var e=o(function(){return!i.looking_at("|#")});return s(),s(),e}function c(){return a('"','"')}function d(e,t){var i=y;y=0;try{var o=[];s();e:for(;;)switch(n(),r()){case t:break e;case null:throw new eG(o);default:o.push(b()),++y}return s(),o}finally{y=i}}function _(){return{pattern:a("/","/",!0),modifiers:o(function(e){if(e)switch(e.toLowerCase()){case"y":case"m":case"g":case"i":return!0}}).toLowerCase()}}function f(e){switch(e){case null:case"(":case")":case"{":case"}":case"[":case"]":case"#":case";":case"`":case"'":case'"':case"|":case" ":case"\n":case"	":case"\f":case"\u2028":case"\u2029":case" ":return!1}return!0}function u(){return o(f)}function m(){return s()+o(function(e){return e>="a"&&e<="z"||e>="A"&&e<="z"||e>="0"&&e<="9"||"-"==e||"_"==e})}function p(){return s(),"\\"==r()&&s(),s()}function g(){switch(s(),r()){case"\\":return s(),M("char",m);case"/":return M("regexp",_);case"(":return M("vector",d.bind(null,"(",")"));case"'":return s(),M("function",b);case"|":return s(),M("comment",h);default:return M("unknown",b)}}function b(){if(n(),!k&&null!=v&&i.pos==v&&(!x||"list"==x.type))return k=M("caret");switch(r()){case";":return M("comment",l);case'"':return M("string",c);case"(":return M("list",d.bind(null,"(",")"));case"{":return M("list",d.bind(null,"{","}"));case"[":return M("list",d.bind(null,"[","]"));case"#":return M("sharp",g);case"?":return M("char",p);case"`":return s(),M("qq",b,-1);case",":if(s(),"@"==r())return s(),M("splice",b,-2);return M("unquote",b,-1);case"'":return s(),M("quote",b,-1);case")":case null:return null}return M("symbol",u)}function w(){for(var e=[];null!=r();){var t=b();if(null==t)break;e.push(t),++y}return e}var k=null,y=0,v=null,x=null,C=null;function M(e,t,r){null==r&&(r=0);var n=x;try{var o={value:null,index:y,type:e,start:i.pos+r,parent:x,depth:x?x.depth+1:0,partial:!1};"list"==e&&(x=o);try{t&&(o.value=t(),""===o.value&&"string"!=e&&s())}catch(e){if(e instanceof eG)o.value=e.value,o.partial=!0;else throw e}return o.end=i.pos,null!=v&&o.start<=v&&o.end>=v&&!C&&(C=o),o}finally{x=n}}return{parse:function(e){return v=e,M("list",w)},read:function(){return b()},prev_exp:function(){return k?k.parent.value[k.index-1]:C?"list"==C.type&&C.end==v+1?C.value.at(-1):C.parent.value[C.index]:void 0},caret_token:function(){return k},cont_exp:function(){return C},sexp:function(){for(var e=C;e&&(!/^(?:list|string)$/.test(e.type)||e.end==v);)e=e.parent;return e}}}R.newMode("javascript_mode",function(){let e=this.tokenizer;this.setTokenizer(new eo({buffer:this,type:"js"}));let t=this.cmd("paren_match_mode",!0);this.pushKeymap(eQ);let i=this.setq({syntax_paragraph_sep:/\n(?:[ \t\/\*]*\n)+/g,syntax_comment_line:{rx:/[^\S\r\n]*\/\/+ ?/ygu,ch:"//"},syntax_comment_multi:{rx:/[^\S\r\n]*\/\*+(.*?)\*+\//ygu,ch:["/*","*/"]}});return function(){this.setTokenizer(e),t||this.cmd("paren_match_mode",!1),this.popKeymap(eQ),this.setq(i)}}),Object.defineProperty({},"Ymacs_Lang_Lisp",{get:()=>e6,set:void 0,enumerable:!0,configurable:!0}),R.newCommands({test_lisp_parse:w(function(){try{var e=eX(this),t=e.parse(this.point());console.log(t),console.log(e.caret_token()),console.log(e.cont_exp()),console.log(e.prev_exp())}catch(e){console.log(e)}}),lisp_make_quick_parser:function(){return eX.apply(this,[this,...arguments])},lisp_forward_sexp:w(function(){var e=eX(this,this.point()).read();e&&this.cmd("goto_char",e.end)}),lisp_backward_sexp:w(function(){var e=eX(this);e.parse(this.point());var t=e.prev_exp();t&&this.cmd("goto_char",t.start)}),lisp_backward_up_list:w(function(){var e=eX(this);e.parse(this.point());var t=e.sexp();t&&t.parent&&this.cmd("goto_char",t.start)}),lisp_handle_string_quote:w(function(){var e=eX(this);e.parse(this.point());var t=e.prev_exp();t&&"string"==t.type&&this.point()<t.end?this.cmd("looking_at",/\"/y)?this.cmd("forward_char"):this.cmd("looking_back",/\\/g)?this.cmd("insert",'"'):this.cmd("insert",'\\"'):(this.cmd("insert",'""'),this.cmd("backward_char"))})});let eJ=u("  define defvar defparameter declaim proclaim declare type inline   optimize speed safety space debug defconstant   deftype defstruct defclass defsetf destructuring-bind   defmacro defun defmethod defgeneric defpackage in-package defreadtable in-readtable   when cond unless [ec]?typecase e?case   lambda λ let load-time-value quote macrolet   progn begin prog1 prog2 progv go flet the   if throw eval-when multiple-value-prog1 multiple-value-bind unwind-protect let\\*   ignore-errors handler-case handler-bind invoke-restart restart-case restart-bind   labels function symbol-macrolet block tagbody catch locally   inc! dec! cons c[ad]{1,4}r list list\\* eq eql equal equalp and or not null null\\?   loop do while dotimes   return return-from setq set! set-car! set-cdr! setf multiple-value-call values","i"),eZ=u("  for with and = as in on of then across by while until   from downfrom upfrom to upto below downto above   being each the hash-keys? using hash-values?   collect(?:ing)? nconc(?:ing)? sum(?:ming)? append(?:ing)? into   minimize minimizing maximize maximizing count counting   symbol symbols external-symbol external-symbols present-symbol present-symbols   named always never thereis   of-type   find maximizes minimizes that which   repeat finally initially return   if else when unless do doing"),e0=f("error warn assert"),e1=f("t nil"),e2=f("defun defmacro defgeneric defmethod"),e3=f("deftype defclass defstruct"),e4=f("defvar defparameter defconstant defconst"),e9={if:"3+",aif:"3+",when:"1*",awhen:"1*","once-only":"1*",lambda:"1*",unless:"1*",defun:"2*",defpackage:"1*",deftest:"1*",defgeneric:"2*",defmethod:"2*",defclass:"2*",defstruct:"1*",defmacro:"2*",progn:"0+",begin:"0+",prog1:"1*","multiple-value-prog1":"1*",prog2:"2*",let:"1*",labels:"1*",flet:"1*",macrolet:"1*","symbol-macrolet":"1*","unwind-protect":"1*",catch:"1*",case:"1*",ecase:"1*",typecase:"1*",etypecase:"1*",cond:"0+","handler-bind":"1*","handler-case":"1*","restart-bind":"1*","restart-case":"1*","return-from":"1*",block:"1*",dotimes:"1*",dolist:"1*","destructuring-bind":"2*","multiple-value-bind":"2*",":method":"1*","eval-when":"1*"},e5=f("labels flet macrolet");class e6 extends e${_formStack=n;_formSym=null;_formLen=0;_rxSpecial=null;COMMENT=[";",["#|","|#"]];STRING=['"'];NUMBER=/^[+-]?(?:#x[0-9a-fA-F]+|#\d+r[0-9a-zA-Z]+|#o[0-7]+|#b[01]+|(?:\d*\.)?\d+(?:[eE][+-]?\d+)?|\d+\/\d+)$/u;NAME=/^[-_$\p{L}0-9|!#$%&*+./:<=>?@\^~]+/iu;OPEN_PAREN={"(":")","{":"}","[":"]","❰":"❱","«":"»"};CLOSE_PAREN={")":"(","}":"{","]":"[","❱":"❰","»":"«"};constructor({stream:e,tok:t,rx_special:i}){super({stream:e,tok:t}),this._rxSpecial=i}isNameChar(e){return this.NAME.test(e)&&!this._rxSpecial?.test(e)}readName(){if(!this._rxSpecial)return super.readName();let e=this._stream,t=e.peek();if(this.isNameChar(t)){let i=e.col++,r;for(;this.isNameChar(r=e.peek());)t+=r,e.col++;return{line:e.line,c1:i,c2:e.col,id:t}}}copy(){let e=super.copy(),t=this._formStack,i=this._formSym,r=this._formLen,s=this._rxSpecial;return()=>{let n=e();return n._formStack=t,n._formSym=i,n._formLen=r,n._rxSpecial=s,n}}newArg(e){e?.id&&!this._formLen&&(this._formSym=e),this._formLen++}isForm(e){var t=this._formSym&&this._formSym.id;if(t)return(t=t.toLowerCase(),null==e)?t:"string"==typeof e?t==e:e instanceof RegExp?e.test(t):t in e}readCustom(){let e=this._stream,t;if(t=e.lookingAt(/^#\\.[a-z0-9_-]*/i))return this.newArg(),this.t("constant",t[0].length),!0;if(e.lookingAt("#:")&&this.isNameChar(e.peek(2)))return this.newArg(),e.col+=2,this.maybeName("lisp-keyword"),!0;if(e.lookingAt("#'")&&this.isNameChar(e.peek(2)))return this.newArg(),e.col+=2,this.maybeName("function-name"),!0;if(t=e.lookingAt(/^#\/((?:\\.|[^\/])*)\/([dgimsuvy]+)?/))return this.newArg(),this.t("regexp-starter",2),this.t("regexp",t[1].length),this.t("regexp-stopper"),t[2]&&this.t("regexp-modifier",t[2].length),!0;if(t=e.lookingAt(/^\?(?:\\?.)/u))return this.newArg(),this.t("constant",t[0].length),!0;if(t=this.readName()){let e=t.id.charAt(0),i=null;if(/^e?(?:type)?case$/i.test(this._formStack.cdr?.car?.id)&&this._formStack.car>2&&0==this._formLen||/^e?(?:type)?case$/i.test(this._formStack.cdr?.cdr?.cdr?.car?.id)&&this._formStack.cdr?.cdr?.car>2&&1==this._formStack.car?i="constant":/^let\*?$/i.test(this._formStack.cdr?.cdr?.cdr?.car?.id)&&this._formStack.cdr?.cdr?.car==2&&0==this._formLen||/^let\*?$/i.test(this._formStack.cdr?.car?.id)&&2==this._formStack.car?i="variable-name":/^(?:flet|labels)$/i.test(this._formStack.cdr?.cdr?.cdr?.car?.id)&&this._formStack.cdr?.cdr?.car==2&&0==this._formLen?i="function-name":/^(?:flet|labels)$/i.test(this._formStack.cdr?.car?.id)&&2==this._formStack.car&&(i="function-name"),i||(i=":"==e?"lisp-keyword":"&"==e?"type":t.id in e0?"error":t.id in e1?"constant":this.NUMBER.test(t.id)?"number":null),!i&&2==this._formStack.car){let e=this._formStack.cdr?.car?.id;"define"==e&&0==this._formLen?i="function-name":/^def(?!un|ine|test)/.test(e)&&(i="function-name")}return!i&&(0==this._formLen&&eJ.test(t.id)||0==this._formLen&&/^(?::?with(out)?[-\x2f]|def)/i.test(t.id)?i="keyword":1==this._formLen&&this.isForm(e2)?i="function-name":1==this._formLen&&this.isForm(e3)?i="type":1==this._formLen&&this.isForm("let")?i="function-name":1==this._formLen&&this.isForm(e4)?i="variable-name":1==this._formLen&&this.isForm(/^def/)?i="function-name":2==this._formLen&&this.isForm(/^def/)?i="type":this.isForm("loop")&&eZ.test(t.id)&&(i="directive")),t.type=i,this.newArg(t),this.token(t,i),!0}}readString(...e){if(super.readString(...e))return this.newArg(),!0}readOpenParen(){if(super.readOpenParen())return this.newArg(),this.pushFormStack(this._formSym),this.pushFormStack(this._formLen),this._formSym=null,this._formLen=0,!0}readCloseParen(){if(super.readCloseParen())return this._backList!==n&&(this._formLen=this.popFormStack(),this._formSym=this.popFormStack()),!0}pushFormStack(e){this._formStack=new o(e,this._formStack)}popFormStack(){let e=this._formStack.car;return this._formStack=this._formStack.cdr,e}indentation(){if(this._inString||this._inComment)return super.indentation();let e=this._stream,t=()=>this._stream.buffer.getq("indent_level");var i=0,r=this._inParens.car;if(r){var s,n=e.lineText(r.line);if(i=r.col+1,/[\#\']/.test(n.charAt(r.col-1)))return i;if(this.isNameChar(n.charAt(i))){var o=/\s\S/g;o.lastIndex=r.col,(s=o.exec(n))&&(i=s=s.index+1)}if(this._formLen){var a=this.isForm();if(a){var l=e9[a=a.replace(/\*$/,"")];if(!l&&/^with|:with/.test(a)&&(l="0*"),!l&&/^def/.test(a)&&(l=s&&/[\(\[\{]/.test(n.charAt(s))?"1*":"2*"),!l)try{this._formStack.cdr?.car?.id=="handler-case"?l="1*":e5[this._formStack.cdr.cdr.cdr.car.id]&&2==this._formStack.cdr.cdr.car&&(l="1*")}catch(e){}if(l){var h=parseInt(l,10),c=/\+/.test(l);/\*/.test(l),i=r.col+t(),c&&s?i=s:h>0&&this._formLen-1<h&&(s?i=s:i+=t())}}}}return i}}eo.define("lisp",(e,t,i={})=>new e6({stream:e,tok:t,...i}));let e7=g.define("lisp",{'"':["lisp_handle_string_quote"]});R.newMode("lisp_mode",function(){var e=this.tokenizer;this.setTokenizer(new eo({buffer:this,type:"lisp"}));var t=this.setq({indent_level:2,syntax_paragraph_sep:/\n(?:[ \t;]*\n)+/g,syntax_comment_line:{rx:/[^\S\r\n]*;+ ?/gu,ch:";;"},syntax_word_dabbrev:/^[-0-9_*%+/@&$.=~\p{L}]$/u,paredit_space_before(){return!this.looking_back(/[\s\(\)\[\]\{\},.@'`#\\"]/g)}}),i=this.cmd("paren_match_mode",!0);this.pushKeymap(e7);var r=this.replaceCommands({forward_sexp:"lisp_forward_sexp",backward_sexp:"lisp_backward_sexp",backward_up_list:"lisp_backward_up_list"});return function(){this.setTokenizer(e),this.setq(t),this.newCommands(r),i||this.cmd("paren_match_mode",!1),this.popKeymap(e7)}});let e8=/^\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/i;class te extends e${COMMENT=[];STRING=[["`","`",null,null,"markdown-code"],["**","**",null,null,"bold"],["__","__",null,null,"bold"],["*","*",null,null,"italic"]];OPEN_PAREN={"(":")","{":"}","[":"]","«":"»","❰":"❱","“":"”"};CLOSE_PAREN={")":"(","}":"{","]":"[","»":"«","❱":"❰","”":"“"};_block=null;copy(){let e=super.copy(),t=this._block;return()=>{let i=e();return i._block=t,i}}t(e=null,t=1){null!=this._block&&(e=this._block+(null!=e?" "+e:"")),this.token({line:this._stream.line,c1:this._stream.col,c2:this._stream.col+=t},e)}next(){return this._stream.eol()&&(this._block=null),super.next()}read(){"markdown-pre"!=this._block&&this.readInline()||this.readCustom()||this.readOpenParen()||this.readCloseParen()||this.readTrailingWhitespace()||this.t()}readInline(){return this.readString()}readCustom(){let e=this._stream,t;if(0==e.col&&(t=e.lookingAt(/^#+/)))this._block="heading"+t[0].length;else if(0==e.col&&(t=e.lookingAt(/^    /)))this._block="markdown-pre";else if(0==e.col&&(t=e.lookingAt(/^>[>\s]*/))){let e=t[0].replace(/\s+/g,"").length-1;e=Math.min(3,e),this._block="markdown-blockquote"+(e>0?e:"")}else if(t=e.lookingAt(e8))return this.t(`hyperlink :href-${t[0]}`,t[0].length),!0;else if(t=e.lookingAt(/^\[[a-zA-Z0-9_-]+\]/))return this.t("markdown-ref",t[0].length),!0}indentation(){let e=this._stream,t=e.line;return t>0&&e.lineIndentation(t-1)||e.lineIndentation(t)}}let tt=g.define("markdown",{"`":["paredit_open_pair","`","`",/[\`\\]/g],"M-`":["paredit_wrap_round","`","`",/[\`\\]/g]});eo.define("markdown",(e,t)=>new te({stream:e,tok:t})),R.newMode("markdown_mode",function(){var e=this.tokenizer;this.setTokenizer(new eo({buffer:this,type:"markdown"}));var t=this.cmd("paren_match_mode",!0);return this.pushKeymap(tt),function(){this.setTokenizer(e),t||this.cmd("paren_match_mode",!1),this.popKeymap(tt)}});let ti=g.define("parenmatch",{"C-M-x":"goto_matching_paren","C-M-q":"indent_sexp","C-M-f && C-M-n":"forward_sexp","C-M-b && C-M-p":"backward_sexp","C-M-u && M-a && C-M-ArrowUp":"backward_up_list","C-M-a":"beginning_of_defun","C-M-e":"end_of_defun","M-e":"up_list","C-M-ArrowDown":"down_list","M-C-k":"kill_sexp","M-C-Space":"mark_sexp","M-C-t":"transpose_sexps","(":["paredit_open_pair","(",")"],"[":["paredit_open_pair","[","]"],"{":["paredit_open_pair","{","}"],"❰":["paredit_open_pair","❰","❱"],"«":["paredit_open_pair","«","»"],"“":["paredit_open_pair","“","”"],'"':["paredit_open_pair",'"','"',/[\"\\]/g],")":["paredit_close_pair","(",")"],"]":["paredit_close_pair","[","]"],"}":["paredit_close_pair","{","}"],"❱":["paredit_close_pair","❰","❱"],"»":["paredit_close_pair","«","»"],"”":["paredit_close_pair","“","”"],"M-(":["paredit_wrap_round","(",")"],"M-[":["paredit_wrap_round","[","]"],"M-{":["paredit_wrap_round","{","}"],"M-❰":["paredit_wrap_round","❰","❱"],"M-«":["paredit_wrap_round","«","»"],"M-“":["paredit_wrap_round","“","”"],'M-"':["paredit_wrap_round",'"','"',/[\"\\]/g],"M-r":"paredit_raise_sexp","M-s":"paredit_splice_sexp",Backspace:"paredit_backward_delete_char",Enter:"paredit_newline_and_indent","; && : && , && .":"paredit_electric_char"});var tr={"(":")","[":"]","{":"}","❰":"❱","«":"»","“":"”",'"':'"',"'":"'","`":"`"},ts={")":"(","]":"[","}":"{","❱":"❰","»":"«","”":"“",'"':'"',"'":"'","`":"`"};function tn(e){throw new b("Balanced expression not found")}function to(e){return e.c1??e.col}function ta(e){return e.c2??e.col+1}function tl(e){return e.opened?e.opened.type||"":e.type||""}function th(e,t){return e.line==t.row&&to(e)<=t.col&&t.col<=ta(e)}R.newCommands({get_paren_at_point(){let e=this._rowcol,t=this.tokenizer.getPP(),i=[];for(let r of t){if(!r.type)continue;let t=r.closed;t&&(th(r,e)&&i.push(r),th(t,e)&&i.push(t))}return i.length?1==i.length||/\w/.test(tl(i[0]))&&!/\w/.test(tl(i[1]))?i[0].opened||i[0]:/\w/.test(tl(i[1]))&&!/\w/.test(tl(i[0]))?i[1].opened||i[1]:(i=(i=i.sort(ea))[0].opened?i[0]:i[1]).opened||i:null},matching_paren(){this.tokenizer.finishParsing();let e=this._rowcol,t=this.cmd("get_paren_at_point");if(t)return th(t,e)?this._rowColToPosition(t.closed.line,ta(t.closed)):this._rowColToPosition(t.line,to(t))},indent_sexp:w(function(){var e=this.cmd("matching_paren");null!=e?this.cmd("indent_region",this.point(),e):tn(this)}),goto_matching_paren:w(function(){var e=this.cmd("matching_paren");if(null!=e)return this.cmd("goto_char",e),!0}),forward_sexp:w(function(){let e;this.tokenizer.finishParsing();let t=this._rowcol,i=this.tokenizer.getPP();for(let r=0;r<i.length;++r){let s=i[r];if(s.line>t.row||s.line==t.row&&to(s)>=t.col){e=s;break}}this.withVariables({syntax_word:this.getq("syntax_word_sexp")},"forward_word"),e&&e.closed&&ea(this._rowcol,e)>0&&this.cmd("goto_char",this._rowColToPosition(e.closed.line,ta(e.closed)))}),backward_sexp:w(function(){let e;this.tokenizer.finishParsing();let t=this._rowcol,i=this.tokenizer.getPP().filter(e=>e.closed).map(e=>e.closed).sort(ea);for(let r=i.length;--r>=0;){let s=i[r];if(s.line<t.row||s.line==t.row&&(to(s)<t.col||s.c1==s.c2&&to(s)==t.col)){e=s;break}}this.withVariables({syntax_word:this.getq("syntax_word_sexp")},"backward_word"),e&&e.opened&&0>ea(this._rowcol,{line:e.line,col:ta(e)})&&this.cmd("goto_char",this._rowColToPosition(e.opened.line,to(e.opened)))}),mark_sexp:w("^r",function(e,t){this.tokenizer.finishParsing();let i=this.cmd("get_paren_at_point");i?.outer?(this.cmd("goto_char",this._rowColToPosition(i.outer.l1,i.outer.c1)),this.ensureTransientMark(),this.cmd("goto_char",this._rowColToPosition(i.outer.l2,i.outer.c2)),this.setMark(this.point()),this.transientMarker.swap(this.caretMarker)):this.cmd("save_excursion",function(){this.transientMarker&&this.cmd("goto_char",t),this.ensureTransientMark(),this.cmd("forward_sexp"),this.setMark(this.point()),this.transientMarker.swap(this.caretMarker)}),this.ensureTransientMark(),this.setq("sticky_mark",!0)}),kill_sexp:w(function(){this._killingAction(this.point(),this.cmd("save_excursion",function(){return this.cmd("forward_sexp"),this.point()}))}),transpose_sexps:w(function(){var e=[];this.cmd("forward_sexp"),e.push(this.point()),this.cmd("backward_sexp"),e.push(this.point()),this.cmd("backward_sexp"),e.push(this.point()),this.cmd("forward_sexp"),e.push(this.point()),this.cmd("goto_char",this._swapAreas(e))}),down_list:w(function(){this.tokenizer.finishParsing();let e=this._rowcol,t={line:e.row,col:e.col},i=this.tokenizer.getPP().filter(e=>e.closed).find(e=>ea(e,t)>=0);null!=i?this.cmd("goto_char",this._rowColToPosition(i.line,ta(i))):tn(this)}),backward_up_list:w(function(){this.tokenizer.finishParsing();let e=this._rowcol,t=this.tokenizer.getPP().filter(el(e)).at(-1);null!=t?this.cmd("goto_char",this._rowColToPosition(t.line,to(t))):tn(this)}),up_list:w(function(){this.cmd("backward_up_list"),this.cmd("forward_sexp")}),beginning_of_defun:w(function(){this.tokenizer.finishParsing();let e=this._rowcol,t=this.tokenizer.getPP().filter(el(e))[0];null!=t?this.cmd("goto_char",this._rowColToPosition(t.line,to(t))):this.cmd("backward_sexp"),this.cmd("back_to_indentation")}),end_of_defun:w(function(){this.tokenizer.finishParsing();let e=this._rowcol,t=this.tokenizer.getPP().filter(el(e))[0];null!=t?(t=t.closed,this.cmd("goto_char",this._rowColToPosition(t.line,ta(t)))):this.cmd("forward_sexp")}),paredit_raise_sexp:w(function(){if(this.tokenizer.finishParsing(),!this.tokenizer.getPP().filter(el(this._rowcol,"inner")).at(-1))return void this.signalError("No containing expression");this.cmd("forward_sexp"),this.cmd("backward_sexp");var e=this.point();this.cmd("forward_sexp");var t=this.point();this.cmd("backward_up_list");var i=this.point();this.cmd("forward_sexp");var r=this.point(),s=this.cmd("buffer_substring",e,t);this._replaceText(i,r,s),this.cmd("goto_char",i),this.cmd("indent_region",i,i+s.length)}),paredit_splice_sexp:w(function(){this.tokenizer.finishParsing();let e=this.tokenizer.getPP().filter(el(this._rowcol,"inner")).at(-1);if(!e)return void this.signalError("No containing expression");e.inner&&e.outer?this.cmd("save_excursion",function(){let t=this._rowColToPosition(e.outer.l1,e.outer.c1),i=this._rowColToPosition(e.outer.l2,e.outer.c2),r=this._rowColToPosition(e.inner.l1,e.inner.c1),s=this._rowColToPosition(e.inner.l2,e.inner.c2);this.withMarkers((e,n)=>{this._deleteText(s,i),this._deleteText(t,r),this.cmd("indent_region",e,n)},r,s)}):this.cmd("save_excursion",function(){this.cmd("backward_up_list");var e=this.point();this.cmd("forward_sexp"),this.cmd("backward_delete_char");var t=this.point();this.cmd("goto_char",e),this.cmd("delete_char"),this.cmd("indent_region",e,t-1)})}),paredit_backward_delete_char:w("^p",function(e){if(null!=e)return this.cmd("backward_delete_char",e);if(!this.deleteTransientRegion()){if(this.cmd("looking_back",/[\(\[\{\"\❰\«\`\']/g)){var t=tr[this.matchData[0]];if(t){var i=RegExp("\\s*\\"+t,"my");this.cmd("looking_at",i)&&this.cmd("save_excursion",function(){this.cmd("delete_whitespace"),this.cmd("delete_char")})}}this.cmd("backward_delete_char")}}),paredit_delete_char:w("^p",function(e){if(null!=e)return this.cmd("delete_char",e);if(!this.deleteTransientRegion()){if(this.cmd("looking_at",/[\]\}\)\"\❱\»\`\']/y)){var t=ts[this.matchData[0]];if(t){var i=RegExp("\\"+t+"\\s*","mg");this.cmd("looking_back",i)&&this.cmd("save_excursion",function(){this.cmd("backward_delete_whitespace"),this.cmd("backward_delete_char")})}}this.cmd("delete_char")}}),paredit_open_pair:w("^",function(e,t,i){if(this.transientMarker)return void this.cmd("paredit_wrap_round",e,t,i);if(e==t&&this.looking_at(e))this.cmd("forward_char");else{let i=this.getq("paredit_space_before");"function"==typeof i&&(i=i.apply(this,arguments)),i&&this.cmd("insert"," "),this.cmd("insert",e),this.cmd("insert",t),this.cmd("backward_char",t.length)}this.cmd("paredit_maybe_indent")}),paredit_close_pair:w("^",function(e,t){if(this.transientMarker)return void this.cmd("paredit_wrap_round",e,t);var i=RegExp("\\s*\\"+t,"iy");this.cmd("looking_at",i)&&this._deleteText(this.point(),this.matchData.after),this.cmd("insert",t),this.cmd("paredit_maybe_indent")}),paredit_wrap_round:w("^",function(e,t,i){let r=this.transientMarker?this.getRegion():this.cmd("save_excursion",function(){let e=this.point();return this.cmd("forward_sexp"),{begin:e,end:this.point()}}),s=this._bufferSubstring(r.begin,r.end),n=this.point()<r.end;i&&(s=s.replace(i,e=>"\\"+e));let o=this.createMarker(r.end);this.cmd("save_excursion",function(){this._replaceText(r.begin,r.end,e+s+t)},n),n&&this.cmd("forward_char"),this.clearTransientMark(),this.cmd("indent_region",r.begin,o.getPosition()),o.destroy()}),paredit_newline_and_indent:w(function(){var e=this.looking_at(/[ \t]*([\]\}])/y)&&this.looking_back(RegExp("\\"+ts[this.matchData[1]]+"[ \\t]*","g"));this.cmd("newline_and_indent"),e&&(this.cmd("newline_and_indent"),this.cmd("backward_line"),this.cmd("indent_line"))}),paredit_maybe_indent:function(){this.getq("electric_indent")&&this.cmd("indent_line")},paredit_electric_char:w(function(){this.cmd("self_insert_command"),this.cmd("paredit_maybe_indent")})}),R.newMode("paren_match_mode",function(){this.pushKeymap(ti);var e=(function(){this.deleteOverlay("match-paren")}).bind(this);let t={beforeInteractiveCommand:function(){e()},afterInteractiveCommand:c(()=>{this._rowcol;let e=[],t=this.cmd("get_paren_at_point");t&&e.push({line1:t.line,col1:t.c1,line2:t.line,col2:t.c2},{line1:t.closed.line,col1:t.closed.c1,line2:t.closed.line,col2:t.closed.c2}),this.setOverlay("match-paren",e)},100)};return this.addEventListener(t),null==this.getq("electric_indent")&&this.setq("electric_indent",!0),function(){e(),this.popKeymap(ti),this.removeEventListener(t)}});let tc=/^(?:area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)$/i,td=/^(?:article|aside|blockquote|body|button|caption|col|dd|div|dl|dt|fieldset|figcaption|figure|footer|form|h[1-6]|header|hgroup|li|ol|p|pre|section|table|tbody|textarea|tfoot|th|thead|td|tr|ul)$/i,t_=g.define("xml",{"C-c /":"xml_close_tag","/":"xml_slash_complete_tag",">":"xml_gt_complete_tag","%":"twig_insert_percent","M--":"twig_block_toggle_whitespace","C-Enter":"xml_zen_expand",Enter:"xml_newline_and_indent"}),tf=e=>function(){var t=this.tokenizer;this.setTokenizer(new eo({buffer:this,type:e}));var i=this.cmd("paren_match_mode",!0);this.pushKeymap(t_);var r=this.setq({indent_level:2,syntax_comment_multi:{rx:/[^\S\r\n]*<!--+[^\S\r\n]*(.*?)[^\S\r\n]*-->/ygu,ch:["\x3c!--","--\x3e"]},syntax_word_dabbrev:/^[\p{N}_$\p{L}:#-]$/u,syntax_word_sexp:/^[\p{N}_$\p{L}:#-]$/u});return function(){i||this.cmd("paren_match_mode",!1),this.popKeymap(t_),this.setq(r),this.setTokenizer(t)}};R.newMode("xml_mode",tf("xml")),R.newMode("html_mode",tf("html")),R.newMode("twig_html_mode",tf("twig_html"));class tu extends e${_tags=n;_inTag=null;_inline=0;COMMENT=[["\x3c!--","--\x3e","-"],["<![CDATA[","]]>",null,"xml-cdata-starter","xml-cdata","xml-cdata-stopper"]];NAME=/^[\p{L}:_$-][\p{L}0-9:_$-]*/iu;OPEN_PAREN={"(":")","{":"}","[":"]","«":"»","❰":"❱","“":"”"};CLOSE_PAREN={")":"(","}":"{","]":"[","»":"«","❱":"❰","”":"“"};constructor({stream:e,tok:t,emptyTags:i,inline:r}){super({stream:e,tok:t}),this.emptyTags=i,this.inline=r}copy(){let e=super.copy(),t=this._tags,i=this._inTag,r=this._inline;return()=>{let s=e();return s._tags=t,s._inTag=i,s._inline=r,s}}read(){this.readComment()||this.readDeclaration()||this.readCloseTag()||this.readOpenTag()||this.readOpenParen()||this.readCloseParen()||this.readTrailingWhitespace()||this.t(null,1," "!=this._stream.peek())}t(e=null,t=1,i){if(i&&this.inline){let t=this.inline.cls(this._inline);null!=t&&(e=t+(null!=e?" "+e:""))}this.token({line:this._stream.line,c1:this._stream.col,c2:this._stream.col+=t},e)}readDeclaration(){let e=this._stream,t=e.lookingAt(/^<[?!]/);if(t){let i=t[0];return this.pushInParen(i,"xml-open-bracket"),this.pushCont(()=>{let t=e.lookingAt(/^\??>/);t?(this.popInParen(i,t[0].length,"xml-close-bracket"),this.popCont()):this.readString()||this.readTrailingWhitespace()||this.t("directive")}),!0}}readOpenTag(){let e=this._stream;if(e.lookingAt("<")&&this.NAME.test(e.peek(1))){let t={l1:e.line,c1:e.col};this.pushInParen("<","xml-open-bracket");let i=this.maybeName("xml-open-tag");return i.outer=t,this._inTag=i,this.pushCont(this.contOpenTag),!0}}contOpenTag(){let e=this._stream,t=e.peek();e.lookingAt("/>")?(this.popInParen("<",2,"xml-close-bracket"),this.popCont(),this._inTag=null):">"===t?(this.popInParen("<",1,"xml-close-bracket"),this.popCont(),!this.emptyTags?.test(this._inTag.id)&&(this._inTag.inner={l1:e.line,c1:e.col},this.pushTag(this._inTag),this.inline&&(this._inline^=this.inline.code(this._inTag.id))),this._inTag=null):this.maybeName("xml-attribute")||('"'===t||"'"===t?this.readString():this.readTrailingWhitespace()||this.t())}readCloseTag(){let e=this._stream;if(e.lookingAt("</")&&this.NAME.test(e.peek(2))){let t=this.popTag();t&&(t.inner.l2=e.line,t.inner.c2=e.col,this.inline&&(this._inline^=this.inline.code(t.id))),this.pushInParen("</","xml-open-bracket");let i=this.readName();if(this.token(i,t?.id==i.id?"xml-close-tag":"error"),t){let e={line:t.line,c1:t.c1,c2:t.c2,type:t.id,inner:t.inner,outer:t.outer},r={line:i.line,c1:i.c1,c2:i.c2,opened:e};e.closed=r,this.doneParen(e)}return this.pushCont(this.contCloseTag.bind(this,t)),!0}}contCloseTag(e){let t=this._stream,i=t.lookingAt(/^([\s\xA0]*)(>?)/);i&&i[0]?(i[1]&&this.t(null,i[1].length),i[2]&&(this.popInParen("</",1,"xml-close-bracket"),this.popCont(),e&&(e.outer.l2=t.line,e.outer.c2=t.col))):this.readTrailingWhitespace()||this.t("error")}indentation(){let e=this._stream,t=()=>this._stream.buffer.getq("indent_level");if(this._inComment)i=e.lineIndentation(this._inComment.line)+t();else if(this._inTag){var i,r,s=e.lineText(this._inTag.line);i=/^\s*$/.test(s.substr(0,this._inTag.c1-1))?this._inTag.c1+this._inTag.id.length+1:e.lineIndentation(this._inTag.line)}else(r=this._tags.car)&&(i=e.lineIndentation(r.line),/^\s*<\x2f/.test(e.lineText())||(i+=t()));if(null==i){let t=e.line;for(;t>0&&!/\S/.test(e.lineText(t));)t--;i=e.lineIndentation(t)}return i}pushTag(e){this._tags=new o(e,this._tags)}popTag(){let e=this._tags.car;return this._tags=this._tags.cdr,e}get tag(){return this._tags.car}}class tm extends tu{_mode=this;_js=this._tok.getLanguage("js");_css=this._tok.getLanguage("css");get passedParens(){return[...super.passedParens,...this._js.passedParens,...this._css.passedParens]}next(){let e=this._stream;this._mode===this&&this.tag&&("script"==this.tag.id&&(this._mode=this._js),"style"==this.tag.id&&(this._mode=this._css)),this._mode===this._js&&e.lookingAt("</script")&&(this._mode=this),this._mode===this._css&&e.lookingAt("</style")&&(this._mode=this),this._mode===this?super.next():this._mode.next()}copy(){let e=super.copy(),t=this._js.copy(),i=this._css.copy(),r=this._mode;return()=>{let s=e();return s._js=t(),s._css=i(),s._mode=r,s}}indentation(){let e=this._stream;if(this._mode===this||!this._mode._inString&&/^\s*<\//.test(e.lineText())){let t=super.indentation(),i=this._tags.car;if(i){let r=e.lineText(i.outer.l1).substr(0,i.outer.c1);/\S/.test(r)&&(t-=this._stream.buffer.getq("indent_level"))}return t>0?t:0}{let t=this.tag;if(t){let i=e.line;for(;--i>t.line&&!/\S/.test(e.lineText(i)););if(i==t.line)return e.lineIndentation(i)+this._stream.buffer.getq("indent_level")}return this._mode.indentation()}}}let tp=f(`in or and not is defined constant divisible empty
even iterable null true false odd same from as starts with only ends matches`);class tg extends e${STRING=["'",['"','"',"#{","}"]];_blocks=n;_inBlock=null;_alt=this._tok.getLanguage("html");_mode=this._alt;get passedParens(){return[...super.passedParens,...this._alt.passedParens]}copy(){let e=super.copy(),t=this._alt.copy(),i=this._mode,r=this._blocks,s=this._inBlock;return()=>{let n=e();return n._alt=t(),n._mode=i,n._blocks=r,n._inBlock=s,n}}next(){let e=this._stream,t;if(this._mode===this._alt){if(t=e.lookingAt(/^\{%-?/))this._mode=this,this.pushCont(this.readBlock.bind(this,t[0]));else if(t=e.lookingAt(/^\{\{-?/)){this._mode=this,this.pushInParen(t[0],"exp-starter");return}else if(t=e.lookingAt(/^\{#-?/))return this._alt.readCommentMulti(t[0],/^-?#\}/,"#"),this.next()}else if((t=e.lookingAt(/^-?\}\}/))&&/^\{\{/.test(this._inParens.car?.type))return this.popInParen(this._inParens.car?.type,t[0].length,"exp-stopper"),this._mode=this._alt,this.next();this._mode===this?super.next():this._alt.next()}readCustom(){let e=this._stream,t=/\|\s*$/.test(e.textBefore()),i=this.readName();return i?(this.skipWS(),i.type=t||e.lookingAt("(")?"function-name":i.id in tp?"builtin":null,this.token(i),!0):this.readNumber()}readBlock(e){let t=this._stream,i;if(this._inBlock)this.skipWS(),(i=t.lookingAt(/^-?%\}/))?(this.popInParen(e,i[0].length,"block-stopper"),this._mode=this._alt,this.popCont(),this._inBlock.hasBody?(this._inBlock.inner={l1:t.line,c1:t.col},this.pushBlock(this._inBlock)):this._inBlock.outer&&(this._inBlock.outer.l2=t.line,this._inBlock.outer.c2=t.col),this._inBlock=null):this.read();else{let r={l1:t.line,c1:t.col};this.pushInParen(e,"block-starter"),this.skipWS();let s=this.readName();if(s)if(/^end/.test(s.id)){let e=this.popBlock(),t=s.id.substr(3);if(this.token(s,e?.id==t?"keyword":"error"),e){e.inner&&(e.inner.l2=r.l1,e.inner.c2=r.c1);let t={line:e.line,c1:e.c1,c2:e.c2,type:e.id,inner:e.inner,outer:e.outer},i={line:s.line,c1:s.c1,c2:s.c2,opened:t};t.closed=i,this.doneParen(t),this._inBlock=e,delete e.hasBody}if(this.skipWS(),/^(?:macro|block)$/.test(t)){let t=this.readName();t&&this.token(t,t.id==e?.fname?.id?"function-name":"error"),this.skipWS()}}else this.token(s,"keyword"),s.outer=r,this._inBlock=s,this.littleParseTag(s);else(i=t.lookingAt(/^-?%\}/))?(this.popInParen(e,i[0].length,"error"),this._mode=this._alt,this.popCont()):(this.t("error"),this._inBlock={hasBody:!1})}}littleParseTag(e){let t=this._stream;if(e.hasBody=!/^(import|do|from|include|extends|use|else(?:if)?)$/.test(e.id),this.skipWS(),"set"==e.id){for(;this.maybeName("variable-name");)if(this.skipWS(),t.lookingAt(","))t.col++,this.skipWS();else break;this.skipWS(),e.hasBody=t.lookingAt(/^-?%\}/)}else("block"==e.id||"macro"==e.id)&&(e.fname=this.maybeName("function-name"))}indentation(){let e=this._stream;if(this._mode===this)return super.indentation();if(this.block){if(this._mode._inTag)return this._mode.indentation();let t=e.lineIndentation(this.block.line);if(/^\s*\{%-?\s*(?:end|else)/.test(e.lineText()))return t;if(!this._mode.tag||this._mode.tag.line<=this.block.line)return t+this._stream.buffer.getq("indent_level")}return this._mode.indentation()}pushBlock(e){this._blocks=new o(e,this._blocks)}popBlock(){let e=this._blocks.car;return this._blocks=this._blocks.cdr,e}get block(){return this._blocks.car}get tag(){return this._alt.tag}}function tb(e){return"i"==e||"em"==e?1:"b"==e||"strong"==e?2:"a"==e?4:"h1"==e?8:"h2"==e?16:"h3"==e?32:64*("h4"==e)}function tw(e){let t="";return 1&e&&(t+=" italic"),2&e&&(t+=" bold"),4&e&&(t+=" link"),8&e&&(t+=" heading1"),16&e&&(t+=" heading2"),32&e&&(t+=" heading3"),64&e&&(t+=" heading4"),t.trim()||null}eo.define("xml",(e,t)=>new tu({stream:e,tok:t})),eo.define("html",(e,t)=>new tm({stream:e,tok:t,emptyTags:tc,inline:{code:tb,cls:tw}})),eo.define("twig_html",(e,t)=>new tg({stream:e,tok:t})),R.newCommands({xml_limit_fill_paragraph_region:function(){if(!this.tokenizer)return;this.tokenizer.finishParsing();let e=this.tokenizer.getPP().filter(el(this._rowcol,"outer")).findLast(e=>td.test(e.type));if(e){let t={begin:this._rowColToPosition(e.inner.l1,e.inner.c1),end:this._rowColToPosition(e.inner.l2,e.inner.c2)};return this.cmd("save_excursion",()=>{this.cmd("goto_char",t.begin),this.cmd("looking_at",/[^\S\r\n]*\n/gy)&&(this.cmd("goto_char",this.matchData.after),t.begin=this.point()),this.cmd("goto_char",t.end),this.cmd("looking_back",/\n[^\S\r\n]*/g)&&(this.cmd("backward_whitespace"),t.end=this.point())}),t}},xml_close_tag:w(function(){let e=this._rowcol;this.tokenizer.parseUntil(e.row,e.col);let t=this.tokenizer.theParser.tag,i=this.tokenizer.theParser.block,r=()=>{this.cmd("insert",`{% end${i.id} %}`),this.cmd("indent_line")};if(t||i){if(!t&&i)return r();if(!i&&t||0>ea(i,t))return void(this.cmd("insert",`</${t.id}>`),this.cmd("indent_line"));r()}}),xml_slash_complete_tag:w(function(){if(this.cmd("self_insert_command"),this.looking_back("</")){let e=this._rowcol;this.tokenizer.parseUntil(e.row,e.col);let t=this.tokenizer.theParser.tag;t&&(this._placeUndoBoundary(),this.cmd("insert",t.id,">"),this.cmd("indent_line"))}}),xml_gt_complete_tag:w(function(){this.cmd("self_insert_command");let e=this._rowcol;this.tokenizer.parseUntil(e.row,e.col);let t=this.tokenizer.theParser.tag;if(t?.inner?.l1==e.row&&t.inner.c1==e.col){this._placeUndoBoundary();let e=this.point();this.cmd("insert","</",t.id,">"),this.cmd("goto_char",e)}}),xml_newline_and_indent:w(function(){let e=this.looking_at("</")&&this.looking_back(">");this.cmd("newline_and_indent"),e&&(this.cmd("newline_and_indent"),this.cmd("backward_line"),this.cmd("indent_line"))}),twig_insert_percent:w(function(){this.cmd("self_insert_command");let e=this._rowcol;this.tokenizer.parseUntil(e.row,e.col),this.tokenizer.theParser._mode instanceof tg&&this.looking_back("{%")&&(this._placeUndoBoundary(),this.cmd("insert","  %"),this.cmd("backward_char",2))}),twig_block_toggle_whitespace:w(function(){this.tokenizer.finishParsing();let e=this.tokenizer.getPP().filter(el(this._rowcol)).filter(e=>/^\{[{%#]/.test(e.type)).at(-1);if(e?.closed){let t=()=>{this.looking_back("-")?this.cmd("backward_delete_char"):this.cmd("insert","-")},i=()=>{this.looking_at("-")?this.cmd("delete_char"):this.cmd("insert","-")};this.cmd("save_excursion",()=>{this.cmd("goto_char",this._rowColToPosition(e.closed.line,e.closed.c1)),i(),this.cmd("goto_char",this._rowColToPosition(e.line,e.c2)),t()})}})});let tk=g.define("xml_zen",{Tab:"xml_zen_next_poi","S-Tab":"xml_zen_prev_poi","C-g":"xml_zen_stop"});function ty(){var e=this.point(),t=this.getq("xml_zen_markers"),i=t[0],r=t.at(-1);(e<i.getPosition()||e>r.getPosition()||r.getPosition()==t.at(-2).getPosition())&&this.cmd("xml_zen_stop")}R.newCommands({xml_zen_expand:w(function(){this.cmd("xml_zen_stop");var e="",t=this.cmd("save_excursion",function(){for(this.cmd("backward_whitespace");!this.cmd("looking_back",/[\x20\xa0\s\t\n;&]/g)&&this.cmd("backward_char"););return this.point()}),i=this.point();try{!function e(t,i){for(var r=t.repeat||1,s=1;s<=r;++s)s>1&&i("\n"),i("<",t.type),t.id&&i(' id="',t.id.replace(/\$/g,s),'"'),t.klass&&i(' class="',t.klass.replace(/\$/g,s),'"'),t.attributes&&t.attributes.forEach(e=>i(" ",e,'="|"')),i(">"),t.child?(i("\n"),e(t.child,i),i("\n")):i("|"),i("</",t.type,">"),t.next&&(i("\n"),e(t.next,i))}(function e(t,i){var r={type:""},s=1;t:for(;i<t.length;){var n=t.charAt(i++);switch(n){case"#":s=3,r.id="";break;case".":s=2,null!=r.klass?r.klass+=" ":r.klass="";break;case":":s=5,null==r.attributes&&(r.attributes=[]),r.attributes.push("");break;case"*":s=4,r.repeat="";break;case">":r.child=e(t,i),i=r.child.i;break t;case"(":r.child=e(t,i),i=r.child.i;break;case")":break t;case"+":r.next=e(t,i),i=r.next.i;break t;default:switch(s){case 1:r.type+=n;break;case 2:r.klass+=n;break;case 3:r.id+=n;break;case 4:r.repeat=parseInt(String(r.repeat)+n,10);break;case 5:r.attributes.push(r.attributes.pop()+n)}}}return r.i=i,r}(this.cmd("buffer_substring",t,i).trim(),0),(...t)=>e+=t.join(""))}catch(e){throw new b("The Zen is not strong today :-/")}this.cmd("delete_region",t,i),this.cmd("insert",e),t=this.createMarker(t,!1,"xml_zen");var r=this.createMarker(this.point(),!0,"xml_zen"),s=[];for(this.cmd("goto_char",t.getPosition());this.cmd("search_forward","|",r.getPosition());)this.cmd("backward_delete_char"),s.push(this.createMarker(this.point(),!0,"xml_zen_start")),s.push(this.createMarker(this.point(),!1,"xml_zen_end"));this.cmd("indent_region",t.getPosition(),r.getPosition()),s.length>0?(this.cmd("goto_char",s[0]),s.unshift(t),s.push(r),this.setq("xml_zen_markers",s),this.pushKeymap(tk),this.addEventListener("afterInteractiveCommand",ty)):(t.destroy(),r.destroy())}),xml_zen_stop:w(function(){var e=this.getq("xml_zen_markers");e&&(e.map(e=>e.destroy()),this.setq("xml_zen_markers",null)),this.popKeymap(tk),this.removeEventListener("afterInteractiveCommand",ty)}),xml_zen_next_poi:w(function(){let e=this.getq("xml_zen_markers"),t=this.point();for(let i=0;i<e.length;++i){let r=e[i];if(r.getPosition()>t){this.cmd("goto_char",r.getPosition());break}}}),xml_zen_prev_poi:w(function(){let e=this.getq("xml_zen_markers"),t=this.point();for(let i=e.length;--i>=0;){let r=e[i];if(r.getPosition()<t){this.cmd("goto_char",r.getPosition());break}}})});export{ee as Ymacs,R as Ymacs_Buffer,g as Ymacs_Keymap,S as Ymacs_Keymap_Emacs,eo as Ymacs_Tokenizer,w as Ymacs_Interactive,b as Ymacs_Exception,e6 as Ymacs_Lang_Lisp};
//# sourceMappingURL=ymacs.mjs.map
