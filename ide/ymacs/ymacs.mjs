let e,t=document.createElement("template"),i={fromHTML(e){t.innerHTML=e.trim();let i=t.content;return i.children.length>1?i:i.children[0]},addClass(e,t){e.classList.add(t)},delClass(e,t){t instanceof RegExp?e.className=e.className.replace(t,""):e.classList.remove(t)},hasClass:(e,t)=>e.classList.contains(t),condClass(e,t,i,n){e.classList.toggle(i,!!t),n&&e.classList.toggle(n,!t)},toggleClass(e,...t){e.classList.toggle(...t)},trash(e){e&&e.remove()},on(e,t,n,r){"string"==typeof t?e.addEventListener(t,n,r||{}):Object.keys(t).forEach(r=>i.on(e,r,t[r],n||{}))},off(e,t,n,r){"string"==typeof t?e.removeEventListener(t,n,r||{}):Object.keys(t).forEach(r=>i.off(e,r,t[r],n||{}))},overlayOn:t=>(document.body.appendChild(e),t&&(e.className=t),e),overlayOff(){e.remove()},mousePos(e,t){let i=t.getBoundingClientRect();return{x:e.clientX-i.left,y:e.clientY-i.top}},htmlEscape:function(e){return(e+"").replace(/&/g,"&amp;").replace(/\x22/g,"&quot;").replace(/\x27/g,"&#x27;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u00A0/g,"&#xa0;")}};e=i.fromHTML('<div style="position: fixed; z-index: 20000; left: 0; top: 0; right: 0; bottom: 0"></div>');class n{constructor(e){this._ev_handlers=Object.create(null),this.o=Object.assign(Object.create(this.constructor.options||null),e)}addEventListener(e,t){if("string"==typeof e){let i=this._getHandlers(e);s(i,t),i.push(t)}else Object.keys(e).forEach(t=>this.addEventListener(t,e[t]))}removeEventListener(e,t){"string"==typeof e?s(this._getHandlers(e),t):Object.keys(e).forEach(t=>this.removeEventListener(t,e[t]))}listenOnce(e,t){this.addEventListener(e,function i(...n){return this.removeEventListener(e,i),t.apply(this,n)})}callHooks(e,...t){this._getHandlers(e).forEach(e=>e.apply(this,t))}destroy(){this.callHooks("onDestroy")}_getHandlers(e){return this._ev_handlers[e]||(this._ev_handlers[e]=[])}}class r extends n{constructor(...e){super(...e),this.createElement()}createElement(){let e=document.createElement("div");return e.className=this.initClassName(),e._ymacs_object=this,this.el=e,e}initClassName(){return this.constructor.name}getContentElement(){return this.el}getElement(){return this.el}add(e){e instanceof r&&(e=e.getElement()),this.getContentElement().appendChild(e)}addClass(e){i.addClass(this.getElement(),e)}delClass(e){i.delClass(this.getElement(),e)}hasClass(e){return i.hasClass(this.getElement(),e)}condClass(e,t,n){i.condClass(this.getElement(),e,t,n)}toggleClass(...e){i.toggleClass(this.getElement(),...e)}setContent(e){this.getContentElement().innerHTML=e}setStyle(e,t){let i=this.getElement().style;"string"==typeof e?i[e]=t:Object.assign(i,e)}getBox(){return this.getElement().getBoundingClientRect()}destroy(){i.trash(this.getElement()),super.destroy(...arguments)}}function s(e,t){let i=0;for(;(i=e.indexOf(t,i))>=0;)e.splice(i,1)}function o(e,t=0,i,...n){arguments.length>2&&(e=e.bind(i,...n));let r=null;return function(){clearTimeout(r),r=setTimeout(e,t)}}function a(e,t){var i,n,r=e;return(r<1024?i="B":r<1048576?(r/=1024,i="K"):r<1073741824?(r/=1048576,i="M"):r<1099511627776&&(r/=1073741824,i="G"),n=Math.round(r),t&&r!=n)?r.toFixed(t)+i:n+i}function l(e){switch(e.length){case 0:return"";case 1:return e[0];case 2:let t=e[0],i=e[1],n=Math.min(t.length,i.length),r=0;for(;r<n&&t.charAt(r)===i.charAt(r);)++r;return t.substring(0,r);default:return l([e[0],l(e.slice(1))])}}class c{constructor({pos:e=null,editor:t=null,before:i=!1,name:n=null}={}){this.position=e,this.editor=t,this.before=i,this.name=n,this.editor.markers.push(this),this.rowcol=null,this.onChange=[]}destroy(){s(this.editor.markers,this),this.editor=null}editorChange(e,t,i){var n=this.position;this.before&&--n,0!=t&&e<=n&&(this.rowcol=null,this.position+=t,this.position<i&&(this.position=i),this.callHooks(this.onChange,this.position))}callHooks(e,t){for(var i=e.length;--i>=0;)e[i].call(this.editor,t)}getPosition(){return this.position}valueOf(){return this.position}setPosition(e,t,i){(i||this.position!=e)&&(this.rowcol=null,this.position=e,t||this.callHooks(this.onChange,this.position))}getRowCol(){return this.rowcol||(this.rowcol=this.editor._positionToRowCol(this.position))}swap(e,t,i){var n=this.getPosition();this.setPosition(e.getPosition(),t,i),e.setPosition(n,t,i)}}let h=Object.create(null);class f{constructor(e){this.definitions=Object.create(null),this.defineKeys(e)}static define(e,t){let i=e&&h[e];return!i&&(i=t instanceof this?t:new this(t),e&&(h[e]=i)),i}static get(e){return h[e]}static parseKey(e){var t={},i=e.split(/-/);i.reverse(),i.forEach((e,i)=>{if(0==i)t.key="Space"==e?" ":1==e.length?e.toLowerCase():e;else switch(e){case"C":t.ctrlKey=!0;break;case"M":t.metaKey=!0;break;case"S":t.shiftKey=!0}}),i.reverse();var n=i.pop();return t.str=i.sort().join("-"),t.str&&(t.str+="-"),t.str+=n,t}static unparseKey(e){var t,i=[];return"wheelDelta"in e?t=e.wheelDelta>0?"WheelUp":"WheelDown":(" "==(t=e.key)&&(t="Space"),1==t.length&&(t=t.toLowerCase())),e.ctrlKey&&i.push("C"),(e.altKey||e.ymacsMeta)&&i.push("M"),e.shiftKey&&(t.length>1||t.toLowerCase()!=t.toUpperCase())&&i.push("S"),i.sort(),i.push(t),i.join("-")}defineKey(e,t,i){if(t instanceof Array&&(i=t.slice(1),t=t[0]),(e=e.trim().split(/\s*&&\s*/)).length>1)e.forEach(e=>this.defineKey(e,t,i));else{e=e[0].trim();var n=this.definitions;if(e.indexOf(" ")>=0){var r=e.split(/\s+/);e=r.pop(),r.forEach(e=>{n[e=this.parseKey(e).str]||(n[e]={}),n=n[e]})}n[(e=this.parseKey(e)).str]=[t,i]}}defineKeys(e){Object.keys(e).forEach(t=>this.defineKey(t,e[t]))}getHandler(e){let t=null,i=this.definitions;for(let n of e){let e=t?t[n]:i[n];if(e){if(Array.isArray(t=e))break}else{t=null;break}}return t}attached(){}detached(){}}function u(e){this.message=e}function d(e,t){if(1==arguments.length)t=e,e=null;else{let e;t instanceof Function||(e=t,t=arguments[2],t.ymacsDoc=e)}if(t.ymacsInteractive=!0,null!=e){if(!Array.isArray(e)){var i=/^[\^\@\*]+/.exec(e);i&&(i=i[0],e=e.substr(i.length),i.indexOf("^")>=0&&(t.ymacsMarkExtend=!0),i.indexOf("*")>=0&&(t.ymacsWarnReadonly=!0),i.indexOf("@")>=0&&(t.ymacsSelectFrame=!0)),e&&(e=e.split(/\n+/))}if(e){let i;let n=function(...e){return i=i.concat(e),this.callInteractively(t,i,!0)};for(;e.length>0;){let t=n;n=function(e,t){let i=w[e.charAt(0)];return e=e.substr(1),function(){return i.call(this,e,t)}}(e.pop(),function(...e){return i=i.concat(e),t.call(this)})}t.ymacsCallInteractively=function(){return i=[],n.call(this)}}}return t}function _(e){return d("p",function(t){for(null==t&&(t=1);t-- >0;)e.call(this)})}f.prototype.parseKey=f.parseKey;var p=function(){};function m(e){var t=this.getPrefixArg(!0);return t&&(e=t+" "+e),this.cmd("minibuffer_prompt",e)}function g(e,t){return m.call(this,e),this.cmd("minibuffer_read_string",null,t)}function b(e,t){return m.call(this,e),this.cmd("minibuffer_read_number",t)}p.toString=function(){return""},p.empty=!0;var w={a:function(e,t){return console.log("read_function_name",e),m.call(this,e),this.cmd("minibuffer_read_function",t)},b:function(e,t){return m.call(this,e),this.cmd("minibuffer_read_buffer",t)},B:function(e,t){return m.call(this,e),this.cmd("minibuffer_read_buffer",t)},c:function(e,t){},C:function(e,t){return m.call(this,e),this.cmd("minibuffer_read_command",t)},d:function(e,t){return t.call(this,this.point())},e:function(e,t){},i:function(e,t){return t.call(this,null)},k:function(e,t){},K:function(e,t){},m:function(e,t){return t.call(this,this.markMarker.getPosition())},M:g,n:b,N:function(e,t){var i=parseInt(this.getPrefixArg(),10);return isNaN(i)?b.call(this,e,t):t.call(this,i)},p:function(e,t){var i=parseInt(this.getPrefixArg(),10);return isNaN(i)&&(i=null),t.call(this,i)},P:function(e,t){return""===(e=this.getPrefixArg())&&(e=p),t.call(this,e)},r:function(e,t){var i=this.getRegion();return t.call(this,i.begin,i.end)},s:g,U:function(e,t){},v:function(e,t){return m.call(this,e),this.cmd("minibuffer_read_variable",t)},f:function(e,t){return m.call(this,e),this.cmd("minibuffer_read_existing_file",t)},F:function(e,t){return m.call(this,e),this.cmd("minibuffer_read_file",t)},G:function(e,t){return m.call(this,e),this.cmd("minibuffer_read_file_or_directory",t)},D:function(e,t){return m.call(this,e),this.cmd("minibuffer_read_directory",t)}};let v={"ArrowLeft   && C-b":"backward_char","ArrowRight  && C-f":"forward_char",Home:"beginning_of_indentation_or_line","End && C-e":"end_of_line","C-a":"beginning_of_line","C-Home && M-<":"beginning_of_buffer","C-End && M->":"end_of_buffer","C-ArrowRight && M-f":"forward_word","C-ArrowLeft && M-b":"backward_word","S-ArrowLeft     && S-C-b":"backward_char_mark","S-ArrowRight    && S-C-f":"forward_char_mark","S-C-ArrowRight  && S-M-f":"forward_word_mark","S-C-ArrowLeft   && S-M-b":"backward_word_mark","S-Home":"beginning_of_indentation_or_line_mark","S-C-a":"beginning_of_line_mark","S-End && S-C-e":"end_of_line_mark","S-C-Home":"beginning_of_buffer_mark","S-C-End":"end_of_buffer_mark",Backspace:"backward_delete_char","Delete && C-d":"delete_char","M-d && C-Delete":"kill_word","C-Backspace && M-Backspace && M-Delete":"backward_kill_word","C-k":"kill_line","C-y && S-Insert":"yank","M-y":"yank_pop","C-Space":"set_mark_command","C-x C-x":"exchange_point_and_mark","C-w":"kill_region","M-t":"transpose_words","C-t":"transpose_chars","M-w":"copy_region_as_kill","M-c":"capitalize_word","M-u":"upcase_word","M-l":"downcase_word",F11:"nuke_trailing_whitespace","C-/ && C-x u && C-_ && C-z":"undo",Insert:"overwrite_mode","M-/":"dabbrev_expand","C-g":"keyboard_quit",Escape:"keyboard_quit","C-S-y && C-v":"yank_from_operating_system","M-S-w":"copy_for_operating_system","C-c /":"close_last_xml_tag","S-Backspace":"backward_delete_whitespace","S-Delete":"delete_whitespace","C-x =":"what_cursor_position"},y=Object.assign({},v,{"ArrowUp     && C-p":"backward_line","ArrowDown   && C-n":"forward_line","ArrowLeft   && C-b":"backward_char","ArrowRight  && C-f":"forward_char",Home:"beginning_of_indentation_or_line","End && C-e":"end_of_line","C-a":"beginning_of_line","C-Home && M-<":"beginning_of_buffer","C-End && M->":"end_of_buffer","C-ArrowRight && M-f":"forward_word","C-ArrowLeft && M-b":"backward_word","C-ArrowDown":"forward_paragraph","C-ArrowUp":"backward_paragraph","M-h":"mark_paragraph","C-l":"recenter_top_bottom",PageUp:"scroll_up_half",PageDown:"scroll_down_half",WheelUp:"scroll_up",WheelDown:"scroll_down","S-ArrowUp       && S-C-p":"backward_line_mark","S-ArrowDown     && S-C-n":"forward_line_mark","S-ArrowLeft     && S-C-b":"backward_char_mark","S-ArrowRight    && S-C-f":"forward_char_mark","S-C-ArrowRight  && S-M-f":"forward_word_mark","S-C-ArrowLeft   && S-M-b":"backward_word_mark","S-C-ArrowDown":"forward_paragraph_mark","S-C-ArrowUp":"backward_paragraph_mark","S-Home":"beginning_of_indentation_or_line_mark","S-C-a":"beginning_of_line_mark","S-End && S-C-e":"end_of_line_mark","S-C-Home":"beginning_of_buffer_mark","S-C-End":"end_of_buffer_mark",Backspace:"backward_delete_char","Delete && C-d":"delete_char","Enter && C-m":"newline","M-d && C-Delete":"kill_word","C-Backspace && M-Backspace && M-Delete":"backward_kill_word","C-k":"kill_line","C-y && S-Insert":"yank","M-y":"yank_pop","C-Space":"set_mark_command","C-x C-x":"exchange_point_and_mark","C-w":"kill_region","M-t":"transpose_words","C-t":"transpose_chars","C-x C-t":"transpose_lines","M-w":"copy_region_as_kill","M-c":"capitalize_word","M-u":"upcase_word","M-l":"downcase_word",F11:"nuke_trailing_whitespace",Tab:"indent_line","C-M-\\":"indent_region","M-q":"fill_paragraph","C-/ && C-x u && C-_ && C-z":"undo",Insert:"overwrite_mode","M-s":"center_line","M-/":"dabbrev_expand","C-s":"isearch_forward","C-r":"isearch_backward","C-S-s":"isearch_yank_word_or_char","M-C-s":"isearch_forward_regexp","M-C-r":"isearch_backward_regexp","M-%":"query_replace","C-M-%":"query_replace_regexp","C-u":"universal_argument","M-g":"goto_line","C-x h":"mark_whole_buffer","C-g":"keyboard_quit","M-^":"delete_indentation","M-;":"comment_dwim","C-x =":"what_cursor_position","C-x f":"set_fill_column","C-x r t":"string_rectangle","C-x r c":"clear_rectangle","C-x r k":"kill_rectangle","C-x r y":"yank_rectangle","C-x C-ArrowRight && C-x ArrowRight && C-Tab":"next_buffer","C-x C-ArrowLeft && C-x ArrowLeft && C-S-Tab":"previous_buffer","C-x b":"switch_to_buffer","C-x k":"kill_buffer","C-x 0":"delete_frame","C-x 1":"delete_other_frames","C-x 2":"split_frame_vertically","C-x 3":"split_frame_horizontally","C-x o":"other_frame","C-x l":"toggle_line_numbers","M-x":"execute_extended_command","C-S-y && C-v":"yank_from_operating_system","M-S-w":"copy_for_operating_system","M-S-y":"yank_shift","C-c /":"close_last_xml_tag","S-Backspace":"backward_delete_whitespace","S-Delete":"delete_whitespace","C-M-d":"delete_region_or_line","M-Enter":"start_next_paragraph","C-M-|":"cperl_lineup","C-F4":"kill_buffer","M-ArrowLeft":["windmove","left"],"M-ArrowRight":["windmove","right"],"M-ArrowUp":["windmove","up"],"M-ArrowDown":["windmove","down"],"C-x e":"kmacro_end_and_call_macro","C-x (":"kmacro_start_macro","C-x )":"kmacro_end_macro","C-x C-f":"find_file","C-x C-w":"write_file","C-x C-s":"save_buffer","C-x s":"save_some_buffers"}),k=f.define("emacs_mb",v);k.defaultHandler=["self_insert_command"];let x=f.define("emacs",y);x.defaultHandler=["self_insert_command"];let C=f.define("universal_arg",{});C.defaultHandler=[d("^",function(){var e=this.interactiveEvent(),t=e.key,i=this.getPrefixArg(!0);return!/^[0-9]$/.test(t)&&("-"!==t||""!==i)||e.altKey||e.ctrlKey?(this.popKeymap(C),!1):(i+=t,this.setPrefixArg(i),this.isMinibuffer||this.whenMinibuffer(function(e){e.cmd("insert"," ",t)}),!0)})],C.attached=e=>e.setPrefixArg("");class M extends n{constructor({buffer:e}){super(...arguments),this.buffer=e,this.reset()}reset(){this.props=[]}insertLine(e){this.props.length<e?this.props[e]=null:this.props.splice(e,0,null)}deleteLine(e){this.props.splice(e,1)}replaceLine(e,t){var i=this.props[e];i&&i.length>t.length&&i.splice(t.length)}addLineProps(e,t,i,n,r){var s,o=this.props,a=!1;if(t<i){for(o=o[e]||(o[e]=[]);t<i;)(s=o[t]||(o[t]={}))[n]!=r&&(a=!0),s[n]=r,++t;a&&this.callHooks("onChange",e)}return a}removeLineProps(e,t,i,n){var r,s=this.props[e],o=!1;if(s&&t<i){for(;t<i;)(r=s[t])&&n in r&&(o=!0,delete r[n]),++t;o&&this.callHooks("onChange",e)}return o}spliceLineProps(e,t,i){let n=this.props[e];n&&(i>0?n.splice(t,0,...Array(i)):i<0&&n.splice(t,-i))}getLineHTML(e,t,n){var r=this.props[e];if(null===n){if(""==t)return"<br/>";if(!r||0==r.length)return i.htmlEscape(t)}else{if(""==t)return"<span class='Ymacs-caret'>&nbsp;</span>";if(!r||0==r.length)return n===t.length?i.htmlEscape(t)+"<span class='Ymacs-caret'>&nbsp;</span>":i.htmlEscape(t.substr(0,n))+"<span class='Ymacs-caret'>"+i.htmlEscape(t.charAt(n))+"</span>"+i.htmlEscape(t.substr(n+1))}for(var s,o,a=0,l=t.length,c=null,h="";a<l;){switch(s=(s=r[a])&&s.css,a===n&&(s=s?s+" Ymacs-caret":"Ymacs-caret"),s&&s!=c?(c&&(h+="</span>"),h+="<span class='"+s+"'>"):!s&&c&&(h+="</span>"),c=s,o=t.charAt(a)){case"<":h+="&lt;";break;case">":h+="&gt;";break;case"&":h+="&amp;";break;default:h+=o}++a}return c&&(h+="</span>"),a===n&&(h+="<span class='Ymacs-caret'>&nbsp;</span>"),h}}let T={case_fold_search:null,case_replace:!0,line_movement_requested_col:0,fill_column:78,tab_width:8,indent_level:4,sticky_mark:!1,syntax_word:/^[\p{N}\p{L}]$/u,syntax_capitalize_word:/([\p{N}\p{L}])([\p{N}\p{L}]*)/ug,syntax_word_dabbrev:/^[\p{N}_$\p{L}]$/u,syntax_word_sexp:/^[\p{N}_$\p{L}]$/u,syntax_paragraph_sep:/\n(?:[^\S\r\n]*\n)+/g};function E(e,t){if("string"==typeof e)return void 0===t?delete this[e]:this[e]=t,t instanceof Function&&(t.ymacsCommand=e),t;var i=Object.create(null);for(var n in e)i[n]=this[n],E.call(this,n,e[n]);return i}function L(e){return e instanceof c?e.getPosition():e}class A extends n{static options={name:"*scratch*",code:"",ymacs:null,tokenizer:null};static COMMANDS=Object.create(null);static newCommands(...e){return E.apply(this.COMMANDS,e)}static replaceCommands(e){this.COMMANDS=Object.assign(Object.create(null),this.COMMANDS);let t=Object.create(null);return Object.keys(e).forEach(i=>{let n=e[i];"string"==typeof n&&(n=this.COMMANDS[n]),t[i]=n}),this.newCommands(t)}static newMode(e,t){let i="*"+e+"*",n=i+"hooks";A.setGlobal(n,[]),this.COMMANDS[e]=d("P",function(r){let o=this.getq(i);if(o)!0!==r&&(this.getq(n).forEach(e=>e.call(this,!1)),o instanceof Function&&o.call(this),this.setq(i,null),s(this.modes,e));else if(!1!==r){let r=t.apply(this,arguments);r instanceof Function||(r=!0),this.setq(i,r),this.modes.push(e),this.getq(n).forEach(e=>e.call(this,!0))}return o})}static getVariable(e){return T[e]}static setVariable(){return E.apply(T,arguments)}constructor(...e){super(...e),this.isMinibuffer=this instanceof P,this.COMMANDS=Object.assign(Object.create(null),this.COMMANDS),this.name=this.o.name,this.ymacs=this.o.ymacs,this.tokenizer=this.o.tokenizer,this.__savingExcursion=0,this.__preventUpdates=0,this.__preventUndo=0,this.__undoInProgress=0,this.__dirtyLines=[],this.__undoQueue=[],this.__undoPointer=0,this.markers=[],this.caretMarker=this.createMarker(0,!1,"point"),this.markMarker=this.createMarker(0,!0,"mark"),this.matchData=[],this.previousCommand=null,this.currentCommand=null,this.currentKeys=[],this.progress=Object.create(null),this.variables=Object.create(null),this.globalVariables=T,this.modes=[],this.caretMarker.onChange.push(function(e){this._rowcol=this.caretMarker.getRowCol(),this.__preventUpdates||this.callHooks("onPointChange",this._rowcol,this.point())}),this._tokenizerEvents={onFoundToken:this._on_tokenizerFoundToken.bind(this)},this._textProperties=new M({buffer:this}),this._textProperties.addEventListener("onChange",this._on_textPropertiesChange.bind(this)),this.keymap=[],this.pushKeymap(this.makeDefaultKeymap()),this.setCode(this.o.code),this._lastCommandWasKill=0}addModeHook(e,t){"string"==typeof t&&(t=this.COMMANDS[t]),this.getq("*"+e+"*hooks").pushUnique(t)}removeModeHook(e,t){"string"==typeof t&&(t=this.COMMANDS[t]),s(this.getq("*"+e+"*hooks"),t)}withVariables(e,t){var i=this.variables;this.variables=Object.assign(Object.create(this.variables),e);try{if(t instanceof Function)return t.apply(this,[...arguments].slice(2));return this.cmdApply(t,[...arguments].slice(2))}finally{this.variables=i}}withCommands(e,t){var i=this.COMMANDS;this.COMMANDS=Object.assign(Object.create(this.COMMANDS),e);try{if(t instanceof Function)return t.apply(this,[...arguments].slice(2));return this.cmdApply(t,[...arguments].slice(2))}finally{this.COMMANDS=i}}getVariable(e){return e in this.variables?this.variables[e]:T[e]}setVariable(){return E.apply(this.variables,arguments)}lastIndexOfRegexp(e,t,i,n=0){let r;for(t.global||(t=RegExp(t.source,t.flags+"g")),t.lastIndex=n;;){let n=t.lastIndex,s=t.exec(e);if(!s||t.lastIndex>i)break;if((r=s).after=t.lastIndex,t.lastIndex<=n){let i=/[^]/ug;i.lastIndex=t.lastIndex,i.exec(e),t.lastIndex=i.lastIndex}}if(r)return this.matchData=r}pushKeymap(e){e instanceof Array?e.forEach(this.pushKeymap,this):(this.popKeymap(e),this.keymap.push(e),e.attached(this))}popKeymap(e){s(this.keymap,e),e.detached(this)}makeDefaultKeymap(){return this.isMinibuffer?k:x}signalError(e,t,i){this.ymacs.indicateError(),this.callHooks("onMessage",{type:"error",text:e,isHtml:t,timeout:i})}signalInfo(e,t,i){this.callHooks("onMessage",{type:"info",text:e,isHtml:t,timeout:i})}popupMessage(e){this.callHooks("onMessage",e)}createMarker(e,t,i){return null==e&&(e=this.point()),new c({editor:this,pos:e,name:i,before:t})}point(){return this.caretMarker.getPosition()}dirty(e){return arguments.length>0&&(this.__isDirty=e,this.__undoQueue.forEach(e=>{3!==e.type&&(e.dirty=!0)}),this.updateModeline()),this.__isDirty}setCode(e){this.__isDirty=!1,this.__code=e,this.__size=e.length,this.__undoQueue=[],this.__undoPointer=0,this.markers.map(e=>e.setPosition(0,!0,!0)),this.code=e.split(/\n/),this._textProperties.reset(),this.tokenizer&&this.tokenizer.reset(),this.callHooks("onResetCode",this.code),this.caretMarker.setPosition(0,!1,!0),this.markMarker.setPosition(0,!0),this.forAllFrames(e=>{e.ensureCaretVisible(),e.redrawModelineWithTimer()})}setTokenizer(e){null!=this.tokenizer&&this.tokenizer.removeEventListener(this._tokenizerEvents),this.tokenizer=e,e?(e.addEventListener(this._tokenizerEvents),e.reset()):(this._textProperties.reset(),this.callHooks("onResetCode",this.code))}getCode(){return this.__code||(this.__code=this.code.join("\n"))}getCodeSize(){if(this.__size)return this.__size;for(var e=this.code.length,t=e>0?-1:0;--e>=0;)t+=this.code[e].length+1;return this.__size=t}getLine(e){return null==e&&(e=this._rowcol.row),this.code[e]}charAtRowCol(e,t){let i=this.code.length;if(e>=i--)return null;var n=this.code[e];return t==n.length?e==i?null:"\n":n.charAt(t)}charAt(e){null==e?e=this.point():(e=L(e))<0&&(e+=this.point());var t=this._positionToRowCol(e);return this.charAtRowCol(t.row,t.col)}callInteractively(e,t,i){var n;if(t||(t=[]),e instanceof Function?n=e.ymacsCommand||null:(n=e,e=this.COMMANDS[e]),e.ymacsCallInteractively&&!i)return e.ymacsCallInteractively.apply(this,t);this.currentCommand=n,this.previousCommand!=n?(this.sameCommandCount(0),"undo"!=n&&this._placeUndoBoundary()):("self_insert_command"!=n||this.sameCommandCount()%20==0)&&"undo"!=n&&this._placeUndoBoundary(),this.preventUpdates();try{return this.callHooks("beforeInteractiveCommand",n,e),e.ymacsMarkExtend||this.getq("sticky_mark")||this.clearTransientMark(),e.apply(this,t)}catch(e){if(e instanceof u)this.signalError(e.message);else throw e}finally{this.getq("sticky_mark")&&this.ensureTransientMark(),"undo"!=n&&(this.__undoPointer=this.__undoQueue.length),this.resumeUpdates(),this.callHooks("afterInteractiveCommand",n,e),this.previousCommand=n,this.sameCommandCount(1),this.tokenizer&&this.tokenizer.start()}}resetOverwriteMode(e){0==arguments.length&&(e=this.overwriteMode),this.callHooks("onOverwriteMode",this.overwriteMode=!e),this.signalInfo(e?"Insert mode":"Overwrite mode")}getMinibuffer(){return this.whenYmacs(function(e){return e.minibuffer})}getMinibufferFrame(){return this.whenYmacs(function(e){return e.minibuffer_frame})}setMinibuffer(e){this.whenMinibuffer(function(t){t.setCode(e),t.cmd("end_of_buffer")})}cmd(e,...t){return this.COMMANDS[e].apply(this,t)}cmdApply(e,t){return this.COMMANDS[e].apply(this,t)}forEachLine(e,t=this.markMarker(),i=this.point()){if(t=L(t),(i=L(i))<t){let e=t;t=i,i=e}t=this._positionToRowCol(t),i=this._positionToRowCol(i);for(let n=t.row;n<=i.row;++n){let r=n==t.row?t.col:0,s=n==i.row?i.col:this.getLine(n).length;e(n,r,s)}}getActiveFrame(){return this.whenYmacs("getActiveFrame")}when(e,t,...i){if(null!=(e=this[e]||this.getq(e)))return t instanceof Function?t.call(this,e):e[t].apply(e,i)}whenActiveFrame(){var e=this.getActiveFrame();if(e.buffer===this){this.activeFrame=e;var t=["activeFrame",...arguments];return this.when.apply(this,t)}this.activeFrame=null}forAllFrames(e){this.ymacs&&this.ymacs.getBufferFrames(this).forEach(e)}whenYmacs(){var e=["ymacs",...arguments];return this.when.apply(this,e)}whenMinibuffer(e){return this.whenYmacs(function(t){if(t.minibuffer)return e.call(this,t.minibuffer)})}withMarkers(e,...t){let i=t.map(e=>this.createMarker(e));try{return e.apply(this,i)}finally{i.forEach(e=>e.destroy())}}preventUpdates(){++this.__preventUpdates}resumeUpdates(){0==(this.__preventUpdates=Math.max(this.__preventUpdates-1,0))&&this.redrawDirtyLines()}getRegion(e=this.caretMarker,t=this.markMarker){if(e=L(e),(t=L(t))<e){var i=e;e=t,t=i}return{begin:e,end:t}}redrawDirtyLines(){this.callHooks("beforeRedraw"),this.__dirtyLines.forEach((e,t)=>{e&&this.callHooks("onLineChange",t)}),this.__dirtyLines=[],this.callHooks("afterRedraw")}setOverlay(e,t){this.callHooks("onOverlayChange",e,t)}deleteOverlay(e){this.callHooks("onOverlayDelete",e)}setMark(e=this.point()){this.markMarker.setPosition(e)}ensureTransientMark(){var e,t=this._rowcol;this.transientMarker||(this.transientMarker=this.createMarker(),this.markMarker.setPosition(this.point()),e=t),e||(e=this.transientMarker.getRowCol()),this.setOverlay("selection",{line1:e.row,col1:e.col,line2:t.row,col2:t.col})}clearTransientMark(){this.transientMarker&&(this.transientMarker.destroy(),this.transientMarker=null,this.deleteOverlay("selection"),this.setq("sticky_mark",!1))}deleteTransientRegion(){if(this.transientMarker)return this._deleteText(this.caretMarker,this.transientMarker),this.clearTransientMark(),this._placeUndoBoundary(),!0}static #e=0;sameCommandCount(e){return null==e?A.#e:0==e?A.#e=0:A.#e+=e}static #t=null;interactiveEvent(e){return 0==arguments.length?A.#t:A.#t=e}getPrefixArg(e){var t=this.getq("universal_prefix");return e||void 0===t||(this.setq("universal_prefix",void 0),this.isMinibuffer||this.setMinibuffer("")),t}setPrefixArg(e){return this.setq("universal_prefix",e)}updateProgress(e,t){null==t?delete this.progress[e]:this.progress[e]=t,this.callHooks("onProgressChange")}updateModeline(){this.callHooks("onProgressChange")}renderModelineContent(e,t){var n=(this.__isDirty?"**":"--")+` <span class="mode-line-buffer-id">${i.htmlEscape(this.name)}</span>`+"  "+t+" of "+a(this.getCodeSize(),2).toLowerCase()+"  ("+(e.row+1)+","+e.col+") ",r=this.getq("modeline_custom_handler");r&&(r=r.call(this,this,e))&&(n+="["+r+"] ");var s=[];for(var o in this.progress)s.push(o+": "+this.progress[o]);return s.length>0&&(n+="{"+s.join(", ")+"}"),n}_recordChange(e,t,i,n){if(i>0){var r=this.__undoQueue;r.push({type:e,pos:t,len:i,text:n,dirty:this.__isDirty}),this.__isDirty=!0,r.length>5e4&&r.shift()}}_placeUndoBoundary(){var e=this.__undoQueue,t=this.markers.map(e=>[e,e.getPosition()]),i=e.at(-1);i&&3==i.type?i.markers=t:e.push({type:3,markers:t})}_playbackUndo(){var e=this.__undoQueue;if(0==e.length)return!1;++this.__undoInProgress;for(var t,i=!1;--this.__undoPointer>=0;){if(3==(t=e[this.__undoPointer]).type){if(t.markers.forEach(e=>e[0].setPosition(e[1])),!i)continue;break}i=!0;var n=t.pos;switch(t.type){case 1:this._deleteText(n,n+t.len);break;case 2:this._insertText(t.text,n)}this.__isDirty=t.dirty}return--this.__undoInProgress,i}_replaceLine(e,t){this.code[e]=t,this._textProperties.replaceLine(e,t),this.__preventUpdates?this.__dirtyLines[e]=!0:this.callHooks("onLineChange",e)}_deleteLine(e){this.code.splice(e,1),this._textProperties.deleteLine(e),this.tokenizer&&this.tokenizer.quickDeleteLine(e),this.__dirtyLines.splice(e,1),this.callHooks("onDeleteLine",e)}_insertLine(e,t){this.code.splice(e,0,t),this._textProperties.insertLine(e),this.tokenizer&&this.tokenizer.quickInsertLine(e);var i=!this.__preventUpdates;this.callHooks("onInsertLine",e,i),i||(this.__dirtyLines.length<=e?this.__dirtyLines[e]=!0:this.__dirtyLines.splice(e,0,!0))}_insertText(e,t){if(0!=e.length){null==t&&(t=this.caretMarker.getPosition()),t=L(t),this.__preventUndo||this._recordChange(1,t,e.length);var i=t==this.point()?this._rowcol:this._positionToRowCol(t),n=i.row;if(/^\n+$/.test(e)&&0==i.col)for(let t=0;t<e.length;++t)this._insertLine(n+t,"");else{var r=e.split("\n"),s=this.code[n],o=s.substr(i.col);r.length>1?(this._replaceLine(n,s.substr(0,i.col)+r.shift()),r.forEach(e=>this._insertLine(++n,e)),this._replaceLine(n,this.code[n]+o)):this._replaceLine(n,s.substr(0,i.col)+r[0]+s.substr(i.col))}this._updateMarkers(t,e.length),this.callHooks("onTextInsert",t,e)}}_deleteText(e,t){if(e=this._boundPosition(L(e)),t=this._boundPosition(L(t)),e!=t){if(t<e){var i=e;e=t,t=i}this.__preventUndo||this._recordChange(2,e,t-e,this._bufferSubstring(e,t));var n=this._positionToRowCol(e),r=this._positionToRowCol(t),s=this.code[n.row];if(n.row==r.row)s=s.substr(0,n.col)+s.substr(r.col),this._replaceLine(n.row,s);else{s=s.substr(0,n.col)+this.code[r.row].substr(r.col),this._replaceLine(n.row,s),s=n.row+1;for(let e=r.row-n.row;e-- >0;)this._deleteLine(s)}this._updateMarkers(e,e-t,e),this.callHooks("onTextDelete",e,t)}}_replaceText(e,t,i){this._deleteText(e,t),this._insertText(i,e)}_swapAreas(e){var t=(e=e.map(L).sort())[0],i=e[1],n=e[2],r=e[3],s=this._bufferSubstring(t,i),o=this._bufferSubstring(n,r);return this._replaceText(n,r,s),this._replaceText(t,i,o),r}_bufferSubstring(e,t){if(e=null==e?this.point():L(e),(t=null==t?this.getCodeSize():L(t))<e){var i=e;e=t,t=i}return this.getCode().substring(e,t)}_killingAction(e,t,i,n){e=L(e),t=L(t);var r=this._bufferSubstring(e,t);this._saveKilledText(r,i),n||this._deleteText(e,t),this.clearTransientMark()}_saveKilledText(e,t){if(this._lastCommandWasKill||this.ymacs.killRingToMaster(),this.ymacs.pushToKillRing(e,t),this._lastCommandWasKill++,this.interactiveEvent())try{navigator.clipboard.writeText(this.ymacs.killRingText())}catch{}}_positionToRowCol(e){for(var t=0,i=this.code,n=i.length;e>0&&t<n;){var r=i[t].length;if(r>=e)break;e-=r+1,t++}return{row:t,col:e}}_rowColToPosition(e,t){var i=0,n=this.code,r=Math.min(e,n.length-1),s=r;if(r<0)return 0;for(;--r>=0;)i+=n[r].length+1;return i+Math.min(t,n[s].length)}_boundPosition(e){return e<0?0:Math.min(e,this.getCodeSize())}_repositionCaret(e){var t=this.caretMarker.getPosition();return null==e&&(e=t),e=L(e),e=this._boundPosition(e),this.caretMarker.setPosition(e),e!=t}_updateMarkers(e,t,i=0){if(this.__size=null,this.__code=null,this.markers.map(n=>n.editorChange(e,t,i)),this.tokenizer){let i=this._positionToRowCol(Math.min(e,e+t)).row;this.tokenizer.truncate(i)}}_saveExcursion(e,t){var i=this.createMarker(null,t);++this.__savingExcursion;try{return e.call(this)}finally{--this.__savingExcursion,this.caretMarker.swap(i,!1,!0),i.destroy()}}_disableUndo(e){++this.__preventUndo;try{return e.call(this)}finally{--this.__preventUndo}}_handleKeyEvent(e){var t=!1;this.interactiveEvent(e);var i=this._lastCommandWasKill;this.__nextIsMeta&&(e.ymacsMeta=!0),this.__nextIsMeta=!1;var n=f.unparseKey(e),r=this.currentKeys,s=!1;r.push(n);for(let e=this.keymap.length;--e>=0;){let i=this.keymap[e],n=i.getHandler(r);if(n instanceof Array?(this.callInteractively(n[0],n[1]),t=!0):n?t=s=!0:i.defaultHandler&&1==r.length&&(t=this.callInteractively(i.defaultHandler[0],i.defaultHandler[1])),t)break}return s||(!t&&r.length>1&&(this.signalError(r.join(" ").bold()+" is undefined",!0),t=!0),r.splice(0,r.length)),this._lastCommandWasKill!=i||"object"==typeof t||this.__nextIsMeta||(this._lastCommandWasKill=0),this.callHooks("finishedEvent",t),this.interactiveEvent(null),t||this.isMinibuffer}_on_tokenizerFoundToken(e,t,i,n){n?this._textProperties.addLineProps(e,t,i,"css",n):this._textProperties.removeLineProps(e,t,i,"css")}_on_textPropertiesChange(e){this.__preventUpdates?this.__dirtyLines[e]=!0:this.callHooks("onLineChange",e)}formatLineHTML(e,t){var i=this._rowcol;return t instanceof c&&(i=t.getRowCol()),t=e==i.row?i.col:null,this._textProperties.getLineHTML(e,this.code[e],t)}looking_at(e){var t=this.getCode();if(e instanceof RegExp){var i=e.lastIndex=this.point(),n=e.exec(t);if(n&&n.index==i)return n.after=e.lastIndex,this.matchData=n}else if("string"==typeof e)return t.substr(this.point(),e.length)==e}looking_back(e){var t=this.getCode();if(e instanceof RegExp){var i=this.lastIndexOfRegexp(t,e,this.point());if(i&&i.after==this.point())return i}else if("string"==typeof e)return t.substr(this.point()-e.length,e.length)==e}capitalize(e){return e.replace(this.getq("syntax_capitalize_word"),(e,t,i)=>t.toUpperCase()+i.toLowerCase())}}A.prototype.COMMANDS=A.COMMANDS,A.prototype.newCommands=A.newCommands,A.prototype.replaceCommands=A.replaceCommands,A.prototype.newMode=A.newMode,A.prototype.addModeHook=A.addModeHook,A.prototype.removeModeHook=A.removeModeHook,A.setq=A.setGlobal=A.prototype.setGlobal=A.setVariable,A.prototype.setq=A.prototype.setVariable,A.prototype.getq=A.prototype.getVariable,A.getq=A.getVariable;class P extends A{constructor(...e){super(...e),this.promptMarker=this.createMarker(0,!0,"prompt"),this.setq("minibuffer_validation",e=>!0)}prompt(e){e=e.trim()+" ",this._disableUndo(()=>{let t=this.promptMarker.getPosition();this.promptMarker.setPosition(0,!0,!0),this._replaceText(0,t,e),this.promptMarker.setPosition(e.length,!0,!0),this._textProperties.spliceLineProps(0,0,e.length-t),this._textProperties.addLineProps(0,0,e.length-1,"css","minibuffer-prompt")})}_boundPosition(e){return Math.max(L(this.promptMarker),Math.min(e,this.getCodeSize()))}}class S extends r{static options={};constructor(...e){super(...e),this._cont=i.fromHTML('<div class="Ymacs_Menu"></div>'),this.getElement().appendChild(this._cont)}getContentElement(){return this._cont}initClassName(){return"Ymacs_Popup"}}var O=0,q=null;function I(){O=null}var F=i.fromHTML('<div class="line"><br/></div>'),R=0;class D extends r{static options={highlightCurrentLine:!0,buffer:null,ymacs:null,isMinibuffer:!1};constructor(...e){super(...e),this.buffer=this.o.buffer,this.ymacs=this.o.ymacs,this.isMinibuffer=this.o.isMinibuffer,this.el=this.getElement(),this.el._ymacs_object=this,this.id=`ymacs-frame-${++R}`,this.__caretId=`ymacs-caret-${R}`,this.redrawModelineWithTimer=o(this.redrawModeline.bind(this)),this.getElement().tabIndex=0,this.getElement().innerHTML="<div class='Ymacs-frame-overlays'><div class='Ymacs-frame-content'></div></div><div class='Ymacs_Modeline'></div>",this.addEventListener({onDestroy:this._on_destroy}),this._dragSelectHandlers={mousemove:this._dragSelect_onMouseMove.bind(this),mouseup:this._dragSelect_onMouseUp.bind(this)},this._bufferEvents={onLineChange:this._on_bufferLineChange.bind(this),onInsertLine:this._on_bufferInsertLine.bind(this),onDeleteLine:this._on_bufferDeleteLine.bind(this),onPointChange:this._on_bufferPointChange.bind(this),onResetCode:this._on_bufferResetCode.bind(this),onOverwriteMode:this._on_bufferOverwriteMode.bind(this),onProgressChange:this._on_bufferProgressChange.bind(this),beforeInteractiveCommand:this._on_bufferBeforeInteractiveCommand.bind(this),afterInteractiveCommand:this._on_bufferAfterInteractiveCommand.bind(this),onOverlayChange:this._on_bufferOverlayChange.bind(this),onOverlayDelete:this._on_bufferOverlayDelete.bind(this)},this._moreBufferEvents={onMessage:this._on_bufferMessage.bind(this),afterInteractiveCommand:(function(){this.__ensureCaretVisible&&this.ensureCaretVisible()}).bind(this)};var t=this.buffer;this.buffer=null,t&&this.setBuffer(t),i.on(this.getOverlaysContainer(),"scroll",this._on_scroll.bind(this)),i.on(this.getElement(),{mousedown:this._dragSelect_onMouseDown.bind(this),focus:this._on_focus.bind(this),blur:this._on_blur.bind(this),keydown:this._on_keyDown.bind(this),keyup:this._on_keyUp.bind(this),wheel:this._on_mouseWheel.bind(this)})}initClassName(){return`Ymacs_Frame${this.o.isMinibuffer?" Ymacs_Minibuffer":""}`}focus(e){this.getElement().focus()}blur(e){}getOverlaysContainer(){return this.getElement().firstChild}getModelineElement(){return this.getElement().childNodes[1]}getContentElement(){return this.getElement().firstChild.firstChild}getCaretElement(){return document.getElementById(this.__caretId)}getLineDivElement(e){return this.getContentElement().childNodes[e]||null}ensureCaretVisible(){let e=this.getOverlaysContainer(),t=e.scrollTop;this.redrawCaret();let i=this.getCaretElement();return i&&(i.scrollIntoView({block:"nearest",inline:"nearest"}),i.offsetLeft<e.clientWidth/2&&(e.scrollLeft=0)),t!=e.scrollTop}focusInside(){return document.activeElement===this.getElement()}setBuffer(e){this.buffer&&(this.caretMarker&&!this.o.isMinibuffer&&(this.caretMarker.destroy(),this.caretMarker=null),this.buffer.removeEventListener(this._bufferEvents),this.buffer.removeEventListener(this._moreBufferEvents)),this.buffer=e,e&&(e.addEventListener(this._bufferEvents),this.focusInside()&&e.addEventListener(this._moreBufferEvents),this.o.isMinibuffer?this.caretMarker=e.caretMarker:this.caretMarker=e.createMarker(e.caretMarker.getPosition(),!1,"framecaret"),this._redrawBuffer(),this.redrawCaret(!0),this.centerOnCaret())}recenterTopBottom(){let e=this.buffer._rowcol.row,t=this.getLineDivElement(e),i=this.getOverlaysContainer(),n=i.scrollTop,r=Math.round(t.offsetTop-i.clientHeight/2+t.offsetHeight/2),s=Math.round(t.offsetTop)-1,o=Math.round(t.offsetTop-i.clientHeight+t.offsetHeight)+1;n==s?i.scrollTop=o:n==r?i.scrollTop=s:i.scrollTop=r}centerOnCaret(){this.centerOnLine(this.buffer._rowcol.row)}centerOnLine(e){var t=this.getLineDivElement(e),i=this.getOverlaysContainer();i.scrollTop=Math.round(t.offsetTop-i.clientHeight/2+t.offsetHeight/2)}setModelineContent(e){this.getModelineElement().innerHTML=e}deleteOtherFrames(){this.ymacs.keepOnlyFrame(this)}deleteFrame(){this.ymacs.deleteFrame(this)}_split(e){let t=this.getOverlaysContainer(),i=t.scrollTop,n=this.ymacs.createFrame({buffer:this.buffer}),r=new z({horiz:e});return this.getElement().replaceWith(r.getElement()),r.setSplit(this,n),t.scrollTop=i,n.getOverlaysContainer().scrollTop=i,this.focus(),n}vsplit(){return this._split(!0)}hsplit(e){return this._split(!1)}__showCaret(){i.addClass(this.getCaretElement(),"Ymacs-caret")}_unhoverLine(){let e=null!=this.__hoverLine&&this.getLineDivElement(this.__hoverLine);e&&i.delClass(e,"Ymacs-current-line"),this.__hoverLine=null}redrawCaret(e){this.o.isMinibuffer&&(e=!0);var t=this.ymacs.getActiveFrame()===this;if(e||t){t&&!this.o.isMinibuffer&&this.focusInside()&&this.caretMarker.setPosition(this.buffer.caretMarker.getPosition());var n=this.buffer._rowcol;this.o.highlightCurrentLine&&(this._unhoverLine(),i.addClass(this.getLineDivElement(n.row),"Ymacs-current-line"),this.__hoverLine=n.row),[...this.getElement().querySelectorAll(".Ymacs-caret, #"+this.__caretId)].forEach(e=>{e.id="",e.className=""}),null!=this.__prevCaretLine&&this._on_bufferLineChange(this.__prevCaretLine),this.__prevCaretLine!=n.row&&(this.__prevCaretLine=n.row,this._on_bufferLineChange(n.row)),this.callHooks("onPointChange",n.row,n.col),this.redrawModelineWithTimer(n)}}_getLineHTML(e){var t=this.buffer.formatLineHTML(e,this.caretMarker),i=t.indexOf("Ymacs-caret'>");return i>=0&&(t=t.substr(0,i+12)+" id='"+this.__caretId+"'"+t.substr(i+12)),t}_redrawBuffer(){this.setContent(this.buffer.code.map((e,t)=>`<div class="line">${this._getLineHTML(t)}</div>`).join(""))}coordinatesToRowCol(e,t){var i=this,n=function e(n,r){if(n>=r)return n;var s=Math.floor((n+r)/2),o=i.getLineDivElement(s),a=o.offsetTop;return a+o.offsetHeight<t?e(s+1,r):t<a?e(n,s-1):s}(0,this.buffer.code.length-1),r=function t(r,s){if(r>=s)return r;var o=Math.floor((r+s)/2),a=i.coordinates(n,o);return i.coordinates(n,o+1).x<e?t(o+1,s):e<a.x?t(r,o-1):o}(0,this.buffer.code[n].length);return{row:n,col:r}}coordinates(e,t){var i=this.getContentElement().getBoundingClientRect(),n=this.getLineDivElement(e);return{x:function(e,t){let i=document.createRange();i.selectNodeContents(e);let n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),r=0;for(;n.nextNode();){let e=n.currentNode,s=e.nodeValue.length;if(r+s>=t){i.setStart(e,t-r),i.setEnd(e,t-r);break}r+=s}return i.getBoundingClientRect().right}(n,t)-i.left,y:n.offsetTop,h:n.offsetHeight}}heightInLines(){return Math.floor(this.getOverlaysContainer().clientHeight/this.getContentElement().firstChild.offsetHeight)}redrawModeline(e){e||(e=this.caretMarker.getRowCol());var t=this.buffer.code.length-1,i=this.firstLineVisible(),n=this.lastLineVisible();this.setModelineContent(this.buffer.renderModelineContent(e,0==i?"Top":n==t?"Bot":Math.round(n/t*100)+"%"))}_on_bufferLineChange(e){var t=this.getLineDivElement(e);t&&(t.innerHTML=this._getLineHTML(e))}_on_bufferInsertLine(e,t){var i=F.cloneNode(!0);this.getContentElement().insertBefore(i,this.getLineDivElement(e)),t&&(i.innerHTML=this._getLineHTML(e))}_on_bufferDeleteLine(e){i.trash(this.getLineDivElement(e))}_on_bufferPointChange(e,t){this.redrawCaret()}_on_bufferResetCode(){this._redrawBuffer()}_on_bufferOverwriteMode(e){this.condClass(e,"Ymacs-overwrite-mode")}_on_bufferMessage(e){this.ymacs.popupMessage(e)}_on_bufferBeforeInteractiveCommand(){this.__ensureCaretVisible=!0,this._unhoverLine(),this.ymacs.clearPopupMessage()}_on_bufferAfterInteractiveCommand(){}_on_bufferProgressChange(){this.redrawModelineWithTimer(null)}getOverlayId(e){return this.id+"-ovl-"+e}getOverlayHTML(e,t){var i="";return t.forEach(t=>{if(t.line1!=t.line2||t.col1!=t.col2){t=(n=t).line1>n.line2||n.line1==n.line2&&n.col1>n.col2?{line1:n.line2,col1:n.col2,line2:n.line1,col2:n.col1}:n;var n,r=this.coordinates(t.line1,t.col1),s=this.coordinates(t.line2,t.col2),o=0==t.col1?r:this.coordinates(t.line1,0);t.line1==t.line2?i+=`<div class="${e}" style="
                    top: ${r.y}px;
                    left: ${r.x}px;
                    height: ${r.h}px;
                    width: ${s.x-r.x}px;
                "></div>`:(i+=`<div class="${e}" style="
                    top: ${r.y}px;
                    left: ${r.x}px;
                    height: ${t.col1>0?r.h:s.y-r.y}px;
                "></div>`,t.col1>0&&t.line2-t.line1>1&&(i+=`<div class="${e}" style="
                        top: ${r.y+r.h}px;
                        left: ${o.x}px;
                        height: ${s.y-r.y-r.h}px;
                    "></div>`),t.col2>0&&(i+=`<div class="${e}" style="
                        top: ${s.y}px;
                        left: ${o.x}px;
                        height: ${s.h}px;
                        width: ${s.x-o.x}px;
                    "></div>`))}}),i?`<div id="${this.getOverlayId(e)}" data-ymacs-overlay="${e}" class="Ymacs_Overlay ${e}">${i}</div>`:null}getOverlaysCount(){return this.getOverlaysContainer().childNodes.length-1}_on_bufferOverlayChange(e,t){let n=this.getOverlayHTML(e,Array.isArray(t)?t:[t]);if(n){let t=i.fromHTML(n),r=document.getElementById(this.getOverlayId(e));r?r.replaceWith(t):this.getOverlaysContainer().appendChild(t),this._setOverlayClasses()}else this._on_bufferOverlayDelete(e)}_on_bufferOverlayDelete(e){i.trash(document.getElementById(this.getOverlayId(e))),this._setOverlayClasses()}_setOverlayClasses(){let e=[...this.getOverlaysContainer().querySelectorAll(":scope > [data-ymacs-overlay]")].map(e=>e.dataset.ymacsOverlay);this.condClass(e.length>0,"Ymacs_Frame-hasOverlays"),this.getElement().dataset.ymacsOverlays=e.join(" ")}_on_destroy(){this.setBuffer(null)}_on_focus(){this.ymacs.setActiveFrame(this,!0),this.o.isMinibuffer||this.buffer.cmd("goto_char",this.caretMarker.getPosition()),this.buffer.addEventListener(this._moreBufferEvents)}_on_blur(){this.o.isMinibuffer||this.caretMarker.setPosition(this.buffer.caretMarker.getPosition()),this.buffer.removeEventListener(this._moreBufferEvents)}_dragSelect_onMouseDown(e){if(e.ctrlKey&&e.shiftKey)return;e.stopPropagation(),clearTimeout(q),O++,q=setTimeout(I,300);let t=i.mousePos(e,this.getContentElement()),n=this.coordinatesToRowCol(t.x,t.y),r=this.buffer;setTimeout(()=>{r.clearTransientMark(),r.cmd("goto_char",r._rowColToPosition(n.row,n.col)),r.callInteractively("keyboard_quit"),1==O?(r.ensureTransientMark(),i.on(window,this._dragSelectHandlers)):2==O?(r.cmd("forward_word"),r.cmd("backward_word"),r.cmd("forward_word_mark")):3==O?(r.cmd("beginning_of_line"),r.cmd("end_of_line_mark")):4==O&&(r.cmd("backward_paragraph"),r.cmd("forward_whitespace"),r.cmd("beginning_of_line"),r.cmd("forward_paragraph_mark"))})}_dragSelect_onMouseMove(e){let t=i.mousePos(e,this.getContentElement()),n=this.coordinatesToRowCol(t.x,t.y);this.buffer.cmd("goto_char",this.buffer._rowColToPosition(n.row,n.col)),this.buffer.ensureTransientMark(),this.ensureCaretVisible()}_dragSelect_onMouseUp(e){i.off(window,this._dragSelectHandlers)}_on_keyDown(e){var t;t=e.key,!/^(?:Alt|AltGraph|CapsLock|Control|Fn|FnLock|Hyper|Meta|NumLock|ScrollLock|Shift|Super|Symbol|SymbolLock)$/.test(t)&&this.ymacs.processKeyEvent(e)&&(e.preventDefault(),e.stopPropagation())}_on_keyUp(e){}_on_scroll(){this.redrawModelineWithTimer()}_on_mouseWheel(e){e.preventDefault(),this.buffer._handleKeyEvent(e)}firstLineVisible(){var e=this.getOverlaysContainer();return this.coordinatesToRowCol(1,e.scrollTop+1).row}lastLineVisible(){var e=this.getOverlaysContainer();return this.coordinatesToRowCol(e.clientWidth-2,e.scrollTop+e.clientHeight-2).row}scrollUp(e){var t=this.getOverlaysContainer(),i=Math.max(this.firstLineVisible()-e,0);i=this.getLineDivElement(i),t.scrollTop=i.offsetTop,this.__ensureCaretVisible=!1}scrollDown(e){var t=this.getOverlaysContainer(),i=Math.min(this.firstLineVisible()+e,this.buffer.code.length-1);i=this.getLineDivElement(i),t.scrollTop=i.offsetTop,this.__ensureCaretVisible=!1}}class z extends r{static options={horiz:!1};#i=null;initClassName(){return"Ymacs_SplitCont "+(this.o.horiz?"horiz":"vert")}createElement(){super.createElement(),this._dragHandlers={mousemove:this._onMouseMove.bind(this),mouseup:this._onMouseUp.bind(this)},this._rb=i.fromHTML('<div class="bar" tabindex="0"></div>'),i.on(this._rb,"mousedown",this._onMouseDown.bind(this))}setSplit(e,t){this.add(e),this.add(this._rb),this.add(t)}_onMouseDown(e){if(this.#i=document.activeElement,e.target===this._rb){let t=this.getContentElement().children[0];this._start=this.o.horiz?e.clientY:e.clientX,this._orig_sz=this.o.horiz?t.offsetHeight:t.offsetWidth,this.addClass("dragging"),e.stopPropagation(),i.on(window,this._dragHandlers),i.overlayOn(this.o.horiz?"Ymacs_Resize_horiz":"Ymacs_Resize_vert")}else this.#i&&this.#i.focus()}_onMouseUp(e){i.off(window,this._dragHandlers),this.delClass("dragging"),i.overlayOff(),this.#i&&this.#i.focus(),this.#i=null}_onMouseMove(e){let t=this.getElement(),i=this.o.horiz?t.offsetHeight:t.offsetWidth,n=(this.o.horiz?e.clientY:e.clientX)-this._start,r=Math.min(.9,Math.max(.1,Math.min(i,Math.max(0,this._orig_sz+n))/i));this.o.horiz?t.style.gridTemplateRows=`${r}fr auto ${1-r}fr`:t.style.gridTemplateColumns=`${r}fr auto ${1-r}fr`}}function $(e,t,i,n){if(0==e.length)return null;for(var r,s=0,o=e[0],a=t.call(i,o),l=0;++s<e.length;)(r=t.call(i,e[s]))<a&&(a=r,l=s,o=e[s]);return n&&e.splice(l,1),o}function B(e,t){if(e.length>0){for(var i=e.at(-1).getBox().left,n=[e.pop()];e.length>0&&e.at(-1).getBox().left==i;)n.push(e.pop());return $(n,function(e){return Math.abs(t.top-e.getBox().top-e.getBox().height/2)})}}function H(e,t){if(e.length>0){for(var i=e.at(-1).getBox().top,n=[e.pop()];e.length>0&&e.at(-1).getBox().top==i;)n.push(e.pop());return $(n,function(e){return Math.abs(t.left-e.getBox().left-e.getBox().width/2)})}}function N(){if(!(window.localStorage&&window.localStorage.getItem))throw new u("Local storage facility not available in this browser")}class K extends r{static options={buffers:[],frames:[],cf_frameStyle:Object.create(null)};constructor(...e){super(...e),this.buffers=[...this.o.buffers],this.frames=[...this.o.frames],this.cf_frameStyle={...this.o.cf_frameStyle},this.buffers.forEach(e=>{e.ymacs=this,this._addBufferListeners(e)}),this.killRing=[],this.killMasterOfRings=[],this.progress={},this.__macro_recording=null,this.__macro_finished=null,this.__error_thrown=!1,this.__running_macro=null,this.__macro_times=0,this.__macro_step=0,this.__macro_timer=null,this.__input_frame=null,this.minibuffer=new P({ymacs:this}),this.minibuffer.cmd("minibuffer_mode"),this.minibuffer_frame=this.createFrame({isMinibuffer:!0,buffer:this.minibuffer,hidden:!0,highlightCurrentLine:!1}),0==this.buffers.length&&this.createBuffer();var t=this.createFrame({buffer:this.buffers[0]});this.add(t),this.add(this.minibuffer_frame),this.setActiveFrame(t),t.redrawCaret()}initClassName(){return"Ymacs Ymacs-cursor-block"}_addBufferListeners(e){e.addEventListener("onDestroy",()=>{var t=this.getActiveFrame();this.getBufferFrames(e).forEach(e=>{e!==t&&this.deleteFrame(e)}),s(this.buffers,e),this.getActiveBuffer()===e&&this.nextHiddenBuffer(e)})}pushToKillRing(e,t){t?this.killRing.unshift(e):this.killRing.push(e)}killRingToMaster(){this.killRing.length&&(0==this.killMasterOfRings.length||this.killMasterOfRings.at(-1).join("")!=this.killRing.join(""))&&this.killMasterOfRings.push(this.killRing),this.killRing=[]}killRingText(){return this.killRing.join("")}rotateKillRing(e){e?(this.killMasterOfRings.push(this.killRing),this.killRing=this.killMasterOfRings.shift()):(this.killMasterOfRings.unshift(this.killRing),this.killRing=this.killMasterOfRings.pop())}getBuffer(e){return e instanceof A||(e=this.buffers.find(t=>t.name==e)),e}killBuffer(e){e=this.getBuffer(e),this.callHooks("onDeleteBuffer",e),e.destroy()}renameBuffer(e,t){(e=this.getBuffer(e)).name=t,e.callHooks("onProgressChange")}_do_switchToBuffer(e){this.getActiveFrame().setBuffer(e),this.callHooks("onBufferSwitch",e)}switchToBuffer(e){var t=this.getBuffer(e),i=this.buffers;return t||(t=this.createBuffer({name:e})),s(i,t),i.unshift(t),this._do_switchToBuffer(t),t}nextHiddenBuffer(e){var t=this.buffers.filter(t=>{if(t===e)return!1;var i=!0;return t.forAllFrames(()=>i=!1),i});if(t.length>0){var i=t[0];s(this.buffers,i),this.buffers.push(i),this._do_switchToBuffer(i)}else this.switchToBuffer("*scratch*")}switchToNextBuffer(){var e=this.buffers;if(e.length>1){var t=e.shift();e.push(t),this._do_switchToBuffer(e[0])}}switchToPreviousBuffer(){var e=this.buffers;if(e.length>1){var t=e.pop();e.unshift(t),this._do_switchToBuffer(t)}}getNextBuffer(e,t){null==t&&(t=1);var i=this.buffers;return i[(i.indexOf(e)+t)%i.length]}getPrevBuffer(e,t){return null==t&&(t=1),this.getNextBuffer(e,-t)}getBufferFrames(e){return e=this.getBuffer(e),this.frames.filter(t=>t.buffer===e)}createBuffer(e){var t=new A(e=Object.assign({},e,{ymacs:this}));return this._addBufferListeners(t),e.hidden||this.buffers.push(t),this.callHooks("onCreateBuffer",t),t}createFrame(e){var t=new D(e=Object.assign({},e,{ymacs:this}));return e.hidden||this.frames.unshift(t),t.setStyle(this.cf_frameStyle),t}setFrameStyle(e){[this.minibuffer_frame,...this.frames].forEach(t=>t.setStyle(e))}keepOnlyFrame(e){if(this.frames.length>1){let t=e.getElement();for(;t.parentNode!=this.getContentElement();)t=t.parentNode;t!==e&&(t.replaceWith(e.getElement()),this.setActiveFrame(e),e.centerOnCaret(),this.frames=[e])}}deleteFrame(e){if(this.frames.length>1){s(this.frames,e);let t=e.getElement().parentNode,n=[...t.children].find(t=>{let i=t._ymacs_object;return i instanceof z||i instanceof D&&i!==e});t.replaceWith(n),i.hasClass(n,"Ymacs_Frame")||(n=n.querySelector(".Ymacs_Frame")),n=n._ymacs_object,this.setActiveFrame(n),n.centerOnCaret()}}focusOtherFrame(){this.setActiveFrame(this.frames[0])}focus(){this.frames.at(-1).focus()}setInputFrame(e){this.__input_frame=e}setActiveFrame(e,t){if(!e.isMinibuffer){var i=this.getActiveFrame();i&&i.delClass("Ymacs_Frame-active"),s(this.frames,e),this.frames.push(e),e.addClass("Ymacs_Frame-active")}this.__input_frame=e,t||e.focus()}getActiveFrame(){return this.frames.at(-1)}getActiveBuffer(){var e=this.getActiveFrame();return e?e.buffer:this.buffers.at(-1)}setColorTheme(e){this.delClass(/Ymacs-Theme-[^\s]*/g),e instanceof Array||(e=[e]),e.forEach(e=>{this.addClass("Ymacs-Theme-"+e)})}getFrameInDirection(e){let t=this.getActiveFrame(),i=t.getCaretElement().getBoundingClientRect();var n=[...this.frames].sort((e,t)=>e.getBox().left-t.getBox().left),r=[...this.frames].sort((e,t)=>e.getBox().top-t.getBox().top);return this["_get_frameInDir_"+e](n,r,i,t)}_get_frameInDir_left(e,t,i,n){return B(e=e.filter(e=>{let t=e.getBox();return e!==n&&t.left<i.left&&t.top-i.height<=i.top&&t.top+t.height>i.top}),i)}_get_frameInDir_right(e,t,i,n){return e.reverse(),B(e=e.filter(e=>{let t=e.getBox();return e!==n&&t.left>i.left&&t.top-i.height<=i.top&&t.top+t.height>i.top}),i)}_get_frameInDir_up(e,t,i,n){return H(t=t.filter(e=>{let t=e.getBox();return e!==n&&t.top<i.top&&t.left-i.width<=i.left&&t.left+t.width>i.left}),i)}_get_frameInDir_down(e,t,i,n){return t.reverse(),H(t=t.filter(e=>{let t=e.getBox();return e!==n&&t.top>i.top&&t.left-i.width<=i.left&&t.left+t.width>i.left}),i)}ls_get(){return N(),JSON.parse(localStorage.getItem(".ymacs")||"{}")}ls_set(e){N(),localStorage.setItem(".ymacs",JSON.stringify(e))}ls_getFileContents(e,t){var i,n=this.ls_getFileDirectory(e),r=n.other;if(1==r.length&&(i=n.dir[r[0]]),null==i&&!t)throw new u("File not found");return i}ls_setFileContents(e,t){var i=this.ls_getFileDirectory(e,"file");i.dir[i.other[0]]=t,this.ls_set(i.store)}ls_getFileDirectory(e,t){var i,n=i=this.ls_get(),r=[];e=e.replace(/^[~\x2f]+/,"").split(/\x2f+/);for(var s=[],o=[];e.length>0;){var a=e.shift();"."!=a&&(".."==a?(s.pop(),n=r.pop()):"~"==a?(s=[],o=[],r=[],n=i):n.hasOwnProperty(a)&&"string"!=typeof n[a]?(r.push(n),n=n[a],s.push(a)):o.push(a))}if(t){for(var l="file"==t?1:0;o.length>l;)n=n[o.shift()]={};this.ls_set(i)}return{store:i,dir:n,path:s,other:o,full:s.concat(o).join("/")}}ls_deleteFile(e){var t=this.ls_getFileDirectory(e);delete t.dir[t.other.join("/")],this.ls_set(t.store)}fs_normalizePath(e){e=e.replace(/^[~\x2f]+/,"").split(/\x2f+/);for(var t=[];e.length>0;){var i=e.shift();"."!=i&&(".."==i?t.pop():"~"==i?t=[]:t.push(i))}return t.join("/")}fs_fileType(e,t){try{this.ls_getFileContents(e),t(!0)}catch(e){t(null)}}fs_getFileContents(e,t,i){var n=this.ls_getFileContents(e,t);i(n,n)}fs_setFileContents(e,t,i,n){i&&(this.ls_getFileContents(e,!0)||"")!=i?n(null):(this.ls_setFileContents(e,t),n(t))}fs_getDirectory(e,t){var i=this.ls_getFileDirectory(e,!1);if(e=i.path.join("/"),i){var n={};for(var r in i.dir)Object.hasOwn(i.dir,r)&&(n[r]={name:r,path:e+"/"+r,type:"string"==typeof i.dir[r]?"regular":"directory"});t(n)}else t(null)}fs_deleteFile(e,t){this.ls_deleteFile(e),t()}fs_remapDir(e,t){t(e)}isRunningMacro(){return!!this.__running_macro}isRecordingMacro(){return!!this.__macro_recording}indicateError(){this.__error_thrown=!0}startMacro(e){return!this.isRecordingMacro()&&(e?(this.__macro_recording=this.__macro_finished||[],this.__macro_finished=null):this.__macro_recording=[],!0)}stopMacro(){this.__macro_recording&&(this.__macro_finished=this.__macro_recording,this.__macro_recording=null)}getLastMacro(){return this.__macro_finished}stepMacro(){for(;;){if(this.__macro_step>=this.__running_macro.length&&(this.__macro_times--,this.__macro_step=0),0==this.__macro_times||this.__error_thrown){this.__macro_times=0,this.__macro_step=0,this.__running_macro=null;return}var e=this.__running_macro[this.__macro_step];this.processKeyEvent(e),this.__macro_step++}}runMacro(e,t){if(this.isRecordingMacro())return!1;this.__error_thrown=!1,this.__running_macro=t,this.__macro_step=0,this.__macro_times=e;var i=this;return setTimeout(function(){i.stepMacro()},0),!0}processKeyEvent(e){var t=this.__input_frame.buffer;return this.__macro_recording&&this.__macro_recording.push(e),t._handleKeyEvent(e)}#n=null;popupMessage({type:e="info",text:t,isHtml:n=!1,atCaret:r=!1,timeout:s}){let o=this.__popup||(this.__popup=new S),a=o.getElement();o.condClass(r,"with-arrow"),r||(a.style.removeProperty("left"),a.style.removeProperty("top"),a.style.removeProperty("bottom"),a.style.removeProperty("right"),a.style.removeProperty("transform")),n||(t=i.htmlEscape(t)),o.setContent(t),r?this._popupAtCaret(o.getElement()):this.add(o),clearTimeout(this.#n),s&&(this.#n=setTimeout(this.clearPopupMessage.bind(this),s))}clearPopupMessage(){this.__popup&&this.__popup.getElement().remove()}requestFullScreen(){return this.getElement().requestFullscreen()}_popupAtCaret(e){e.style.visibility="hidden",i.delClass(e,/ppos-[a-z-]+/ig),this.add(e);let t=this.getElement().getBoundingClientRect(),n=this.__input_frame.getCaretElement().getBoundingClientRect(),r={x:(n.left+n.right)/2,y:(n.top+n.bottom)/2},s={x:(t.left+t.right)/2,y:(t.top+t.bottom)/2};r.y>s.y?r.x<s.x?(i.addClass(e,"ppos-top-right"),e.style.transform=`translate(0, calc(-100% - ${n.height/2}px))`):(i.addClass(e,"ppos-top-left"),e.style.transform=`translate(-100%, calc(-100% - ${n.height/2}px))`):r.x<s.x?(i.addClass(e,"ppos-bot-right"),e.style.transform=`translate(0, ${n.height/2}px)`):(i.addClass(e,"ppos-bot-left"),e.style.transform=`translate(-100%, ${n.height/2}px)`),e.style.left=r.x-t.left+"px",e.style.top=r.y-t.top+"px",e.style.removeProperty("visibility")}}class U{constructor({buffer:e=null,line:t=0,col:i=0}={}){this.buffer=e,this.line=t,this.col=i}nextCol(){++this.col}prevCol(){--this.col}nextLine(){++this.line,this.col=0}prevLine(){--this.line,this.col=0}peek(e=0){if(this.line<this.buffer.code.length){let t=this.col+e,i=this.buffer.code[this.line];if(t<i.length)return i.charAt(t);if(t==i.length)return"\n"}}next(){let e=this.peek();this.nextCol(),this.col>this.buffer.code[this.line].length&&this.nextLine();let t=this.__stop;if(t&&(this.line>t.line||this.line==t.line&&this.col>=t.col))throw this.__stop=null,t.stop??this.EOF;return e}lineText(e=this.line){return this.buffer.code[e]}lineIndentation(e=this.line){return/^\s*/.exec(this.lineText(e))[0].length}lookingAt(e){var t=this.buffer.code[this.line];return e instanceof RegExp?e.exec(t.substr(this.col)):t.substr(this.col,e.length)==e}textBefore(e){return null==e&&(e=this.buffer._rowColToPosition(this.line,this.col)),this.buffer.getCode().substr(0,e)}textAfter(e){return null==e&&(e=this.buffer._rowColToPosition(this.line,this.col)),this.buffer.getCode().substr(e)}substring(e,t){return this.buffer.getCode().substring(e,t)}substr(e,t){return this.buffer.getCode().substr(e,t)}eol(){return this.col==this.buffer.code[this.line].length}eof(){var e=this.buffer.code.length,t=this.line;return t>=e||t==e-1&&this.eol()}stopAt(e,t,i=this.EOF){this.__stop={line:e,col:t,stop:i}}length(){return this.buffer.code.length}lineLength(e){return null==e&&(e=this.line),this.buffer.code[e].length}save(){return{buffer:this.buffer,line:this.line,col:this.col}}restore(e){this.buffer=e.buffer,this.line=e.line,this.col=e.col}checkStop(){if(this.eof())throw this.EOF;if(this.eol())throw this.EOL;let e=this.__stop;if(e&&(this.line>e.line||this.line==e.line&&this.col>=e.col))throw this.__stop=null,e.stop??this.EOF}skip_ws(){for(;j.is_whitespace(this.peek());)this.next()}}U.prototype.EOL={},U.prototype.EOF={};class j{constructor({buffer:e=null,line:t=0,col:i=0,pos:n=null}={}){if(this.buffer=e,this.line=t,this.col=i,this.pos=n,null==this.pos)this.pos=this.buffer._rowColToPosition(this.line,this.col);else{var r=this.buffer._positionToRowCol(this.pos);this.line=r.row,this.col=r.col}}static is_whitespace(e){switch(e){case" ":case"\n":case"	":case"\f":case"\u2028":case"\u2029":case" ":return!0}}peek(){var e=this.buffer.code,t=e[this.line];return null==t?null:this.col==t.length?this.line==e.length-1?null:"\n":t.charAt(this.col)}next(){var e=this.peek();return e&&(++this.pos,++this.col,this.col>this.buffer.code[this.line].length&&(this.col=0,++this.line)),e}read_while(e){for(var t,i="";(t=this.peek())&&e(t);)i+=this.next();return i}skip_ws(){return this.read_while(this.is_whitespace)}looking_at(e){var t=this.buffer.code[this.line];return e instanceof RegExp?e.exec(t.substr(this.col)):t.substr(this.col,e.length)==e}}j.prototype.is_whitespace=j.is_whitespace;let Y=Object.create(null);class W extends n{static define(e,t){Y[e.toLowerCase()]=t}constructor({buffer:e,type:t}){super(),"string"==typeof t&&(t=Y[t.toLowerCase()]),this.buffer=e,this.type=t}reset(){this.stream=new U({buffer:this.buffer}),this.theParser=this.type(this.stream,this),this.parsers=[],this.parsers[-1]=this.theParser.copy(),this.timerUpdate=null,this.start()}stop(){clearTimeout(this.timerUpdate)}getLanguage(e,t){return Y[e](this.stream,this,t)}showProgress(e){null!=e&&(e=Math.round(e/this.stream.length()*100)+"%"),this.buffer.updateProgress("Syntax highlighting",e)}start(){this.stop();let e=this.stream,t,i=this.parsers;for(e.line=i.length;!(t=i[e.line]);)e.prevLine();e.nextLine(),t=t();let n=()=>{this.buffer.preventUpdates();let r=100;for(;;)try{for(;;)t.next()}catch(s){if(s===e.EOL){if(i[e.line]=t.copy(),e.nextLine(),0==--r){this.buffer.resumeUpdates(),this.timerUpdate=setTimeout(n,25);return}}else if(s===e.EOF){i[e.line]=t.copy(),this.buffer.resumeUpdates();break}else throw s}};n()}quickInsertLine(e){this.truncate(e)}quickDeleteLine(e){this.truncate(e)}onToken(e,t,i,n){this.callHooks("onFoundToken",e,t,i,n)}getParserForLine(e,t){this.stop();let i=this.stream,n,r=this.parsers;for(i.line=e-1;!(n=r[i.line]);)i.prevLine();i.nextLine(),null!=t&&i.stopAt(e,t),n=n();try{for(this.buffer.preventUpdates();;){if(null==t&&i.line==e)return n;try{for(;;)n.next()}catch(e){if(e===i.EOL)r[i.line]=n.copy(),i.nextLine();else if(e===i.EOF)return n;else throw e}}}finally{this.buffer.resumeUpdates(),i.line<i.length()&&(this.timerUpdate=setTimeout(this.start.bind(this,i.line),25))}}reparseAll(){return this.truncate(0),this.finishParsing()}finishParsing(){return this.getParserForLine(this.stream.length()),this.getLastParser()}getLastParser(){return this.parsers.at(-1)}getIndentation(e,t){var i=this.getParserForLine(e);if(i&&i.indentation instanceof Function)return i.indentation(t)}truncate(e){this.parsers.length>e&&(this.parsers.length=e)}}function V(e,t){return(e.row??e.line)<(t.row??t.line)?-1:(e.row??e.line)>(t.row??t.line)?1:(e.col??e.c1)-(t.col??t.c1)}function Q(e){var t=e.context.passedParens;return(t=t instanceof Function?t():t)&&(t=[...t].sort(V)),t}function G(e,t){return i=>i.closed&&"outer"==t&&i.outer?0>V({line:i.outer.l1,col:i.outer.c1},e)&&V({line:i.outer.l2,col:i.outer.c2},e)>=0:"inner"==t&&i.inner?0>=V({line:i.inner.l1,col:i.inner.c1},e)&&V({line:i.inner.l2,col:i.inner.c2},e)>=0:0>V(i,e)&&V(i.closed,e)>=0}A.newCommands({forward_char:d("p",function(e){return null==e&&(e=1),this.cmd("goto_char",this.point()+e)}),backward_char:d("p",function(e){return null==e&&(e=1),this.cmd("forward_char",-e)}),forward_line:d("p",function(e){null==e&&(e=1);var t=this._rowcol;/^(forward|backward)_line$/.test(this.previousCommand)||this.setq("line_movement_requested_col",t.col);var i=this.cmd("goto_char",this._rowColToPosition(t.row+e,Math.max(t.col,this.getq("line_movement_requested_col"))));return i||this.setq("line_movement_requested_col",t.col),i}),backward_line:d("p",function(e){return null==e&&(e=1),this.cmd("forward_line",-e)}),forward_whitespace:d("P",function(e){return this.cmd("search_forward_regexp",e?/[^\x20\t\xA0]/g:/[^\s]/g)?(this.cmd("backward_char"),!0):e?void 0:this.cmd("end_of_buffer")}),backward_whitespace:d("P",function(e){return this.cmd("search_backward_regexp",e?/[^\x20\t\xA0]/g:/[^\s]/g)?(this.cmd("forward_char"),!0):e?void 0:this.cmd("beginning_of_buffer")}),beginning_of_line:d(function(){return this.cmd("goto_char",this._rowColToPosition(this._rowcol.row,0))}),back_to_indentation:d(function(){var e=this._rowcol,t=this.code[e.row],i=/\S/.exec(t);if(i)return this.cmd("goto_char",this._rowColToPosition(e.row,i.index))}),beginning_of_indentation_or_line:d(function(){return this.cmd("back_to_indentation")||this.cmd("beginning_of_line")}),end_of_line:d(function(){var e=this._rowcol;return this.cmd("goto_char",this._rowColToPosition(e.row,this.code[e.row].length))}),beginning_of_buffer:d(function(){return this.cmd("goto_char",0)}),end_of_buffer:d(function(){return this.cmd("goto_char",this.getCodeSize())}),eob_p:function(){return this.point()==this.getCodeSize()},bob_p:function(){return 0==this.point()},eol_p:function(){var e=this._positionToRowCol(this.point());return e.col==this.code[e.line].length},bol_p:function(){return 0==this._positionToRowCol(this.point()).col},backward_delete_char:d("^p",function(e){if(!this.deleteTransientRegion()){null==e&&(e=1);var t=this.point();t>0&&this._deleteText(t-e,t)}}),delete_char:d("^p",function(e){if(!this.deleteTransientRegion()){null==e&&(e=1);var t=this.point();this._deleteText(t,t+e)}}),delete_whitespace:d("^P",function(e){if(!this.deleteTransientRegion()){var t=this.point();if(this.cmd("forward_whitespace",e))return this._deleteText(t,this.point()),!0}}),backward_delete_whitespace:d("^P",function(e){if(!this.deleteTransientRegion()){var t=this.point();if(this.cmd("backward_whitespace",e))return this._deleteText(this.point(),t),!0}}),delete_indentation:d("P",function(e){e&&this.cmd("forward_line"),this.cmd("back_to_indentation"),this.cmd("backward_delete_whitespace"),this.cmd("insert"," ")}),universal_argument:d("^",function(){this.pushKeymap(C),this.isMinibuffer||this.setMinibuffer("C-u")}),overwrite_mode:d(function(){this.resetOverwriteMode()}),self_insert_command:d("^p",function(e){var t=this.interactiveEvent(),i=t.key,n=this._rowcol;if(1==i.length&&!t.altKey&&!t.ctrlKey){if(this.deleteTransientRegion(),null!=e&&(i=i.repeat(e)),this.overwriteMode){var r=this.code[n.row].length-n.col;r>0&&this.cmd("delete_char",Math.min(r,e||1))}return this.cmd("insert",i),!0}return!1}),newline:d("^p",function(e){null==e&&(e=1),this.deleteTransientRegion(),this.cmd("insert","\n".repeat(e))}),newline_and_indent:d("^p",function(e){e?this.cmd("newline",e):(this.cmd("backward_delete_whitespace",!0),this.cmd("newline"),this.cmd("indent_line"))}),indent_line:d("P",function(e){if(this.tokenizer){let t=this.tokenizer.getIndentation(this._rowcol.row,this);if(null!=t){let i=this.getLine();if(!e||/\S/.test(i)){let e=this._rowcol,n=this.point()-e.col,r=/[^\S\r\n]*/.exec(i)[0].length;r>t?this._deleteText(n,n+r-t):t>r&&this._insertText(" ".repeat(t-r),n),e.col<=r&&this.cmd("goto_char",n+t)}}}else this.cmd("insert"," ".repeat(this.getq("indent_line")))}),indent_region:d("r",function(e,t){this.cmd("save_excursion",function(){var i=this.createMarker(t);for(this.cmd("goto_char",e);this.point()<i.getPosition()&&(this.cmd("indent_line",!0),this.cmd("beginning_of_line"),this.cmd("forward_line")););i.destroy()})}),make_marker:function(e){return this.createMarker(e)},looking_at:function(){return this.looking_at.apply(this,arguments)},looking_back:function(){return this.looking_back.apply(this,arguments)},search_forward:d("sSearch: ",function(e,t){var i=this.getCode(),n=this.point();this.getq("case_fold_search")&&(i=i.toLowerCase(),e=e.toLowerCase());var r=i.indexOf(e,n);if(r>=0&&(null==t||r<=t))return this.cmd("goto_char",r+e.length)}),search_backward:d("sSearch backward: ",function(e,t){var i=this.getCode(),n=this.point();this.getq("case_fold_search")&&(i=i.toLowerCase(),e=e.toLowerCase());var r=i.lastIndexOf(e,n);if(r==n&&(r=i.lastIndexOf(e,n-1)),r>=0&&r!=n&&(null==t||r>=t))return this.cmd("goto_char",r)}),make_regexp:function(e){if(!(e instanceof RegExp)){var t=!this.getq("case_fold_search");try{e=new RegExp(e,t?"g":"ig")}catch(e){throw new u("Invalid regexp")}}return e},search_forward_regexp:d("sRegExp search: ",function(e){let t=(e=this.cmd("make_regexp",e)).lastIndex=this.point(),i=e.exec(this.getCode());if(i&&e.lastIndex!=t)return i.after=e.lastIndex,this.matchData=i,this.cmd("goto_char",e.lastIndex),!0}),search_backward_regexp:d("sBackward RegExp search: ",function(e){e=this.cmd("make_regexp",e);var t=this.lastIndexOfRegexp(this.getCode(),e,this.point());if(t&&t.index!=this.point())return this.cmd("goto_char",t.index),!0}),forward_word:_(function(){for(var e=this.getq("syntax_word"),t=!1;!t&&!e.test(this.charAt());)this.cmd("forward_char")||(t=!0);for(;!t&&e.test(this.charAt());)this.cmd("forward_char")||(t=!0)}),backward_word:_(function(){for(var e=this.getq("syntax_word"),t=!1;!t&&!e.test(this.charAt(-1));)this.cmd("backward_char")||(t=!0);for(;!t&&e.test(this.charAt(-1));)this.cmd("backward_char")||(t=!0)}),forward_paragraph:_(function(){let e=this.getq("syntax_paragraph_sep");this.cmd("beginning_of_line"),this.cmd("backward_char"),this.cmd("looking_at",e)&&this.cmd("goto_char",this.cmd("match_end")),this.cmd("search_forward_regexp",e)?this.cmd("goto_char",this.cmd("match_beginning")+1):this.cmd("end_of_buffer")}),backward_paragraph:_(function(){let e=this.getq("syntax_paragraph_sep");this.cmd("beginning_of_line"),this.cmd("looking_back",e)&&this.cmd("goto_char",this.cmd("match_beginning")),this.cmd("search_backward_regexp",e)?this.cmd("goto_char",this.cmd("match_end")):this.cmd("beginning_of_buffer")}),mark_paragraph:d("^r",function(e,t){this.transientMarker?this.cmd("save_excursion",function(){this.transientMarker&&this.cmd("goto_char",t),this.ensureTransientMark(),this.cmd("forward_paragraph"),this.setMark(this.point()),this.transientMarker.swap(this.caretMarker)}):(this.cmd("forward_paragraph"),this.setMark(this.point()),this.ensureTransientMark(),this.cmd("backward_paragraph")),this.ensureTransientMark(),this.setq("sticky_mark",!0)}),transpose_words:_(function(){this.cmd("backward_char"),this.getq("syntax_word").test(this.charAt())&&this.cmd("forward_word");var e=[];this.cmd("forward_word"),e.push(this.point()),this.cmd("backward_word"),e.push(this.point()),this.cmd("backward_word"),e.push(this.point()),this.cmd("forward_word"),e.push(this.point()),this.cmd("goto_char",this._swapAreas(e))}),transpose_lines:_(function(){var e=[];this.cmd("backward_line"),this.cmd("beginning_of_line"),e.push(this.point()),this.cmd("end_of_line"),e.push(this.point()),this.cmd("forward_char"),e.push(this.point()),this.cmd("end_of_line"),e.push(this.point()),this.cmd("goto_char",this._swapAreas(e)+1)}),transpose_chars:_(function(){var e=this.point();this.cmd("backward_char")&&this.cmd("goto_char",this._swapAreas([e-1,e,e,e+1]))}),kill_word:d("^p",function(e){if(this.transientMarker){var t=this.getRegion();this.cmd("kill_region",t.begin,t.end),this.clearTransientMark()}else{var i=this.point();this.cmd("forward_word",null==e?1:e);var n=this.point();this._killingAction(i,n,!1)}}),backward_kill_word:_(function(){var e=this.point();this.cmd("backward_word");var t=this.point();this._killingAction(e,t,!0)}),_apply_operation_on_word:function(e,t){var i=this.point();if(this.getq("syntax_word").test(this.charAt())){var n=this.cmd("save_excursion",function(){return this.cmd("forward_word"),this.point()}),r=e.call(this._bufferSubstring(i,n));this._deleteText(i,n),this._insertText(r)}else this.cmd("forward_word"),this.cmd("backward_word"),i!=this.point()&&this.cmd(t)},capitalize_word:_(function(){this.cmd("_apply_operation_on_word",function(){return this.charAt(0).toUpperCase()+this.substr(1).toLowerCase()},"capitalize_word")}),downcase_word:_(function(){this.cmd("_apply_operation_on_word",String.prototype.toLowerCase,"downcase_word")}),upcase_word:_(function(){this.cmd("_apply_operation_on_word",String.prototype.toUpperCase,"upcase_word")}),goto_char:d("NGoto char: ",function(e){return this._repositionCaret(e)}),goto_line:d("NGoto line: ",function(e){var t=this._rowColToPosition(e-1,0);return this.cmd("goto_char",t)}),move_to_column:d("NMove to column: ",function(e,t){var i=this._positionToRowCol(this.point()),n=this.code[i.row];n.length<e?t?(this.cmd("end_of_line"),this.cmd("insert"," ".repeat(e-n.length))):this.cmd("end_of_line"):this.cmd("goto_char",this._rowColToPosition(i.row,e))}),delete_region:d("r",function(e,t){this._deleteText(e,t)}),insert:d("sInsert text: ",function(...e){return this._insertText(e.join(""))}),keyboard_quit:d(function(){this.clearTransientMark(),this.setPrefixArg(void 0),this.setMinibuffer("")}),buffer_substring:function(e,t){if(0==arguments.length){var i=this.getRegion();e=i.begin,t=i.end}return this._bufferSubstring(e,t)},kill_line:d("^p",function(e){if(this.transientMarker){var t=this.getRegion();this.cmd("kill_region",t.begin,t.end),this.clearTransientMark()}else if(null!=e)this._killingAction(this.point(),this.cmd("save_excursion",()=>(this.cmd("forward_line",e),this.cmd("beginning_of_line"),this.point())));else{var i=this.point(),n=this._rowcol,r=i+this.code[n.row].length-n.col;n.row<this.code.length-1&&this.cmd("looking_at",/\s*$/my)&&r++,this._killingAction(i,r)}}),save_excursion:function(){return this._saveExcursion.apply(this,arguments)},prevent_undo:function(){return this._disableUndo.apply(this,arguments)},point:function(){return this.caretMarker.getPosition()},kill_region:d("r",function(e,t){this._killingAction(e,t)}),copy_region_as_kill:d("r",function(e,t){this._killingAction(e,t,!1,!0)}),yank:d("^P",function(e){this.deleteTransientRegion();var t=this.point();this._insertText(this.ymacs.killRingText()),this.setMark(t),e&&this.caretMarker.swap(this.markMarker)}),yank_from_operating_system:d(async function(){try{let e=await navigator.clipboard.readText();this._saveKilledText(e),this.callInteractively("yank")}catch(e){console.error(e),this.signalError("Cannot read the system clipboard. Error in devtools console.")}}),copy_for_operating_system:d("r",async function(e,t){try{let i=this.cmd("buffer_substring",e,t);await navigator.clipboard.writeText(i)}catch(e){console.error(e),this.signalError("Cannot write to system clipboard. Error in devtools console.")}}),yank_pop:d(function(){/^yank/.test(this.previousCommand)?(this.ymacs.rotateKillRing(!1),this._deleteText(this.caretMarker,this.markMarker),this.cmd("yank")):this.signalError("Previous command was not a yank")}),yank_shift:d(function(){/^yank/.test(this.previousCommand)?(this.ymacs.rotateKillRing(!0),this._deleteText(this.caretMarker,this.markMarker),this.cmd("yank")):this.signalError("Previous command was not a yank")}),mark:function(){return this.markMarker.getPosition()},set_mark_command:d("d",function(e){this.clearTransientMark(),this.setMark(e),"set_mark_command"==this.currentCommand&&(this.signalInfo("Mark set",null,1e3),this.setq("sticky_mark",!0))}),exchange_point_and_mark:d("^",function(){this.transientMarker=this.createMarker(),this.caretMarker.swap(this.markMarker),this.ensureTransientMark(),this.setq("sticky_mark",!0)}),mark_whole_buffer:d(function(){this.clearTransientMark(),this.cmd("end_of_buffer"),this.ensureTransientMark(),this.cmd("beginning_of_buffer"),this.ensureTransientMark()}),recenter_top_bottom:d(function(){this.whenActiveFrame(function(e){e.recenterTopBottom()})}),recenter:d(function(){this.whenActiveFrame(function(e){e.centerOnCaret()})}),ensure_caret_visible:d(function(){this.whenActiveFrame(function(e){e.ensureCaretVisible()&&e.centerOnCaret()})}),get_fill_paragraph_region:function(){let e=this.cmd("save_excursion",()=>{this.cmd("looking_at",this.getq("syntax_paragraph_sep"))||this.cmd("forward_paragraph");let e=this.point()-1;return this.cmd("backward_paragraph"),{begin:this.point(),end:e}}),t=this.cmd("xml_get_fill_paragraph_region");return t?{begin:Math.max(e.begin,t.begin),end:Math.min(e.end,t.end)}:e},fill_paragraph:d("^rP",function(e,t,i){this.cmd("save_excursion",function(){if(this.transientMarker)this.clearTransientMark();else{let i=this.cmd("get_fill_paragraph_region");e=i.begin,t=i.end}this.cmd("goto_char",e);var n=this.createMarker(t),r="",s=/\s+/y;for(this.cmd("looking_at",/\s*\/\/+\s*/y)?(r=this.matchData[0],s=/\s*\/\/+\s*/y):this.cmd("looking_at",/\s*\/\*\s*/y)?(r=" ".repeat(this.matchData[0].length),s=/\s*\**\s*/y):this.cmd("looking_at",/\s*[#>;\s]+\s*/y)?(r=this.matchData[0],s=/\s*[#>;\s]*\s*/y):this.cmd("looking_at",/\s*([-*]|[0-9]+\.|\(?[a-z][\).])?\s+/iy)&&(r=" ".repeat(this.matchData[0].length),s=/\s*[#>;\s]*\s*/y),i&&(this._deleteText(this.point(),this.point()+this.matchData[0].length),r="");this.cmd("end_of_line"),this.cmd("backward_delete_whitespace"),!(this.point()>=n.getPosition());)this._replaceText(this.point(),this.point()+1," "),s&&this.cmd("looking_at",s)&&this._deleteText(this.point(),this.point()+this.matchData[0].length);this.cmd("beginning_of_line");for(var o=this.point(),a=!1;!a;){var l=this.point();this.cmd("search_forward_regexp",/\s/g)||(a=!0),this.point()>=n.getPosition()&&(this.cmd("goto_char",n),a=!0),this._rowcol.col>this.getq("fill_column")+1&&(l>o&&this.cmd("goto_char",l),this.cmd("backward_delete_whitespace"),this.cmd("newline"),this.cmd("insert",r),o=this.point())}n.destroy()})}),start_next_paragraph:d(function(){this.cmd("backward_paragraph");var e="";this.cmd("looking_at",/(\s*)([0-9]+)(\.\s+)/y)?e=this.matchData[1]+(parseInt(this.matchData[2],10)+1)+this.matchData[3]:this.cmd("looking_at",/(\s*\(?)([a-z])([\.\)]\s+)/iy)?e=this.matchData[1]+String.fromCharCode(this.matchData[2].charCodeAt(0)+1)+this.matchData[3]:this.cmd("looking_at",/\s*[#>;*\s-]+\s*/y)&&(e=this.matchData[0]),this.cmd("forward_paragraph"),this.cmd("eob_p")&&this.cmd("newline"),this.cmd("insert","\n",e),this.cmd("looking_at",/\n\n/y)||(this.cmd("newline"),this.cmd("backward_char"))}),scroll_down_half:_(function(){this.whenActiveFrame(function(e){var t=e.heightInLines();this.cmd("forward_line",Math.round(t/1.33)),this.cmd("recenter")})}),scroll_up_half:_(function(){this.whenActiveFrame(function(e){var t=e.heightInLines();this.cmd("backward_line",Math.round(t/1.33)),this.cmd("recenter")})}),scroll_up:d("p",function(e){null==e&&(e=3),this.whenActiveFrame(function(t){t.scrollUp(e)})}),scroll_down:d("p",function(e){null==e&&(e=3),this.whenActiveFrame(function(t){t.scrollDown(e)})}),nuke_trailing_whitespace:d(function(){this.cmd("save_excursion",function(){for(this.cmd("goto_char",0);this._rowcol.row<this.code.length;){var e=this.code[this._rowcol.row],t=/\s+$/.exec(e);if(t&&(this.cmd("beginning_of_line"),this._deleteText(this.point()+t.index,this.point()+e.length)),!this.cmd("forward_line"))break}})}),match_string:function(e){return this.matchData[e]},match_beginning:function(){return this.matchData.index},match_end:function(){return this.matchData.index+this.matchData[0].length},undo:_(function(){this._placeUndoBoundary(),this._playbackUndo()||this.signalError("No further undo information")}),center_line:d("p",function(e){null==e&&(e=1);for(let t=0;t<e;++t)t>0&&this.cmd("forward_line"),this.cmd("save_excursion",function(){this.cmd("end_of_line"),this.cmd("backward_delete_whitespace",!0),this.cmd("beginning_of_line"),this.cmd("delete_whitespace",!0);var e=this.code[this._rowcol.row],t=Math.floor((this.getq("fill_column")-e.length)/2);this.cmd("insert"," ".repeat(t))})}),dabbrev_expand:_(function(){"dabbrev_expand"!=this.previousCommand&&this.setq("dabbrev_context",null);var e,t=this.getq("dabbrev_context");if(!t){t=this.setq("dabbrev_context",{});var i=this.cmd("save_excursion",function(){return this.cmd("bind_variables",{syntax_word:this.getq("syntax_word_dabbrev")},"backward_word"),this.point()});if(i==this.point())return this.signalError("Nothing to expand");t.search=this.cmd("buffer_substring",i,this.point()),t.point=i,t.length=this.point()-i,t.lastSearch=i,t.encountered=Object.create(null),t.forward=!1,t.buffer=this,t.seenBuffers=[this],t.startBuffer=this}t.buffer.cmd("save_excursion",function i(){var n,r=this.getq("syntax_word_dabbrev"),s=!1;if(this.cmd("goto_char",t.lastSearch),t.forward){for(;this.cmd("search_forward",t.search);)if(!r.test(this.charAt(-t.search.length-1))){s=!0;break}if(s)t.lastSearch=this.point(),n=this.point()-t.search.length;else{if(t.buffer=this.whenYmacs("getNextBuffer",this),t.seenBuffers.includes(t.buffer)){e=t.search,t.startBuffer.signalError("No more completions"),t.lastSearch=t.point+t.length,t.startBuffer.setq("dabbrev_context",null);return}t.seenBuffers.push(t.buffer),t.lastSearch=0,t.buffer.cmd("save_excursion",i);return}}else{for(;this.cmd("search_backward",t.search);)if(!r.test(this.charAt(-1))){s=!0;break}if(s)n=this.point(),t.lastSearch=n,this.cmd("goto_char",n+t.search.length);else{t.forward=!0,t.lastSearch=t.point+t.length,i.call(this);return}}null!=n&&(this.cmd("bind_variables",{syntax_word:this.getq("syntax_word_dabbrev")},"forward_word"),e=this.cmd("buffer_substring",n,this.point()),t.encountered[e]&&i.call(this))}),null!=e&&(this._replaceText(t.point,t.point+t.length,e),t.length=e.length,t.encountered[e]=!0)}),split_frame_vertically:d("p",function(e){null==e?e="50%":e+="%",this.whenActiveFrame("vsplit",e)}),split_frame_horizontally:d("p",function(e){null==e?e="50%":e+="%",this.whenActiveFrame("hsplit",e)}),delete_other_frames:d(function(){this.whenActiveFrame("deleteOtherFrames")}),delete_frame:d(function(){this.whenActiveFrame("deleteFrame")}),other_frame:d(function(){this.whenYmacs("focusOtherFrame")}),windmove:function(e){this.whenYmacs(function(t){var i=t.getFrameInDirection(e);i&&i.focus()})},next_buffer:d(function(){this.whenYmacs("switchToNextBuffer",this.sameCommandCount()+1)}),previous_buffer:d(function(){this.whenYmacs("switchToPreviousBuffer",this.sameCommandCount()+1)}),switch_to_buffer:d("BSwitch to buffer: ",function(e){this.whenYmacs(function(t){if(!/\S/.test(e)){if(t.buffers.length<2)return;e=t.buffers[1]}t.switchToBuffer(e)})}),kill_buffer:d(function(){var e=this;function t(){e.whenYmacs(function(t){t.killBuffer(e)})}if(e.dirty()){var i="Buffer "+e.name+" modified; kill anyway?";e.cmd("minibuffer_yn",i,function(e){e&&t()})}else t()}),rename_buffer:d("sRename current buffer to: ",function(e){this.whenYmacs(function(t){t.renameBuffer(this,e)})}),delete_region_or_line:d("^",function(){if(!this.deleteTransientRegion()){this.cmd("beginning_of_line");var e=this.point();if(this.cmd("end_of_line"),this.cmd("forward_char"),this.point()!=e)return this._deleteText(e,this.point()),!0}}),close_last_xml_tag:_(function(){var e;if(this.cmd("save_excursion",function(){for(var t=1;0!=t&&this.cmd("search_backward_regexp",/<\x2f?([a-zA-Z0-9:_-]+)/g);)e=this.cmd("match_string",1),this.cmd("looking_at",/<\x2f/y)?++t:!this.cmd("looking_at",/<[^\x2f][^>]*?\x2f>/y)&&--t;0!=t&&(e=null)}),e)this.cmd("insert","</",e,">");else throw new u("Couldn't find a tag to close")}),bind_variables:function(){return this.withVariables.apply(this,arguments)},for_region:d("^r\nCExecute command within region: ",function(e,t,i){if(t<e){var n=e;e=t,t=n}i instanceof Function||(i=this.COMMANDS[i]),this.clearTransientMark(),this.cmd("goto_char",e),e=this.createMarker(e,!0),t=this.createMarker(t),this.withCommands({goto_char:function(i){if(i>=e.getPosition()&&i<=t.getPosition())return this._repositionCaret(i);throw"YMACS_RESTRICT"}},function(){try{for(;;){var n=this.point();if(i.call(this),this.point()==n&&!this.cmd("forward_line"))break}}catch(e){if("YMACS_RESTRICT"!==e)throw e}finally{e.destroy(),t.destroy()}})}),comment_region:d("^r",function(e,t){var i=this.getq("syntax_comment_line")||this.getq("syntax_comment_multi");i&&(this.clearTransientMark(),this.cmd("save_excursion",function(){t=this.createMarker(t),this.cmd("goto_char",e);var n=1e5;e:for(;this.point()<t.getPosition();){for(;this.cmd("looking_at",/\s*$/my);)if(!this.cmd("forward_line"))break e;for(var r=this._rowcol.col;this.cmd("looking_at",/\s/y)&&r<n;){if(!this.cmd("forward_char"))break e;++r}if(r<n&&(n=r),Array.isArray(i.ch)?(this.cmd("insert",i.ch[0]," "),this.cmd("end_of_line"),this.cmd("insert"," ",i.ch[1])):this.cmd("insert",i.ch," "),this.cmd("beginning_of_line"),!this.cmd("forward_line"))break}this.cmd("goto_char",t),this._rowcol.col>0&&!this.cmd("looking_at",/\s*$/my)&&this.cmd("newline_and_indent")}))}),uncomment_region:d("r",function(e,t){var i=this.getq("syntax_comment_line"),n=this.getq("syntax_comment_multi");(i||n)&&(this.clearTransientMark(),this.cmd("save_excursion",function(){for(t=this.createMarker(t),this.cmd("goto_char",e);this.point()<t.getPosition()&&(this.cmd("forward_whitespace"),i&&this.cmd("looking_at",i.rx)?this.cmd("delete_char",this.matchData[0].length):n&&this.cmd("looking_at",n.rx)&&this._replaceText(this.point(),this.point()+this.matchData[0].length,this.matchData[1]),this.cmd("beginning_of_line"),this.cmd("forward_line")););}))}),comment_dwim:d("^r",function(e,t){var i=this.getq("syntax_comment_line"),n=this.getq("syntax_comment_multi");(i||n)&&(this.transientMarker?this.cmd("save_excursion",function(){this.cmd("goto_char",e),i&&this.cmd("looking_at",i.rx)||n&&this.cmd("looking_at",n.rx)?this.cmd("uncomment_region",e,t):this.cmd("comment_region",e,t)}):(this.cmd("end_of_line"),i?this.cmd("insert"," ",i.ch," "):(this.cmd("insert"," ",n.ch[0],n.ch[1]),this.cmd("backward_char",n.ch[1].length)),this.cmd("indent_line")))}),what_cursor_position:d("^",function(){var e=this.charAt(),t=e;null==e?t="EOF":" "==e?t="Space":"\n"==e&&(t="Newline"),this.popupMessage({isHtml:!0,atCaret:!0,text:function({ch:e,code:t,codeHex:i,point:n,sizeKB:r}){return`
<table>
  <tr><td style='text-align: right; font-weight: bold'>Char:</td><td><tt> ${e} </tt></td></tr>
  ${null!=t?`
    <tr><td style='text-align: right; font-weight: bold'>Char code:</td><td> ${t} / 0x${i} </td></tr>
  `:""}
  <tr><td style='text-align: right; font-weight: bold'>Position:</td><td> ${n} </td></tr>
  <tr><td style='text-align: right; font-weight: bold'>Buffer size:</td><td> ${r} </td></tr>
</table>`}({ch:i.htmlEscape(t),code:e?e.charCodeAt(0):null,codeHex:e?e.charCodeAt().toString(16).toUpperCase():null,point:this.point(),size:this.getCodeSize(),sizeKB:a(this.getCodeSize(),2)})})}),set_fill_column:d("p",function(e){let t=e=>{let t=this.getq("fill_column");this.setq("fill_column",+e),this.signalInfo(`Fill column set to ${e} (was ${t})`,!1,5e3)};null==e?this.whenMinibuffer(e=>{this.cmd("minibuffer_prompt","Set fill column to: "),e.setMark(),e.transientMarker=e.createMarker(e.point(),!0),e.cmd("insert",String(this._rowcol.col)),e.ensureTransientMark(),this.cmd("minibuffer_read_number",t)}):t(e)})}),function(){function e(e,t,i,n){e.cmd("save_excursion",function(){for(var e=this._positionToRowCol(t),r=this._positionToRowCol(i),s=Math.abs(r.col-e.col),o=e.row;o<=r.row;++o){this.cmd("goto_char",this._rowColToPosition(o,0));var a=this.code[o],l=e.col,c=r.col,h=this.point(),f=0;if(l>c){var u=l;l=c,c=u}l>a.length&&(f=l-a.length,l=a.length),c>a.length&&(c=a.length),n.call(this,h+l,h+c,f,s)}},t==e.point())}A.newCommands({string_rectangle:d("r\nsString rectangle: ",function(t,i,n){e(this,t,i,function(e,t,i){i>0?this._insertText(" ".repeat(i),e):this._deleteText(e,t),this._insertText(n,e+i)})}),kill_rectangle:d("r",function(t,i){var n=[];e(this,t,i,function(e,t,i,r){var s=this._bufferSubstring(e,t);t-e<r&&(s+=" ".repeat(r-t+e)),n.push(s),this._deleteText(e,t)}),this.setq("killed_rectangle",n)}),clear_rectangle:d("r",function(e,t){this.cmd("string_rectangle",e,t," ".repeat(Math.abs(this._positionToRowCol(t).col-this._positionToRowCol(e).col)))}),insert_rectangle:function(e,t){var i=this._positionToRowCol(e).col;this.setMark(e),t.forEach((e,t)=>{t>0&&(this.cmd("forward_line")||(this.cmd("end_of_line"),this.cmd("newline")),this.cmd("move_to_column",i,!0)),this.cmd("insert",e)})},yank_rectangle:d("d",function(e){var t=this.getq("killed_rectangle");if(null==t)throw new u("No killed rectangle");this.cmd("insert_rectangle",e,t)}),_next_is_meta:function(){this.__nextIsMeta||(this.__nextIsMeta=!0,this.currentKeys.pop())}})}(),A.newCommands({kmacro_start_macro:d("p",function(e){if(!this.ymacs.isRunningMacro()){if(this.ymacs.isRecordingMacro()){this.signalError("Already defining keyboard macro.");return}this.signalInfo("Defining keyboard macro"),this.ymacs.startMacro(null!==e)}}),kmacro_end_macro:d(function(){if(!this.ymacs.isRunningMacro()){if(!this.ymacs.isRecordingMacro()){this.signalInfo("Not defining kbd macro");return}this.signalInfo("Keyboard macro defined"),this.ymacs.stopMacro()}}),kmacro_end_and_call_macro:d("p",function(e){this.ymacs.stopMacro(),null===e&&(e=1);var t=this.ymacs.getLastMacro();this.interactiveEvent(null),this.ymacs.runMacro(e,t)})}),["forward_char","forward_word","forward_line","forward_paragraph","forward_sexp","beginning_of_line","beginning_of_indentation_or_line","beginning_of_buffer","backward_char","backward_word","backward_line","backward_paragraph","backward_sexp","end_of_line","end_of_buffer"].forEach(function(e){A.COMMANDS[e+"_mark"]=d("^",function(){this.ensureTransientMark(),this.cmdApply(e,arguments),this.ensureTransientMark()})});var X=null,J=null,Z=null;function ee(e,t){let n=document.activeElement,r=this.ymacs;(X=new S).addClass("with-arrow"),t.forEach((e,t)=>{let n=e;"string"!=typeof e&&(n=e.value,e=e.label);let r=i.fromHTML(`<div class="Ymacs_Menu_Item" data-value="${i.htmlEscape(n)}"
                                          data-index="${t}">${i.htmlEscape(e)}</div>`);X.add(r)}),i.on(X.getContentElement(),{click:e=>{n.focus();let t=e.target;i.hasClass(t,"Ymacs_Menu_Item")&&(ei(+t.dataset.index),ea.call(this),ea.call(this))}}),r._popupAtCaret(X.getElement()),ei(0),this.pushKeymap(eh),X.addEventListener("onDestroy",()=>this.popKeymap(eh))}function et(){X&&X.destroy(),X=null,Z=null,J=null}function ei(e){let t=[...X.getContentElement().querySelectorAll(".Ymacs_Menu_Item")],n=t.length;J=(e%n+n)%n,t.forEach(e=>{let t=e.dataset.index==J;t&&(Z=e),i.condClass(e,t,"selected")}),Z.scrollIntoView({block:"nearest"})}function en(e,t,i){this.whenMinibuffer(function(n){var r=n.setq({completion_list:e,minibuffer_validation:(e,t)=>{null==e&&(e=n.cmd("minibuffer_contents")),i?i.call(this,n,e,t):t(!0)},minibuffer_continuation:e=>{n.setq(r),t&&t.call(this,e)}})})}function er(e,t,i,n){var r=this,s=t.lastIndexOf("/"),o=t.slice(0,s+1),a=t.slice(s+1);r.ymacs.fs_getDirectory(o,function(i){if(i){var s=[];for(var c in i)0==c.indexOf(a)&&s.push("directory"==i[c].type?c+"/":c);if(0==s.length)n([]);else{var h=l(s);h!=a?(e.cmd("minibuffer_replace_input",o+h),n(null)):1==s.length?n([t]):(console.log(s=s.map(function(e){return{label:e,value:o+e}})),ee.call(e,r.getMinibufferFrame(),s),n(null))}}else e.signalError("Not found"),n(null)})}function es(){X&&ei(J+1)}function eo(){X&&ei(J-1)}function ea(){X?Z?(this.cmd("minibuffer_replace_input",Z.dataset.value),et()):this.signalError("Select something..."):this.cmd("minibuffer_complete_and_exit")}A.newCommands({minibuffer_prompt:function(e,t){this.whenMinibuffer(function(i){var n=this.getMinibufferFrame();this.ymacs.setInputFrame(n),i.prompt(e),t||n.focus()})},minibuffer_yn:function(e,t){this.cmd("minibuffer_prompt",e+" (yes or no) "),this.cmd("minibuffer_read_yn",function(e){t("yes"==e)})},minibuffer_read_yn:function(e){en.call(this,["yes","no"],e,function(e,t,i){"yes"==t||"no"==t?i(!0):e.signalError("Please enter yes or no")})},minibuffer_read_number:function(e){en.call(this,null,e,function(e,t,i){var n=parseInt(t,10);isNaN(n)&&e.signalError("Please enter a number"),i(!isNaN(n))})},minibuffer_read_command:function(e){var t=Object.keys(this.COMMANDS).filter(e=>this.COMMANDS[e].ymacsInteractive).sort();en.call(this,t,e,function(e,t,i){var n=this.COMMANDS[t],r=n&&n.ymacsInteractive;r||e.signalError("No such command: "+t),i(r)})},minibuffer_read_function:function(e){var t=Array.hashKeys(A.COMMANDS).sort();en.call(this,t,e,function(e,t,i){var n=!!this.COMMANDS[t];n||e.signalError("No such function: "+t),i(n)})},minibuffer_read_buffer:function(e){this.whenYmacs(function(t){var i=t.buffers.map(e=>e.name);i.push(i.shift()),en.call(this,i,e)})},minibuffer_read_string:function(e,t,i){en.call(this,e,t,i)},minibuffer_read_variable:function(e){var t=Object.keys(Object.assign({},this.globalVariables,this.variables)).filter(e=>!/^\*/.test(e)).sort();en.call(this,t,function(t){let n=this.getq(t);return this.signalInfo(`Current value of <b>${i.htmlEscape(t)}</b> = <b>${i.htmlEscape(n)}</b>`,!0,3e3),e.apply(this,arguments)})},minibuffer_read_existing_file:function(e){var t=this;t.cmd("minibuffer_replace_input_by_current_dir",function(){en.call(t,er,e,function(e,i,n){t.ymacs.fs_fileType(i,function(t){null==t?(e.signalError("No such file: "+i),n(!1)):n(!0)})})})},minibuffer_read_file:function(e){var t=this;t.cmd("minibuffer_replace_input_by_current_dir",function(){en.call(t,er,e)})},minibuffer_read_file_or_directory:function(e){var t=this;t.cmd("minibuffer_replace_input_by_current_dir",function(){en.call(t,er,e)})},minibuffer_read_directory:function(e){var t=this;t.cmd("minibuffer_replace_input_by_current_dir",function(){en.call(t,er,e)})},minibuffer_prompt_end:function(){return this.whenMinibuffer(function(e){return e.promptMarker.getPosition()})},minibuffer_contents:function(){return this.whenMinibuffer(function(e){return e._bufferSubstring(e.promptMarker)})},minibuffer_replace_input:function(e){this.whenMinibuffer(function(t){t._replaceText(t.promptMarker,t.getCodeSize(),e),this.getMinibufferFrame().redrawCaret(!0)})},minibuffer_replace_input_by_current_dir:function(e){this.whenYmacs(function(t){var i=this,n=t.getActiveBuffer().name,r=n.slice(0,n.lastIndexOf("/")+1);t.fs_remapDir(r,function(t){i.cmd("minibuffer_replace_input",t),e()})})},minibuffer_complete:function(){var e=this;e.whenMinibuffer(function(t){function i(i){if(i&&0!=i.length){var n=l(i);n!=r?t.cmd("minibuffer_replace_input",n):1==i.length?t.signalError("Sole completion"):ee.call(t,e.getMinibufferFrame(),i)}else t.signalError("No completions")}var n=t.getq("completion_list"),r=t.cmd("minibuffer_contents"),s=r.replace(/([\[\]\(\)\{\}\.\*\+\?\|\\])/g,"\\$1").replace(/([_-])/g,"[^_-]*[_-]");s=RegExp("^"+s,"i"),n instanceof Function?n.call(e,t,r,s,function(e){e&&i(e)}):n&&n.length>0?i(n=n.filter(e=>s.test(e))):i(n)})},minibuffer_complete_and_exit:function(){this.whenMinibuffer(e=>{e.getq("minibuffer_validation").call(e,null,t=>{t&&e.cmd("minibuffer_keyboard_quit",this.getq("minibuffer_continuation"))})})},minibuffer_keyboard_quit:function(e){this.whenMinibuffer(function(t){var i=this.cmd("minibuffer_contents");t.setCode(""),this.ymacs.setInputFrame(this.ymacs.getActiveFrame()),this.ymacs.getActiveFrame().focus(),e||t.callHooks("abort"),setTimeout(()=>{e&&e.call(this,i),this.getPrefixArg()},1)}),et()}});var el={Tab:function(){X?es.call(this):this.cmd("minibuffer_complete")},Enter:ea,"Home && C-a":function(){this.cmd("goto_char",this.promptMarker)},"S-Home && S-C-a":d("^",function(){this.ensureTransientMark(),this.cmd("goto_char",this.promptMarker),this.ensureTransientMark()})},ec=f.define(null,Object.assign({"C-g && Escape":"minibuffer_keyboard_quit"},el)),eh=f.define(null,Object.assign({"S-Tab":function(){eo.call(this)},"ArrowDown && ArrowRight && C-n && C-f":es,"ArrowUp && ArrowLeft && C-p && C-b":eo,PageDown:es,PageUp:eo,"C-End && M->":function(){X&&ei(-1)},"C-Home && M-<":function(){X&&ei(0)},Escape:function(){et()}},el));eh.defaultHandler=[function(){return et(),!1}],A.newMode("minibuffer_mode",function(){return this.pushKeymap(ec),function(){this.popKeymap(ec)}}),A.newCommands({get_region:function(){return this.getRegion()},figure_out_mode:function(e){e||(e=this.getCode());var t=e.split(/\n/);for(let e of(t.length>4&&t.splice(2,t.length-4),t)){let t=/-\*-\s*(.*?)\s*-\*-/i.exec(e);if(t)return t[1]}},mode_from_name:function(e){switch(e||(e=this.name),(/\.[^.]+$/.exec(e)||[""])[0]){case".css":return"css";case".js":return"javascript";case".lisp":case".scm":case".el":return"lisp";case".md":return"markdown";case".xml":return"xml";case".html":return"html"}return null},set_buffer_mode:function(e){e||(e=this.cmd("figure_out_mode")||this.cmd("mode_from_name")),e&&(this.COMMANDS[e]?this.cmd(e,!0):this.COMMANDS[e+"_mode"]&&this.cmd(e+"_mode",!0))},cperl_lineup:d("r",function(e,t){this.cmd("save_excursion",function(){var i=this._positionToRowCol(t),n=0,r=[];this.cmd("goto_char",e),this.cmd("forward_whitespace",!0);var s=this.charAt();if(s.toLowerCase()!=s.toUpperCase()){this.signalError("Cannot lineup here");return}for(;this._rowcol.row<=i.row;){var o=this.getLine().indexOf(s);if(o>=0&&(o>n&&(n=o),r.push([this._rowcol.row,o])),!this.cmd("forward_line"))break}++n,r.forEach(e=>{this.cmd("goto_char",this._rowColToPosition(e[0],e[1])),this.cmd("insert"," ".repeat(n-e[1]))})})}),htmlize_region:d("r\nP",function(e,t,i){this.tokenizer.finishParsing();var n,r=this._positionToRowCol(e).row,s="",o=r;for(i&&!i.empty&&(o=parseInt(i,10)),n=String(t=this._positionToRowCol(t).row).length;r<=t;)s+="<div class='line'>",i&&(s+="<span class='line-number'>"+function(e,t,i="0"){"number"==typeof e&&(e=Math.round(e));for(var n=""+e;n.length<t;)n=i+n;return n}(o,n," ")+"</span>"),++o,s+=this._textProperties.getLineHTML(r,this.code[r],null)+"</div>\n",++r;var a=this.ymacs.switchToBuffer("*Htmlize*");a.setCode(s),a.cmd("xml_mode",!0)}),execute_extended_command:d("^CM-x ",function(e){this.callInteractively(e)}),set_variable:d("vSet variable: \nsTo value: ",function(e,t){var i=parseFloat(t);isNaN(i)||(t=i),this.setq(e,t)}),eval_string:d("^MEval string: ",function(e){try{var t=[this,this.ymacs];(e=Function("buffer","ymacs",e)).apply(this,t),this.clearTransientMark()}catch(e){this.signalError(e.type+": "+e.message),window.console&&console.log(e)}}),eval_region:d("^r",function(e,t){this.cmd("eval_string",this.cmd("buffer_substring",e,t))}),eval_buffer:d(function(){this.cmd("eval_string",this.getCode())}),toggle_line_numbers:d("^",function(){this.ymacs.toggleClass("Ymacs-line-numbers")}),save_file:d("FWrite file: ",function(e){this.ymacs.ls_setFileContents(e,this.getCode()),this.signalInfo("Saved in local storage")}),load_file:d("fFind file: ",function(e){var t=this.ymacs.ls_getFileContents(e),i=this.ymacs.createBuffer({name:e});i.setCode(t),i.cmd("set_buffer_mode"),i.cmd("switch_to_buffer",e)}),find_file:d("FFind file: ",function(e){var t=this;e=t.ymacs.fs_normalizePath(e),t.ymacs.fs_fileType(e,function(i){"directory"===i?t.signalInfo("Can't open directory"):t.ymacs.fs_getFileContents(e,!0,function(i,n){var r=t.ymacs.getBuffer(e);function s(){r.setCode(i||""),r.stamp=n,r.dirty(!1),r.cmd("set_buffer_mode"),r.cmd("switch_to_buffer",e)}if(r){if(null==n)s();else if(r.stamp==n)r.cmd("switch_to_buffer",e);else{var o="File "+e+" changed on disk.  "+(r.dirty()?"Discard your edits?":"Reread from disk?");r.cmd("minibuffer_yn",o,function(e){e&&s()})}}else r=t.ymacs.createBuffer({name:e,stamp:n}),null==i&&t.signalInfo("New file"),s()})})}),write_file:d("FWrite file: ",function(e){var t=this;function i(){t.ymacs.fs_setFileContents(e,t.getCode(),null,function(i){t.cmd("rename_buffer",e),t.dirty(!1),t.stamp=i,t.signalInfo("Wrote "+e)})}var n=t.ymacs.getBuffer(e);if(n){var r="A buffer is visiting "+e+"; proceed?";n.cmd("minibuffer_yn",r,function(e){e&&(t.ymacs.killBuffer(n),i())})}else i()}),save_some_buffers:function(){this.cmd("save_some_buffers_with_continuation",!0,function(){})},save_some_buffers_with_continuation:function(e,t){var i=this.ymacs.buffers.slice();!function n(r){i.length>0?i.shift().cmd("save_buffer_with_continuation",e,n):t()}(!1)},save_buffer_with_continuation:function(e,t){var i=this;function n(e){i.dirty(!1),i.stamp=e,t(!0)}function r(){i.ymacs.fs_setFileContents(i.name,i.getCode(),i.stamp,function(e){null!=e?n(e):i.cmd("minibuffer_yn",i.name+" has changed since visited or saved.  Save anyway?",function(e){e?i.ymacs.fs_setFileContents(i.name,i.getCode(),null,function(e){n(e)}):t(!1)})})}!i.dirty()||e&&i.name.match(/^\*.*\*$/)?t(!1):e?i.cmd("minibuffer_yn","Save file "+i.name+"?",function(e){e?r():t(!1)}):r()},save_buffer:d("",function(){var e=this;e.dirty()?e.cmd("save_buffer_with_continuation",!1,function(t){t&&e.signalInfo("Wrote "+e.name)}):e.signalInfo("No changes need to be saved")}),delete_file:d("fDelete file: ",function(e){var t=this;t.ymacs.fs_deleteFile(e,function(){t.signalInfo("Deleted "+e)})}),eval_file:d("fEval file: ",function(e){var t=this;t.ymacs.fs_getFileContents(e,!1,function(e,i){t.cmd("eval_string",e)})}),request_full_screen:d(async function(){try{this.ymacs.requestFullScreen()}catch(e){console.error(e),this.signalError("Full-screen denied",!1,3e3)}}),set_color_theme:d(function(e){if(e)this.ymacs.setColorTheme(e);else{let e=(function(){let e=[];for(let t of document.styleSheets)(function t(i){for(let n of i.cssRules)(function(i){if(i instanceof CSSImportRule)t(i.styleSheet);else{let t=/\.Ymacs-Theme-([\p{L}0-9_-]+)/u.exec(i.selectorText);t&&0>e.indexOf(t[1])&&e.push(t[1])}})(n)})(t);return e})().sort();this.cmd("minibuffer_prompt","Color theme: "),en.call(this,e,e=>{this.ymacs.setColorTheme(e)},(t,i,n)=>{if(i=i.trim())return 0>e.indexOf(i)?(t.signalError("No such theme"),n(!1)):n(!0);t.cmd("minibuffer_complete")})}})});let ef=f.define("isearch",{Escape:["isearch_abort",!0],"C-g":"isearch_reset_or_abort","C-w && C-S-s":"isearch_yank_word_or_char","C-s":"isearch_forward","C-r":"isearch_backward","M-%":"query_replace","C-M-%":"query_replace_regexp","M-s w && M-w":"isearch_toggle_word","M-s c && M-c":"isearch_toggle_case_fold","M-s Space && M-Space":"isearch_toggle_lax_whitespace",Enter:"isearch_abort","C-l":"recenter_top_bottom",Backspace:function(){this.getMinibuffer().point()>this._isearchContext.mbMark.getPosition()&&(this.getMinibuffer().cmd("backward_delete_char"),this.cmd("goto_char",this._isearchContext.livepoint),ed.call(this),e_.call(this))}});function eu({forward:e=!0,regexp:t=!1,lax:i=!0,word:n=!1,case_fold:r=this.getq("case_fold_search"),case_replace:s=this.getq("case_replace"),qreplace:o=!1,region:a=null}={}){if(!this._isearchContext)return this._isearchContext={forward:e,regexp:t,lax:i,word:n,case_fold:r,case_replace:s,livepoint:this.point(),origpoint:this.point(),current:{begin:this.point(),end:this.point()},mbMark:this.getMinibuffer().promptMarker,query:"",qreplace:o,region:a},o||(this.pushKeymap(ef),eg.call(this)),!0}function ed(){return this._isearchContext.query=this.getMinibuffer()._bufferSubstring(this._isearchContext.mbMark)}function e_({forward:e}={}){var t=this._isearchContext.query;return!/\S/.test(t)&&this.getq("isearch_last_context")&&(this._isearchContext=this.getq("isearch_last_context"),t=this._isearchContext.query,this.getMinibuffer()._placeUndoBoundary(),this.getMinibuffer().cmd("insert",t),this._isearchContext.origpoint=this.point(),this._isearchContext.current={begin:this.point(),end:this.point()}),this._isearchContext.livepoint=this.point(),null!=e&&(this._isearchContext.forward=e),eb.call(this)}function ep(){let e=this._isearchContext,t=e.query;return e.case_fold??(e.regexp?t=t.replace(/\\./g,""):t)==t.toLowerCase()}function em(e,t){let i=this._rowcol,n=this._rowColToPosition(i.row-50,0),r=this._rowColToPosition(i.row+50,1/0),s=this.getCode(),o=[],a=this._isearchContext,l=this.point(),c=0,h=0;for(e.lastIndex=a.region?.begin||0;;){let t=e.exec(s);if(t&&t[0].length){if(a.region&&e.lastIndex>a.region.end)break;if(c++,t.index>=n&&t.index<=r){let i=this._positionToRowCol(t.index),n=this._positionToRowCol(e.lastIndex);o.push({line1:i.row,col1:i.col,line2:n.row,col2:n.col})}(l>=t.index&&l<e.lastIndex||l==e.lastIndex&&a.forward)&&(h=c)}else break}eg.call(this,c,h,t),this.setOverlay("isearch-lazy",o)}function eg(e,t,i){let n=this._isearchContext;this.whenMinibuffer(r=>{if(i)r.prompt(i.call(this,e,t,n));else{let i=n.qreplace&&e?`[${e}] `:e&&t?`[${t}/${e}] `:"";r.prompt(`${i}${n.qreplace?"Query replace":"I-search"}${n.regexp?" regexp":n.word?" word":""}${n.forward?"":" backward"}:`)}let s=n.mbMark,o=s+n.lastFoundQuery?.length;null!=o&&(r.forEachLine((e,t,i)=>{r._textProperties.removeLineProps(e,t,i,"css")},s,o),r.forEachLine((e,t,i)=>{r._textProperties.addLineProps(e,t,i,"css","isearch-fail")},o))})}function eb({forward:e}=this._isearchContext){let t=this._isearchContext,i=t.query,n=!1;try{let r=ew.call(this);if(n=this.cmd(e?"search_forward_regexp":"search_backward_regexp",r)){t.lastFoundQuery=i,this.cmd("ensure_caret_visible");let n=this.point(),r=n+(e?-1:1)*this.matchData[0].length;e&&([n,r]=[r,n]),t.current={begin:n,end:r};let s=this._positionToRowCol(n),o=this._positionToRowCol(r);this.setOverlay("isearch",{line1:s.row,col1:s.col,line2:o.row,col2:o.col})}em.call(this,r)}catch{}return n}function ew({query:e=null,regexp:t=!1,lax:i=!0,case_fold:n=!0,word:r=!1}=this._isearchContext||{}){let s=e;return!t&&(s=e.replace(/[\]\[\}\{\)\(\*\+\?\.\\\^\$\|]/g,"\\$&"),r&&(s="\\b"+s+"\\b")),i&&(s=s.replace(/\s+/g,"\\s+")),new RegExp(s,ep.call(this)?"ugi":"ug")}ef.defaultHandler=["isearch_printing_char"],A.newCommands({isearch_forward:d(function(){let e={forward:!0};eu.call(this,e)||e_.call(this,e)||this.signalError("No more forward occurrences of the search text")}),isearch_backward:d(function(){let e={forward:!1};eu.call(this,e)||e_.call(this,e)||this.signalError("No more backward occurrences of the search text")}),isearch_forward_regexp:d(function(){let e={forward:!0,regexp:!0};eu.call(this,e)||e_.call(this,e)||this.signalError("No more forward occurrences of the search text")}),isearch_backward_regexp:d(function(){let e={forward:!1,regexp:!0};eu.call(this,e)||e_.call(this,e)||this.signalError("No more forward occurrences of the search text")}),isearch_yank_word_or_char:d(function(){this._isearchContext||eu.call(this,{forward:!0});let e=this._isearchContext;var t=e.current.end,i=this.cmd("save_excursion",function(){return this.cmd("goto_char",t),this.cmd("forward_word"),this.point()});if(i!=t){var n=this._bufferSubstring(t,i);this.getMinibuffer()._placeUndoBoundary(),this.getMinibuffer().cmd("insert",n.toLowerCase()),n=ed.call(this),this.cmd("goto_char",e.current.begin),eb.call(this,{forward:!0})}}),isearch_toggle_word:d(function(){let e=this._isearchContext;e.word=!e.word,e.word&&(e.regexp=!1),this.signalInfo(`Search word: ${e.word?"ON":"OFF"}`,!1,2e3),this.cmd("goto_char",this._isearchContext.current.begin),eb.call(this)}),isearch_toggle_case_fold:d(function(){let e=this._isearchContext;null==e.case_fold?e.case_fold=!1:!1===e.case_fold?e.case_fold=!0:!0===e.case_fold&&(e.case_fold=null),this.signalInfo(`Case sensitive: ${null==e.case_fold?"AUTO":e.case_fold?"OFF":"ON"}`,!1,2e3),this.cmd("goto_char",this._isearchContext.current.begin),eb.call(this)}),isearch_toggle_lax_whitespace:d(function(){let e=this._isearchContext;e.lax=!e.lax,this.signalInfo(`Loose whitespace: ${e.lax?"ON":"OFF"}`,!1,2e3),this.cmd("goto_char",this._isearchContext.current.begin),eb.call(this)}),isearch_printing_char:d(function(){let e=this._isearchContext;var t=this.interactiveEvent();return t?.key?.length!=1||t.ctrlKey||t.altKey?(this.cmd("isearch_abort"),!1):(this.whenMinibuffer(t=>{t.cmd("self_insert_command"),this.cmd("goto_char",e.livepoint),ed.call(this),eb.call(this)}),!0)}),isearch_abort:d(function(e){return e||this.setGlobal("isearch_last_context",this._isearchContext),this.setMinibuffer(""),this.popKeymap(ef),e?this.cmd("goto_char",this._isearchContext.origpoint):this.markMarker.setPosition(this._isearchContext.origpoint),this._isearchContext=null,this.deleteOverlay("isearch"),this.deleteOverlay("isearch-lazy"),!0}),isearch_reset_or_abort:d(function(){let e=this._isearchContext;e.lastFoundQuery&&e.query!=e.lastFoundQuery?this.whenMinibuffer(t=>{t._replaceText(e.mbMark,t.getCode().length,e.lastFoundQuery),e.query=e.lastFoundQuery,eb.call(this)}):this.cmd("isearch_abort",!0)})});let ev=f.define("query_replace",{"y && Space":"query_replace_yes_this_occurrence",".":"query_replace_yes_this_occurrence_and_stop","n && Delete && Backspace":"query_replace_no_this_occurrence",u:"query_replace_undo_previous","!":"query_replace_yes_all_occurrences","q && Enter":["query_replace_abort",!0],"C-l":"recenter_top_bottom"});function ey(e={}){this.whenMinibuffer(t=>{eu.call(this,{...e,qreplace:!0});let i=this._isearchContext;this.cmd("minibuffer_prompt",`Query replace${i.regexp?" regexp":i.word?" word":""}: `);let n=()=>{ed.call(this);try{em.call(this,ew.call(this))}catch{}};t.addEventListener("afterInteractiveCommand",n);let r=e=>{t.removeEventListener("afterInteractiveCommand",n),t.removeEventListener("abort",r),e||(this.deleteOverlay("isearch"),this.deleteOverlay("isearch-lazy"),this._isearchContext=null)};t.addEventListener("abort",r),this.cmd("minibuffer_read_string",null,e=>{this._isearchContext.query=e,ek.call(this),r(!0)},(e,t,n)=>{i.query=t;try{em.call(this,ew.call(this)),n(t)}catch{e.popupMessage({type:"error",text:"Incomplete regexp",atCaret:!0})}})})}function ek(){let e=this.getMinibuffer(),t=this._isearchContext,i=t.query,n=ew.call(this);if(em.call(this,n),n){this.cmd("minibuffer_prompt",`Replace ${t.regexp?"regexp ":""}\u{201C}${i}\u{201D} with: `);let r=()=>{this.deleteOverlay("isearch"),this.deleteOverlay("isearch-lazy"),this._isearchContext=null,e.removeEventListener("abort",r)};e.addEventListener("abort",r),this.cmd("minibuffer_read_string",null,t=>{this.clearTransientMark(),eC.call(this,e,n,t)})}}function ex(e){if(this._isearchContext.case_replace&&e==e.toLowerCase()){let t=this.matchData[0];if(t==t.toUpperCase())return e.toUpperCase();if(t==this.capitalize(t))return this.capitalize(e)}return e}function eC(e,t,i){let n=this._isearchContext;this.pushKeymap(ev);let r,s,o,a=0,l=[],c=n.region&&this.createMarker(n.region.end);this.cmd("goto_char",n.region?n.region.begin:n.current.begin);let h=e=>(n.regexp&&(e=e.replace(/(?:\\([\\\&\#]|\d+|<.+?>))/g,(e,t)=>"\\"==t?"\\":"#"==t?a:"&"==t?this.matchData[0]:"<"==t[0]?this.matchData.groups[t.substr(1,t.length-2)]:this.matchData[+t])),ex.call(this,e)),f=e=>{let r=this.point(),s=this.cmd("search_forward_regexp",t);if(s){let t=this.matchData;if(n.region&&(t.index<n.region.begin||t.after>c))return e||this.cmd("goto_char",r),null;let i=this.matchData.index;if(s={begin:i,end:this.point()},!e){this.cmd("ensure_caret_visible");let e=this._positionToRowCol(i);this.setOverlay("isearch",{line1:e.row,col1:e.col,line2:this._rowcol.row,col2:this._rowcol.col})}}return e||em.call(this,t,(e,t)=>`[${e}] Replace with \u{201C}${h(i)}\u{201D}? (y/n/u/!)`),s};r=this.replaceCommands({query_replace_yes_this_occurrence:d(()=>{l.push(o),this._replaceText(o.begin,o.end,h(i)),a++,(o=f())||s()}),query_replace_yes_this_occurrence_and_stop:d(()=>{l.push(o),this._replaceText(o.begin,o.end,h(i)),a++,s()}),query_replace_no_this_occurrence:d(()=>{(o=f())||s()}),query_replace_yes_all_occurrences:d(()=>{let e;for(;o;)e=o,this._replaceText(o.begin,o.end,h(i)),a++,o=f(!0);e&&(this.cmd("goto_char",e.begin),this.cmd("ensure_caret_visible")),s()}),query_replace_undo_previous:d(()=>{let e=l.pop();if(e){a--,this.cmd("undo");let t=this.__undoPointer,i=this.__undoQueue.slice(0,t);setTimeout(()=>{this.__undoPointer=t,this.__undoQueue=i}),this.cmd("goto_char",e.begin),o=f()}else this.signalError("No more undo")}),query_replace_abort:d(e=>(s(),e))}),s=()=>{c&&c.destroy(),e.removeEventListener("abort",s),this.newCommands(r),this.deleteOverlay("isearch"),this.deleteOverlay("isearch-lazy"),this._isearchContext=null,this.popKeymap(ev),e.cmd("minibuffer_keyboard_quit"),this.signalInfo(`Replaced ${a} occurrences`)},(o=f())?e.addEventListener("abort",s):s()}function eM(e){return d("^P",function(t){let i=this._isearchContext,n={qreplace:!0,regexp:null==e&&i?i.regexp:!!e,word:!!t,region:this.transientMarker&&this.getRegion()};i?(this.cmd("isearch_abort"),this._isearchContext=Object.assign({},i,n),ek.call(this)):ey.call(this,n)})}ev.defaultHandler=["query_replace_abort"],A.newCommands({query_replace:eM(null),query_replace_regexp:eM(!0)}),W.define("css",function(e,t){var i={next:function(){if(e.checkStop(),s.length>0)return s.at(-1)();var t,i=e.peek();if(e.lookingAt("/*"))a={line:e.line,c1:e.col},f(e.col,e.col+=2,"mcomment-starter"),s.push(u);else if(e.lookingAt("//"))f(e.col,e.col+=2,"comment-starter"),f(e.col,e.col=e.lineLength(),"comment");else if('"'===i||"'"===i)n.push({line:e.line,col:e.col,type:i}),o={line:e.line,c1:e.col},f(e.col,++e.col,"string-starter"),s.push(d.bind(null,i,"string"));else if(t=c[i])n.push({line:e.line,col:e.col,type:i}),f(e.col,++e.col,"open-paren");else if(t=h[i]){var l=n.pop();l&&l.type==t?(l.closed={line:e.line,col:e.col,opened:l},r.push(l),f(e.col,++e.col,"close-paren")):f(e.col,++e.col,"error")}else(t=e.lookingAt(/^(--+|\$)?([\p{L}\p{N}-]+):/u))?(f(e.col,e.col+=t[0].length-1,t[1]?"variable-name":"keyword"),f(e.col,++e.col,"operator")):(t=e.lookingAt(/^((?:\d*\.)?\d+)(px|pt|em|ex|in|cm|mm|rem|vw|vh|fr|s|%)?/))?(f(e.col,e.col+=t[1].length,"number"),t[2]&&f(e.col,e.col+=t[2].length,"type")):(t=e.lookingAt(/^(\.[\p{L}\p{N}_:-]+)/u))?f(e.col,e.col+=t[1].length,"function-name"):(t=e.lookingAt(/^(#[\p{L}\p{N}_:-]+)/u))?f(e.col,e.col+=t[1].length,"constant"):(t=e.lookingAt(/^(@[\p{L}\p{N}_:-]+)/u))?f(e.col,e.col+=t[1].length,"builtin"):(t=e.lookingAt(/^(url|none|auto|bold|italic|normal|inherit|print|screen|all|important|calc|var)/))?f(e.col,e.col+=t[1].length,"builtin"):f(e.col,++e.col,null)},copy:function(){var e=t.context={parens:n.slice(0),passedParens:r.slice(0),cont:s.slice(0),inString:o,inComment:a};function t(){return n=e.parens.slice(0),r=e.passedParens.slice(0),s=e.cont.slice(0),o=e.inString,a=e.inComment,i}return t},indentation:function(){if(o)return 0;var t=e.line,i=e.lineText(),r=0;if(a){var s=e.lineText(a.line);if(r=a.c1+1,!/^\s*\*/.test(i)){var h=/[^\s*]/g;h.lastIndex=a.c1+1;var f=h.exec(s);f&&(r=f.index)}return r}var u=n.at(-1);if(u){var h=RegExp("^\\s*\\"+c[u.type]),d=h.test(i),_=e.lineText(u.line);(h=/\S/g).lastIndex=u.col+1;var f=h.exec(_);f?r=d?u.col:f.index:(r=e.lineIndentation(u.line)+l(),d&&(r-=l()))}else{let i=t,n;for(;i-- >0&&!(n=/\S/.exec(e.lineText(i))););n&&(r=n.index)}return r}},n=[],r=[],s=[],o=null,a=null;function l(){return t.buffer.getq("indent_level")}var c={"(":")","{":"}","[":"]"},h={")":"(","}":"{","]":"["};function f(i,n,r){t.onToken(e.line,i,n,r)}function u(){var t=e.lineText(),i=t.indexOf("*/",e.col),n=/^\s*\*+/.exec(t.substr(e.col));n&&f(e.col,e.col+=n[0].length,"mcomment-starter"),i>=0?(s.pop(),a=null,f(e.col,i,"mcomment"),f(i,i+=2,"mcomment-stopper"),e.col=i):(f(e.col,t.length,"mcomment"),e.col=t.length)}function d(t,i){for(var a,l=!1,c=e.col;!e.eol();){if(a=e.peek(),!l&&a===t){s.pop(),o=null,f(c,e.col,i);var h=n.at(-1);h&&h.type==a&&(n.pop(),h.closed={line:e.line,col:e.col,opened:h},r.push(h)),f(e.col,++e.col,i+"-stopper");return}l=!l&&"\\"===a,e.nextCol()}f(c,e.col,i)}return i}),A.newMode("css_mode",function(){var e=this.tokenizer;this.setTokenizer(new W({buffer:this,type:"css"}));var t=this.cmd("paren_match_mode",!0),i=this.setq({syntax_paragraph_sep:/\n(?:[ \t\/\*]*\n)+/g,syntax_comment_line:{rx:/[^\S\r\n]*\/\/+ ?/ygu,ch:"//"},syntax_comment_multi:{rx:/[^\S\r\n]*\/\*+(.*?)\*+\//ygu,ch:["/*","*/"]}});return function(){this.setTokenizer(e),t||this.cmd("paren_match_mode",!1),this.setq(i)}}),function(){function e(e){return e.trim().split(/\s+/)}function t(e){return e.reduce((e,t,i)=>(e[t]=i+1,e),Object.create(null))}var i=e("abstract break case catch class const continue debugger default delete do else enum export extends final finally for function goto if implements import in instanceof interface native new package private protected public return static switch synchronized throw throws transient try typeof var void let yield volatile while with"),n=e("boolean byte char double float int long short void Array Date Function Math Number Object RegExp String"),r=e("false null undefined Infinity NaN true arguments"),s=e("Infinity NaN Packages decodeURI decodeURIComponent encodeURI encodeURIComponent eval isFinite isNaN parseFloat parseInt undefined window document alert prototype constructor super this"),o=/[\[({,;+\-*=?&|!:][\x20\t\n\xa0]*$|return\s+$|typeof\s+$/;function a(e){return e.toLowerCase()!=e.toUpperCase()}var l={"(":")","{":"}","[":"]"},c={")":"(","}":"{","]":"["};W.define("js",(function(e,t,i,n,r,s){var h=[],f=[],u=[],d=null,_=!1,p={next:function(){if(r.checkStop(),h.length>0)return h.at(-1)();y()},copy:function(){var e=t.context={cont:h.slice(0),inComment:d,inString:_,parens:f.slice(0),passedParens:u.slice(0)};function t(){return h=e.cont.slice(0),d=e.inComment,_=e.inString,f=e.parens.slice(0),u=e.passedParens.slice(0),p}return t},indentation:function(){var e=r.line,t=r.lineText(),i=0;if(_)return e>0&&!/\S/.test(t)?r.lineIndentation(e-1):null;if(d){var n=r.lineText(d.line);if(i=d.c1+1,!/^\s*\*/.test(t)){var s=/[^\s*]/g;s.lastIndex=d.c1+1;var o=s.exec(n);o&&(i=o.index)}return i}var a=f.at(-1);if(a){var s=RegExp("^\\s*\\"+l[a.type]),c=s.test(t),h=r.lineText(a.line);(s=/\S/g).lastIndex=a.col+1;var o=s.exec(h);o?i=c?a.col:o.index:(i=r.lineIndentation(a.line)+m(),c&&(i-=m()))}else{let t=e,n;for(;t-- >0&&!(n=/\S/.exec(r.lineText(t))););n&&(i=n.index)}if(e>0){var p=r.textBefore();if(/\)\s*$/.test(p)&&u.length>0){a=u.at(-1);var g=r.lineText(a.line);/^\s*(if|for|while)\W/.test(g)&&(i+=m())}else/\Welse\s*$/.test(p)&&(i+=m())}return/^\s*(case|default)\W/.test(t)&&(i-=m()/2),i}};function m(){return r.buffer.getq("indent_level")}function g(e,t,i){s.onToken(r.line,e,t,i)}function b(){var e=r.lineText(),t=e.indexOf("*/",r.col),i=/^\s*\*+/.exec(e.substr(r.col));i&&g(r.col,r.col+=i[0].length,"mcomment-starter"),t>=0?(h.pop(),d=null,g(r.col,t,"mcomment"),g(t,t+=2,"mcomment-stopper"),r.col=t):(g(r.col,e.length,"mcomment"),r.col=e.length)}function w(e,t){_=!0;for(var i,n=!1,s=r.col;!r.eol();){if(i=r.peek(),!n&&i===e){h.pop(),_=!1,g(s,r.col,t);var o=f.at(-1);o&&o.type==i&&(f.pop(),o.closed={line:r.line,col:r.col,opened:o},u.push(o)),g(r.col,++r.col,t+"-stopper");return}if(!n&&"`"==e&&r.lookingAt("${")){_=!1,f.push({line:r.line,col:r.col,type:"${"}),g(s,r.col,t),g(r.col,r.col+=2,"open-paren"),h.push(y);return}n=!n&&"\\"===i,r.nextCol()}g(s,r.col,t)}function v(){for(var e,t=!1,i=0,n=r.col;!r.eol();){if(l[e=r.peek()]&&!t&&!i&&i++,c[e]&&!t&&--i<0&&(i=0),"/"===e&&!t&&!i){h.pop(),g(n,r.col,"regexp"),g(r.col,++r.col,"regexp-stopper");var s=r.lookingAt(/^[gmsiyu]+/);return s&&g(r.col,r.col+=s[0].length,"regexp-modifier"),!0}t=!t&&"\\"===e,r.nextCol()}g(n,r.col,"regexp")}function y(){var s,_,p=r.peek();if(r.lookingAt("/*"))d={line:r.line,c1:r.col},g(r.col,r.col+=2,"mcomment-starter"),h.push(b);else if(r.lookingAt("//"))g(r.col,r.col+=2,"comment-starter"),g(r.col,r.col=r.lineLength(),"comment");else if('"'===p||"'"===p||"`"===p)f.push({line:r.line,col:r.col,type:p}),g(r.col,++r.col,"string-starter"),h.push(w.bind(null,p,"string"));else if(s=r.lookingAt(/^0x[0-9a-f]+|^[0-9]*\.?[0-9]+/))g(r.col,r.col+=s[0].length,"number");else if(p&&(a(p)||/^[_$]$/.test(p))&&(_=function(){for(var e,t=r.col,i=r.next(),n=i;!r.eol()&&(e=i=r.peek())&&(a(e)||/^[0-9_$]$/.test(e));)n+=i,r.nextCol();return i&&{line:r.line,c1:t,c2:r.col,id:n}}())){var m=_.id in e?"keyword":_.id in t?"type":_.id in i?"constant":_.id in n?"builtin":null;g(_.c1,_.c2,m)}else if(_=l[p])f.push({line:r.line,col:r.col,type:p}),g(r.col,++r.col,"open-paren");else if(_=c[p]){var y=f.pop();"}"==p&&y&&"${"==y.type?(y.closed={line:r.line,col:r.col,opened:y},u.push(y),g(r.col,++r.col,"close-paren"),h.pop()):y&&y.type==_?(y.closed={line:r.line,col:r.col,opened:y},u.push(y),g(r.col,++r.col,"close-paren")):g(r.col,++r.col,"error")}else"/"===p&&o.test(r.textBefore())?(g(r.col,++r.col,"regexp-starter"),h.push(v)):(s=r.lookingAt(/^\s+$/))?g(r.col,r.col+=s[0].length,"trailing-whitespace"):g(r.col,++r.col,null)}return p}).bind(null,t(i),t(n),t(r),t(s)))}();let eT=f.define("js",{"`":["paredit_open_pair","`","`",/[\`\\]/g],"'":["paredit_open_pair","'","'",/[\'\\]/g],"M-`":["paredit_wrap_round","`","`",/[\`\\]/g],"M-'":["paredit_wrap_round","'","'",/[\'\\]/g]});A.newMode("javascript_mode",function(){var e=this.tokenizer;this.setTokenizer(new W({buffer:this,type:"js"}));var t=this.cmd("paren_match_mode",!0);this.pushKeymap(eT);var i=this.setq({syntax_paragraph_sep:/\n(?:[ \t\/\*]*\n)+/g,syntax_comment_line:{rx:/[^\S\r\n]*\/\/+ ?/ygu,ch:"//"},syntax_comment_multi:{rx:/[^\S\r\n]*\/\*+(.*?)\*+\//ygu,ch:["/*","*/"]}});return function(){this.setTokenizer(e),t||this.cmd("paren_match_mode",!1),this.popKeymap(eT),this.setq(i)}}),function(){function e(e){this.value=e}function t(t,i){var n=new j({buffer:t,pos:i});function r(){return n.peek()}function s(){return n.next()}function o(){return n.read_while(function(e){return(!!w||null==y||n.pos!=y)&&n.is_whitespace(e)})}function a(e){return n.read_while(e)}function l(t,i,n){s();for(var r=!1,o="";;){var a=s();if(!a)throw new e(o);if(r)o+=a,r=!1;else if("\\"==a)n&&(o+=a),r=!0;else if(a==i)break;else o+=a}return o}function c(){return a(function(e){return e&&"\n"!=e})}function h(){var e=a(function(){return!n.looking_at("|#")});return s(),s(),e}function f(){return l('"','"')}function u(t,i){var n=v;v=0;try{var a=[];s();e:for(;;)switch(o(),r()){case i:break e;case null:throw new e(a);default:a.push(g()),++v}return s(),a}finally{v=n}}function d(){return{pattern:l("/","/",!0),modifiers:a(function(e){if(e)switch(e.toLowerCase()){case"y":case"m":case"g":case"i":return!0}}).toLowerCase()}}function _(){return a(function(e){switch(e){case null:case"(":case")":case"{":case"}":case"[":case"]":case"#":case";":case"`":case"'":case'"':case"|":case" ":case"\n":case"	":case"\f":case"\u2028":case"\u2029":case" ":return!1}return!0})}function p(){return s()+a(function(e){return e>="a"&&e<="z"||e>="A"&&e<="z"||e>="0"&&e<="9"||"-"==e||"_"==e})}function m(){switch(s(),r()){case"\\":return s(),C("char",p);case"/":return C("regexp",d);case"(":return C("vector",u.bind(null,"(",")"));case"'":return s(),C("function",_);case"|":return s(),C("comment",h);default:return C("unknown",g)}}function g(){if(o(),!w&&null!=y&&n.pos==y&&(!k||"list"==k.type))return w=C("caret");switch(r()){case";":return C("comment",c);case'"':return C("string",f);case"(":return C("list",u.bind(null,"(",")"));case"{":return C("list",u.bind(null,"{","}"));case"[":return C("list",u.bind(null,"[","]"));case"#":return C("sharp",m);case"`":return s(),C("qq",g,-1);case",":if(s(),"@"==r())return s(),C("splice",g,-2);return C("unquote",g,-1);case"'":return s(),C("quote",g,-1);case")":case null:return null}return C("symbol",_)}function b(){for(var e=[];null!=r();){var t=g();if(null==t)break;e.push(t),++v}return e}var w=null,v=0,y=null,k=null,x=null;function C(t,i,r){null==r&&(r=0);var o=k;try{var a={value:null,index:v,type:t,start:n.pos+r,parent:k,depth:k?k.depth+1:0,partial:!1};"list"==t&&(k=a);try{i&&(a.value=i(),""===a.value&&s())}catch(t){if(t instanceof e)a.value=t.value,a.partial=!0;else throw t}return a.end=n.pos,null!=y&&a.start<=y&&a.end>=y&&!x&&(x=a),a}finally{k=o}}return{parse:function(e){return y=e,C("list",b)},read:function(){return g()},prev_exp:function(){return w?w.parent.value[w.index-1]:x?"list"==x.type&&x.end==y+1?x.value.at(-1):x.parent.value[x.index]:void 0},caret_token:function(){return w},cont_exp:function(){return x},sexp:function(){for(var e=x;e&&(!/^(?:list|string)$/.test(e.type)||e.end==y);)e=e.parent;return e}}}function i(e){return e.trim().split(/\s+/)}function n(e){return i(e).reduce((e,t,i)=>(e[t]=i+1,e),Object.create(null))}A.newCommands({test_lisp_parse:d(function(){try{var e=t(this),i=e.parse(this.point());console.log(i),console.log(e.caret_token()),console.log(e.cont_exp()),console.log(e.prev_exp())}catch(e){console.log(e)}}),lisp_make_quick_parser:function(){return t.apply(this,[this,...arguments])},lisp_forward_sexp:d(function(){var e=t(this,this.point()).read();e&&this.cmd("goto_char",e.end)}),lisp_backward_sexp:d(function(){var e=t(this);e.parse(this.point());var i=e.prev_exp();i&&this.cmd("goto_char",i.start)}),lisp_backward_up_list:d(function(){var e=t(this);e.parse(this.point());var i=e.sexp();i&&i.parent&&this.cmd("goto_char",i.start)}),lisp_handle_string_quote:d(function(){var e=t(this);e.parse(this.point());var i=e.prev_exp();i&&"string"==i.type&&this.point()<i.end?this.cmd("looking_at",/\"/y)?this.cmd("forward_char"):this.cmd("looking_back",/\\/g)?this.cmd("insert",'"'):this.cmd("insert",'\\"'):(this.cmd("insert",'""'),this.cmd("backward_char"))})});var r,s=("string"==typeof(r="define defvar defparameter defconstant deftype defstruct defclass defsetf destructuring-bind defmacro defun defmethod defgeneric defpackage in-package defreadtable in-readtable when cond unless etypecase typecase ctypecase lambda λ let load-time-value quote macrolet progn begin prog1 prog2 progv go flet the if throw eval-when multiple-value-prog1 multiple-value-bind unwind-protect let\\* ignore-errors handler-case handler-bind invoke-restart restart-case restart-bind case labels function symbol-macrolet block tagbody catch locally inc! dec! cons c[ad]{1,4}r list and or not null null\\? loop do while dotimes return return-from setq set! set-car! set-cdr! setf multiple-value-call values")&&(r=i(r)),RegExp("^("+r.join("|")+")$","i")),o=n("error warn"),a=n("t nil"),l={"(":")","{":"}","[":"]","❰":"❱","«":"»"},c={")":"(","}":"{","]":"[","❱":"❰","»":"«"},h=n("defun defmacro defgeneric defmethod"),f=n("deftype defclass defstruct"),u={if:"3+",aif:"3+",when:"1*",awhen:"1*","once-only":"1*",lambda:"1*",unless:"1*",defun:"2*",defpackage:"1*",defgeneric:"2*",defmethod:"2*",defclass:"2*",defstruct:"1*",defmacro:"2*",progn:"0+",begin:"0+",prog1:"1*",prog2:"2*",let:"1*",labels:"1*",flet:"1*",macrolet:"1*","symbol-macrolet":"1*","destructuring-bind":"2*","unwind-protect":"1*",catch:"1*",case:"1*",ecase:"1*",cond:"0+","handler-bind":"1*","handler-case":"1*","restart-bind":"1*","restart-case":"1*","return-from":"1*",block:"1*",dotimes:"1*",dolist:"1*","multiple-value-bind":"2*",":method":"1*","eval-when":"1*"},_=n("labels flet macrolet");W.define("lisp",function(e,t,i){function n(e){return!(i.rx_special&&i.rx_special.test(e))&&(e.toLowerCase()!=e.toUpperCase()||/^[-|0-9!#$%&*+./:<=>?@\^_~]$/i.test(e))}i||(i={});var r=[],d=!1,p=!1,m=null,g=[],b=[],w=[],v=[],y={next:function(){if(e.checkStop(),r.length>0)return r.at(-1)();var t,i=e.peek();if(t=e.lookingAt(/^#\\.[a-z0-9_-]*/i))x(),k(e.col,e.col+=t[0].length,"constant");else if(t=e.lookingAt(/^#\x2f((\\.|[^\x2f])*)\x2f([igsm]*)/))x(),k(e.col,e.col+=2,"regexp-starter"),k(e.col,e.col+=t[1].length,"regexp"),k(e.col,e.col+=1,"regexp-stopper"),t[3]&&k(e.col,e.col+=t[3].length,"regexp-modifier");else if(e.lookingAt(/^#\x27[^(]/))x(),e.col+=2,k((t=M()).c1,t.c2,"function-name");else if(e.lookingAt("#|"))p={line:e.line,c1:e.col},k(e.col,e.col+=2,"mcomment-starter"),r.push(E);else if(t=e.lookingAt(/^;+/))k(e.col,e.col+=t[0].length,"comment-starter"),k(e.col,e.col=e.lineLength(),"comment");else if('"'===i)x(),d={line:e.line,c1:e.col},g.push({line:e.line,col:e.col,type:i}),k(e.col,++e.col,"string-starter"),r.push(T.bind(null,i,"string"));else if(t=e.lookingAt(/^[+-]?(#x[0-9a-fA-F]+|#o[0-7]+|#b[01]+|[0-9]*\.?[0-9]+e?[0-9]*)(\x2f(#x[0-9a-fA-F]+|#o[0-7]+|#b[01]+|[0-9]*\.?[0-9]+e?[0-9]*))?/))x(),k(e.col,e.col+=t[0].length,"number");else if(t=l[i])x(),w.push(v),v=[],g.push({line:e.line,col:e.col,type:i}),k(e.col,++e.col,"open-paren");else if(t=c[i]){var u=g.pop();u&&u.type==t?(u.closed={line:e.line,col:e.col,opened:u},b.push(u),v=w.pop(),k(e.col,++e.col,"close-paren")):k(e.col,++e.col,"error")}else if(n(i)&&(t=M())){var _=":"==i?"lisp-keyword":"&"==i?"type":/^#:/.test(t.id)?"lisp-keyword":s.test(t.id)?"keyword":t.id in o?"error":t.id in a?"constant":null;!_&&(L(h)&&1==v.length?_="function-name":L(f)&&1==v.length?_="type":/^with(out)?[-\x2f]|:with(out)?[-\x2f]/i.test(t.id)&&(_="builtin")),x(t),k(t.c1,t.c2,_)}else k(e.col,++e.col,null)},copy:function(){var e=t.context={cont:r.slice(0),quote:m,inString:d,inComment:p,parens:g.slice(0),passedParens:b.slice(0),backList:w.slice(0),list:v.slice(0)};function t(){return r=e.cont.slice(0),d=e.inString,m=e.quote,p=e.inComment,g=e.parens.slice(0),b=e.passedParens.slice(0),w=e.backList.slice(0),v=e.list.slice(0),y}return t},indentation:function(){var t=e.lineText();if(d)return Math.max(0,t.search(/[^\s\t\n]/));var i=0,r=g.at(-1);if(r){var s,o=e.lineText(r.line);if(i=r.col+1,/[\#\']/.test(o.charAt(r.col-1)))return i;if(n(o.charAt(i))){var a=/\s\S/g;a.lastIndex=r.col,(s=a.exec(o))&&(i=s=s.index+1)}if(v&&v.length){var l=L();if(l){var c=u[l=l.replace(/\*$/,"")];if(!c&&/^with|:with/.test(l)&&(c="0*"),!c&&/^def/.test(l)&&(c=s&&/[\(\[\{]/.test(o.charAt(s))?"1*":"2*"),!c)try{Object.hasOwn(_,w[w.length-2][0].id)&&(c="1*")}catch(e){}if(c){var h=parseInt(c,10),f=/\+/.test(c);/\*/.test(c),i=r.col+C(),f&&s?i=s:h>0&&v.length-1<h&&(s?i=s:i+=C())}}}}return i}};function k(i,n,r){t.onToken(e.line,i,n,r)}function x(t){null==t&&(t={c1:e.col}),v.push(t)}function C(){return e.buffer.getq("indent_level")}function M(){for(var t=e.col,i=e.next(),r=i;!e.eol()&&n(i=e.peek());)r+=i,e.nextCol();var s=i&&{line:e.line,c1:t,c2:e.col,id:r.toLowerCase()};if(s.c2>s.c1)return s}function T(t,i){for(var n,s=!1,o=e.col;!e.eol();){if(n=e.peek(),!s&&n===t){r.pop(),d=null,k(o,e.col,i);var a=g.at(-1);return a&&a.type==n&&(g.pop(),a.closed={line:e.line,col:e.col,opened:a},b.push(a)),k(e.col,++e.col,i+"-stopper"),!0}s=!s&&"\\"===n,e.nextCol()}k(o,e.col,i)}function E(){var t=e.lineText(),i=t.indexOf("|#",e.col),n=/^\s*\|+/.exec(t.substr(e.col));n&&k(e.col,e.col+=n[0].length,"mcomment-starter"),i>=0?(r.pop(),p=null,k(e.col,i,"mcomment"),k(i,i+=2,"mcomment-stopper"),e.col=i):(k(e.col,t.length,"mcomment"),e.col=t.length)}function L(e,t=v){var i=t&&t.length>0&&t[0].id;if(i)return(i=i.toLowerCase(),null==e)?i:"string"==typeof e?i==e:i in e}return y})}();let eE=f.define("lisp",{'"':["lisp_handle_string_quote"]});A.newMode("lisp_mode",function(){var e=this.tokenizer;this.setTokenizer(new W({buffer:this,type:"lisp"}));var t=this.setq({indent_level:2,syntax_paragraph_sep:/\n(?:[ \t;]*\n)+/g,syntax_comment_line:{rx:/[^\S\r\n]*;+ ?/gu,ch:";;"},syntax_word_dabbrev:/^[-0-9_*%+/@&$.=~\p{L}]$/u}),i=this.cmd("paren_match_mode",!0);this.pushKeymap(eE);var n=this.replaceCommands({forward_sexp:"lisp_forward_sexp",backward_sexp:"lisp_backward_sexp",backward_up_list:"lisp_backward_up_list"});return function(){this.setTokenizer(e),this.setq(t),this.newCommands(n),i||this.cmd("paren_match_mode",!1),this.popKeymap(eE)}}),W.define("markdown",function(e,t){let i={next:function(){if(e.checkStop(),s.length>0)return s.at(-1)();(function(){let i=e.peek(),n;if(0==e.col&&(n=e.lookingAt(/^(#+)/)))c(0,e.col=e.lineLength(),"markdown-heading"+n[0].length);else if(e.line>0&&0==e.col&&(n=e.lookingAt(/^[=-]+$/))&&/\S/.test(e.lineText(e.line-1)))n="markdown-heading"+(n="="==n[0].charAt(0)?1:2),t.onToken(e.line-1,0,e.lineLength(e.line-1),n),c(0,e.col=e.lineLength(),n);else if(0==e.col&&(n=e.lookingAt(/^>\s*[>\s]*/)))(n=n[0].replace(/\s+/g,"").length)>3&&(n=""),n="markdown-blockquote"+n,c(0,e.col=e.lineLength(),n);else if(n=a[i])r.push({line:e.line,col:e.col,type:i}),c(e.col,++e.col,"open-paren");else if(n=l[i]){let t=r.pop();t&&t.type==n?(t.closed={line:e.line,col:e.col,opened:t},o.push(t),c(e.col,++e.col,"close-paren")):c(e.col,++e.col,"error")}else c(e.col,++e.col,null)})()},copy:function(){let e=t.context={cont:[...s],inline:[...n],parens:[...r],passedParens:[...o]};function t(){return s=[...e.cont],n=[...e.inline],r=[...e.parens],o=[...e.passedParens],i}return t}},n=[],r=[],s=[],o=[],a={"(":")","{":"}","[":"]","«":"»","❰":"❱","“":"”"},l={")":"(","}":"{","]":"[","»":"«","❱":"❰","”":"“"};function c(i,n,r){t.onToken(e.line,i,n,r)}return i}),A.newMode("markdown_mode",function(){var e=this.tokenizer;this.setTokenizer(new W({buffer:this,type:"markdown"}));var t=this.cmd("paren_match_mode",!0);return function(){this.setTokenizer(e),t||this.cmd("paren_match_mode",!1)}});let eL=f.define("parenmatch",{"C-M-x":"goto_matching_paren","C-M-q":"indent_sexp","C-M-f && C-M-n":"forward_sexp","C-M-b && C-M-p":"backward_sexp","C-M-u && M-a && C-M-ArrowUp":"backward_up_list","C-M-a":"beginning_of_defun","C-M-e":"end_of_defun","M-e":"up_list","C-M-ArrowDown":"down_list","M-C-k":"kill_sexp","M-C-Space":"mark_sexp","M-C-t":"transpose_sexps","(":["paredit_open_pair","(",")"],"[":["paredit_open_pair","[","]"],"{":["paredit_open_pair","{","}"],"❰":["paredit_open_pair","❰","❱"],"«":["paredit_open_pair","«","»"],"“":["paredit_open_pair","“","”"],'"':["paredit_open_pair",'"','"',/[\"\\]/g],")":["paredit_close_pair","(",")"],"]":["paredit_close_pair","[","]"],"}":["paredit_close_pair","{","}"],"❱":["paredit_close_pair","❰","❱"],"»":["paredit_close_pair","«","»"],"”":["paredit_close_pair","“","”"],"M-(":["paredit_wrap_round","(",")"],"M-[":["paredit_wrap_round","[","]"],"M-{":["paredit_wrap_round","{","}"],"M-❰":["paredit_wrap_round","❰","❱"],"M-«":["paredit_wrap_round","«","»"],"M-“":["paredit_wrap_round","“","”"],'M-"':["paredit_wrap_round",'"','"',/[\"\\]/g],"M-r":"paredit_raise_sexp","M-s":"paredit_splice_sexp",Backspace:"paredit_backward_delete_char",Enter:"paredit_newline_and_indent","; && : && , && .":"paredit_electric_char"});var eA={"(":")","[":"]","{":"}","❰":"❱","«":"»","“":"”",'"':'"',"'":"'","`":"`"},eP={")":"(","]":"[","}":"{","❱":"❰","»":"«","”":"“",'"':'"',"'":"'","`":"`"};function eS(e){throw new u("Balanced expression not found")}function eO(e,t){if(e.row==t.line)return null!=t.col?e.col==t.col:t.c1<=e.col&&e.col<=t.c2}function eq(e,t){if(e.row==t.line)return null!=t.col?e.col==t.col+1:t.c1<=e.col&&e.col<=t.c2}function eI(e){return e.c1??e.col}function eF(e){return e.c2??e.col+1}A.newCommands({matching_paren:function(){let e=this.tokenizer.getLastParser();if(e){let t=this._rowcol;for(let i of Q(e)){let e=i.closed;if(eO(t,i))return this._rowColToPosition(e.line,eF(e));if(eq(t,e))return this._rowColToPosition(i.line,eI(i))}}},indent_sexp:d(function(){var e=this.cmd("matching_paren");null!=e?this.cmd("indent_region",this.point(),e):eS(this)}),goto_matching_paren:d(function(){var e=this.cmd("matching_paren");if(null!=e)return this.cmd("goto_char",e),!0}),forward_sexp:d(function(){let e=this.tokenizer.finishParsing(),t;if(e){let i=this._rowcol,n=Q(e);for(let e=0;e<n.length;++e){let r=n[e];if(r.line>i.row||r.line==i.row&&eI(r)>=i.col){t=r;break}}}this.withVariables({syntax_word:this.getq("syntax_word_sexp")},"forward_word"),t&&t.closed&&V(this._rowcol,t)>0&&this.cmd("goto_char",this._rowColToPosition(t.closed.line,eF(t.closed)))}),backward_sexp:d(function(){let e=this.tokenizer.finishParsing(),t;if(e){let i=this._rowcol,n=Q(e).filter(e=>e.closed).map(e=>e.closed).sort(V);for(let e=n.length;--e>=0;){let r=n[e];if(r.line<i.row||r.line==i.row&&eI(r)<i.col){t=r;break}}}this.withVariables({syntax_word:this.getq("syntax_word_sexp")},"backward_word"),t&&t.opened&&0>V(this._rowcol,{line:t.line,col:eF(t)})&&this.cmd("goto_char",this._rowColToPosition(t.opened.line,eI(t.opened)))}),mark_sexp:d("^r",function(e,t){this.cmd("save_excursion",function(){this.transientMarker&&this.cmd("goto_char",t),this.ensureTransientMark(),this.cmd("forward_sexp"),this.setMark(this.point()),this.transientMarker.swap(this.caretMarker)}),this.ensureTransientMark(),this.setq("sticky_mark",!0)}),kill_sexp:d(function(){this._killingAction(this.point(),this.cmd("save_excursion",function(){return this.cmd("forward_sexp"),this.point()}))}),transpose_sexps:d(function(){var e=[];this.cmd("forward_sexp"),e.push(this.point()),this.cmd("backward_sexp"),e.push(this.point()),this.cmd("backward_sexp"),e.push(this.point()),this.cmd("forward_sexp"),e.push(this.point()),this.cmd("goto_char",this._swapAreas(e))}),down_list:d(function(){let e=this.tokenizer.finishParsing();if(e){let t=this._rowcol,i={line:t.row,col:t.col},n=Q(e).filter(e=>e.closed).find(e=>V(e,i)>=0);null!=n?this.cmd("goto_char",this._rowColToPosition(n.line,eF(n))):eS(this)}}),backward_up_list:d(function(){let e=this.tokenizer.finishParsing();if(e){let t=this._rowcol,i=Q(e).filter(G(t)).at(-1);null!=i?this.cmd("goto_char",this._rowColToPosition(i.line,eI(i))):eS(this)}}),up_list:d(function(){this.cmd("backward_up_list"),this.cmd("forward_sexp")}),beginning_of_defun:d(function(){let e=this.tokenizer.finishParsing();if(e){let t=this._rowcol,i=Q(e).filter(G(t))[0];null!=i?(this.cmd("goto_char",this._rowColToPosition(i.line,eI(i))),this.cmd("back_to_indentation")):this.cmd("backward_sexp")}}),end_of_defun:d(function(){let e=this.tokenizer.finishParsing();if(e){let t=this._rowcol,i=Q(e).filter(G(t))[0];null!=i?(i=i.closed,this.cmd("goto_char",this._rowColToPosition(i.line,eF(i)))):this.cmd("forward_sexp")}}),paredit_raise_sexp:d(function(){this.cmd("forward_sexp"),this.cmd("backward_sexp");var e=this.point();this.cmd("forward_sexp");var t=this.point();this.cmd("backward_up_list");var i=this.point();this.cmd("forward_sexp");var n=this.point(),r=this.cmd("buffer_substring",e,t);this._replaceText(i,n,r),this.cmd("goto_char",i),this.cmd("indent_region",i,i+r.length)}),paredit_splice_sexp:d(function(){let e=Q(this.tokenizer.finishParsing()).filter(G(this._rowcol,"inner")).at(-1);e.inner&&e.outer?this.cmd("save_excursion",function(){let t=this._rowColToPosition(e.outer.l1,e.outer.c1),i=this._rowColToPosition(e.outer.l2,e.outer.c2),n=this._rowColToPosition(e.inner.l1,e.inner.c1),r=this._rowColToPosition(e.inner.l2,e.inner.c2);this.withMarkers((e,s)=>{this._deleteText(r,i),this._deleteText(t,n),this.cmd("indent_region",e,s)},n,r)}):this.cmd("save_excursion",function(){this.cmd("backward_up_list");var e=this.point();this.cmd("forward_sexp"),this.cmd("backward_delete_char");var t=this.point();this.cmd("goto_char",e),this.cmd("delete_char"),this.cmd("indent_region",e,t-1)})}),paredit_backward_delete_char:d("^p",function(e){if(null!=e)return this.cmd("backward_delete_char",e);if(!this.deleteTransientRegion()){if(this.cmd("looking_back",/[\(\[\{\"\❰\«\`\']/g)){var t=eA[this.matchData[0]];if(t){var i=RegExp("\\s*\\"+t,"my");this.cmd("looking_at",i)&&this.cmd("save_excursion",function(){this.cmd("delete_whitespace"),this.cmd("delete_char")})}}this.cmd("backward_delete_char")}}),paredit_delete_char:d("^p",function(e){if(null!=e)return this.cmd("delete_char",e);if(!this.deleteTransientRegion()){if(this.cmd("looking_at",/[\]\}\)\"\❱\»\`\']/y)){var t=eP[this.matchData[0]];if(t){var i=RegExp("\\"+t+"\\s*","mg");this.cmd("looking_back",i)&&this.cmd("save_excursion",function(){this.cmd("backward_delete_whitespace"),this.cmd("backward_delete_char")})}}this.cmd("delete_char")}}),paredit_open_pair:d("^",function(e,t,i){if(this.transientMarker){this.cmd("paredit_wrap_round",e,t,i);return}e==t&&this.looking_at(e)?this.cmd("forward_char"):(this.cmd("insert",e),this.cmd("insert",t),this.cmd("backward_char",t.length)),this.cmd("paredit_maybe_indent")}),paredit_close_pair:d("^",function(e,t){if(this.transientMarker){this.cmd("paredit_wrap_round",e,t);return}var i=RegExp("\\s*\\"+t,"iy");this.cmd("looking_at",i)&&this._deleteText(this.point(),this.matchData.after),this.cmd("insert",t),this.cmd("paredit_maybe_indent")}),paredit_wrap_round:d("^",function(e,t,i){var n=this.transientMarker?this.getRegion():this.cmd("save_excursion",function(){var e=this.point();return this.cmd("forward_sexp"),{begin:e,end:this.point()}}),r=this._bufferSubstring(n.begin,n.end),s=this.point()<n.end;i&&(r=r.replace(i,e=>"\\"+e));var o=this.createMarker(n.end);this.cmd("save_excursion",function(){this._replaceText(n.begin,n.end,e+r+t)},s),s&&this.cmd("forward_char"),this.clearTransientMark(),this.cmd("indent_region",n.begin,o.getPosition()),o.destroy()}),paredit_newline_and_indent:d(function(){var e=this.looking_at(/[ \t]*([\]\}])/y)&&this.looking_back(RegExp("\\"+eP[this.matchData[1]]+"[ \\t]*","g"));this.cmd("newline_and_indent"),e&&(this.cmd("newline_and_indent"),this.cmd("backward_line"),this.cmd("indent_line"))}),paredit_maybe_indent:function(){this.getq("electric_indent")&&this.cmd("indent_line")},paredit_electric_char:d(function(){this.cmd("self_insert_command"),this.cmd("paredit_maybe_indent")})}),A.newMode("paren_match_mode",function(){this.pushKeymap(eL);var e=(function(){this.deleteOverlay("match-paren")}).bind(this);let t={beforeInteractiveCommand:function(){e()},afterInteractiveCommand:o(()=>{let e=this.tokenizer.getLastParser(),t=this._rowcol,i=[];if(e)for(let n of Q(e)){let e=n.closed,r=n.c1??n.col,s=n.c2??n.col+n.type.length,o=e.c1??e.col,a=e.c2??e.col+1;if(eO(t,n)||eq(t,e)){i.push({line1:n.line,col1:r,line2:n.line,col2:s},{line1:e.line,col1:o,line2:e.line,col2:a});break}}this.setOverlay("match-paren",i)},100)};return this.addEventListener(t),null==this.getq("electric_indent")&&this.setq("electric_indent",!0),function(){e(),this.popKeymap(eL),this.removeEventListener(t)}});let eR=/^(?:area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)$/i,eD=/^(?:article|aside|blockquote|body|button|caption|col|dd|div|dl|dt|fieldset|figcaption|figure|footer|form|h[1-6]|header|hgroup|li|ol|p|pre|section|table|tbody|textarea|tfoot|th|thead|td|tr|ul)$/i;W.define("xml",function(e,t,{emptyTags:i,inline:n}={}){var r=[],s=[],o=[],a=[],l=null,c=null,h=!1,f=0,u={next:function(){if(e.checkStop(),s.length>0)return s.at(-1)();let t=e.peek(),i;if(e.lookingAt("<![CDATA[")){let t={line:e.line,c1:e.col,c2:e.col+9,type:"<![CDATA["};o.push(t),_(e.col,e.col+=9,"xml-cdata-starter"),c={line:e.line,c1:e.col},s.push(v.bind(null,"xml-cdata","]]>",t))}else if(e.lookingAt("<!--")){let t={line:e.line,c1:e.col,c2:e.col+4,type:"<!--"};o.push(t),_(e.col,e.col+=4,"mcomment-starter"),c={line:e.line,c1:e.col},s.push(v.bind(null,"mcomment","-->",t))}else if(i=e.lookingAt(/^<!.*?>/))_(e.col,e.col+=i[0].length,"directive");else if(e.lookingAt("</")&&m(e.peek(2))){let t=r.pop();t&&(t.inner.l2=e.line,t.inner.c2=e.col,n&&(f^=n.code(t.id))),o.push({line:e.line,c1:e.col,c2:e.col+2,type:"</"}),_(e.col,++e.col,"xml-open-bracket"),_(e.col,++e.col,"xml-closetag-slash");let i=g();if(_(i.c1,i.c2,t&&t.id==i.id?"xml-close-tag":"error"),t){let e={line:t.line,c1:t.c1,c2:t.c2,type:t.id,inner:t.inner,outer:t.outer},n={line:i.line,c1:i.c1,c2:i.c2,opened:e};e.closed=n,a.push(e)}s.push(y.bind(null,t))}else if("<"===t&&m(e.peek(1))){let i={l1:e.line,c1:e.col};o.push({line:e.line,col:e.col,type:t}),_(e.col,++e.col,"xml-open-bracket");let n=g();n.outer=i,_(n.c1,n.c2,"xml-open-tag"),l=n,s.push(w)}else if(i=e.lookingAt(/^&.*?;/))_(e.col,++e.col,"xml-entity-starter"),_(e.col,e.col+=i[0].length-2,"xml-entity"),_(e.col,++e.col,"xml-entity-stopper");else if("&"===t)_(e.col,++e.col,"error");else if(i=k[t])o.push({line:e.line,col:e.col,type:t}),_(e.col,++e.col,"open-paren",!0);else if(i=x[t]){let t=o.pop();t&&t.type==i?(t.closed={line:e.line,col:e.col,opened:t},a.push(t),_(e.col,++e.col,"close-paren",!0)):_(e.col,++e.col,"error")}else _(e.col,++e.col,null," "!=t)},copy:function(){let e=t.context={tags:r.slice(0),cont:s.slice(0),parens:o.slice(0),passedParens:a.slice(0),inTag:l,inComment:c,inString:h,inline:f};function t(){return s=e.cont.slice(0),r=e.tags.slice(0),o=e.parens.slice(0),a=e.passedParens.slice(0),l=e.inTag,c=e.inComment,h=e.inString,f=e.inline,u}return t},indentation:function(){var t,i;if(c)t=e.lineIndentation(c.line)+d();else if(l){var n=e.lineText(l.line);t=/^\s*$/.test(n.substr(0,l.c1-1))?l.c1+l.id.length+1:e.lineIndentation(l.line)}else(i=r.at(-1))&&(t=e.lineIndentation(i.line)+d(),/^\s*<\x2f/.test(e.lineText())&&(t-=d()));if(null==t){let i=e.line;for(;i>0&&!/\S/.test(e.lineText(i));)i--;t=e.lineIndentation(i)}return t},get tags(){return r}};function d(){return e.buffer.getq("indent_level")}function _(i,r,s,o){if(o&&n){let o=n&&n.cls(f)||"";s&&(o+=" "+s),t.onToken(e.line,i,r,o||null)}else t.onToken(e.line,i,r,s)}function p(e){return e.toLowerCase()!=e.toUpperCase()}function m(e){return e&&(p(e)||/^[:_-]$/.test(e))}function g(){for(var t,i=e.col,n=e.next(),r=n;!e.eol()&&(t=n=e.peek())&&(p(t)||/^[0-9:_-]$/.test(t));)r+=n,e.nextCol();return n&&{line:e.line,c1:i,c2:e.col,id:r}}function b(t){h=!0;for(var i,n=!1,r=e.col;!e.eol();){if(i=e.peek(),!n&&i===t){s.pop(),h=!1,_(r,e.col,"string");var l=o.at(-1);l&&l.type==i&&(o.pop(),l.closed={line:e.line,col:e.col,opened:l},a.push(l)),_(e.col,++e.col,"string-stopper");return}n=!n&&"\\"===i,e.nextCol()}_(r,e.col,"string")}function w(){var t,c=e.peek();if(e.lookingAt("/>")){let t=o.at(-1);t&&"<"==t.type&&(o.pop(),t.closed={line:e.line,col:e.col+1,opened:t},a.push(t)),s.pop(),l=null,_(e.col,++e.col,"xml-closetag-slash"),_(e.col,++e.col,"xml-close-bracket")}else if(">"===c){let t=o.at(-1);t&&"<"==t.type&&(o.pop(),t.closed={line:e.line,col:e.col,opened:t},a.push(t)),s.pop(),_(e.col,++e.col,"xml-close-bracket"),!i?.test(l.id)&&(l.inner={l1:e.line,c1:e.col},r.push(l),n&&(f^=n.code(l.id))),l=null}else m(c)&&(t=g())?_(t.c1,t.c2,"xml-attribute"):'"'===c||"'"===c?(o.push({line:e.line,col:e.col,type:c}),_(e.col,++e.col,"string-starter"),s.push(b.bind(null,c))):_(e.col,++e.col,null)}function v(t,i,n){var r=e.lineText(),o=r.indexOf(i,e.col);o>=0?(s.pop(),_(e.col,o,t),c=null,n.closed={line:e.line,c1:o,c2:o+i.length,opened:n},a.push(n),_(o,o+=i.length,t+"-stopper"),e.col=o):(_(e.col,r.length,t),e.col=r.length)}function y(t){var i=e.lookingAt(/^([\s\xA0]*)(>?)/);if(i&&i[0]){if(i[1]&&_(e.col,e.col+=i[1].length,null),i[2]){let n=o.pop();n.closed={line:e.line,col:e.col,opened:n},a.push(n),_(e.col,e.col+=i[2].length,"xml-close-bracket"),s.pop(),t&&(t.outer.l2=e.line,t.outer.c2=e.col)}}else _(e.col,++e.col,"error")}let k={"(":")","{":"}","[":"]","«":"»","❰":"❱","“":"”"},x={")":"(","}":"{","]":"[","»":"«","❱":"❰","”":"“"};return u}),W.define("html",function(e,t){let i=[],n=t.getLanguage("xml",{emptyTags:eR,inline:{code:eB,cls:eH}}),r=t.getLanguage("js"),s=t.getLanguage("css"),o=n,a={next:function(){if(e.checkStop(),i.length>0)return i.at(-1)();if(o===n){let e=n.tags.at(-1);e?.id=="script"?o=r:e?.id=="style"&&(o=s)}o===r&&e.lookingAt("</script")&&(o=n),o===s&&e.lookingAt("</style")&&(o=n),o.next()},copy:function(){let e=[...i],t=n.copy(),l=r.copy(),c=s.copy(),h=o;function f(){return i=[...e],n=t(),r=l(),s=c(),o=h,a}return f.context={get passedParens(){return[...t.context.passedParens,...l.context.passedParens,...c.context.passedParens]},get tags(){return t.context.tags}},f},get mode(){return o===n?"markup":o===s?"css":o===r?"js":null},get tags(){return n.tags},indentation:function(){return/^\s*<\//.test(e.lineText())?n.indentation():o.indentation()}};return a});let ez=f.define("xml",{"C-c /":"xml_close_tag","/":"xml_slash_complete_tag",">":"xml_gt_complete_tag","C-Enter":"xml_zen_expand",Enter:"xml_newline_and_indent"}),e$=e=>function(){var t=this.tokenizer;this.setTokenizer(new W({buffer:this,type:e}));var i=this.cmd("paren_match_mode",!0);this.pushKeymap(ez);var n=this.setq({indent_level:2,syntax_comment_multi:{rx:/[^\S\r\n]*<!--+[^\S\r\n]*(.*?)[^\S\r\n]*-->/ygu,ch:["<!--","-->"]},syntax_word_dabbrev:/^[\p{N}_$\p{L}:#-]$/u,syntax_word_sexp:/^[\p{N}_$\p{L}:#-]$/u});return function(){this.setTokenizer(t),i||this.cmd("paren_match_mode",!1),this.popKeymap(ez),this.setq(n)}};function eB(e){return"i"==e||"em"==e?1:"b"==e||"strong"==e?2:"a"==e?4:"h1"==e?8:"h2"==e?16:"h3"==e?32:"h4"==e?64:0}function eH(e){let t="";return 1&e&&(t+=" italic"),2&e&&(t+=" bold"),4&e&&(t+=" link"),8&e&&(t+=" heading1"),16&e&&(t+=" heading2"),32&e&&(t+=" heading3"),64&e&&(t+=" heading4"),t.trim()||null}A.newMode("xml_mode",e$("xml")),A.newMode("html_mode",e$("html")),A.newCommands({xml_get_fill_paragraph_region:function(){let e=Q(this.tokenizer.finishParsing()).filter(G(this._rowcol,"outer")).findLast(e=>eD.test(e.type));if(e){let t={begin:this._rowColToPosition(e.inner.l1,e.inner.c1),end:this._rowColToPosition(e.inner.l2,e.inner.c2)};return this.cmd("save_excursion",()=>{this.cmd("goto_char",t.begin),this.cmd("looking_at",/[^\S\r\n]*\n/gy)&&(this.cmd("goto_char",this.matchData.after),t.begin=this.point()),this.cmd("goto_char",t.end),this.cmd("looking_back",/\n[^\S\r\n]*/g)&&(this.cmd("backward_whitespace"),t.end=this.point())}),t}}}),function(){let e=f.define("xml_zen",{Tab:"xml_zen_next_poi","S-Tab":"xml_zen_prev_poi","C-g":"xml_zen_stop"});function t(){var e=this.point(),t=this.getq("xml_zen_markers"),i=t[0],n=t.at(-1);(e<i.getPosition()||e>n.getPosition()||n.getPosition()==t.at(-2).getPosition())&&this.cmd("xml_zen_stop")}A.newCommands({xml_close_tag:d(function(){this.cmd("close_last_xml_tag"),this.cmd("indent_line")}),xml_slash_complete_tag:d(function(){if(this.cmd("self_insert_command"),this.looking_back("</")){let e=this._rowcol,t=this.tokenizer.getParserForLine(e.row,e.col).copy().context.tags.at(-1);t&&(this._placeUndoBoundary(),this.cmd("insert",t.id,">"),this.cmd("indent_line"))}}),xml_gt_complete_tag:d(function(){this.cmd("self_insert_command");let e=this._rowcol,t=this.tokenizer.getParserForLine(e.row,e.col).copy().context.tags.at(-1);if(t?.inner?.l1==e.row&&t.inner.c1==e.col){this._placeUndoBoundary();let e=this.point();this.cmd("insert","</",t.id,">"),this.cmd("goto_char",e)}}),xml_zen_expand:d(function(){this.cmd("xml_zen_stop");var i="",n=this.cmd("save_excursion",function(){for(this.cmd("backward_whitespace");!this.cmd("looking_back",/[\x20\xa0\s\t\n;&]/g)&&this.cmd("backward_char"););return this.point()}),r=this.point();try{!function e(t,i){for(var n=t.repeat||1,r=1;r<=n;++r)r>1&&i("\n"),i("<",t.type),t.id&&i(' id="',t.id.replace(/\$/g,r),'"'),t.klass&&i(' class="',t.klass.replace(/\$/g,r),'"'),t.attributes&&t.attributes.forEach(e=>i(" ",e,'="|"')),i(">"),t.child?(i("\n"),e(t.child,i),i("\n")):i("|"),i("</",t.type,">"),t.next&&(i("\n"),e(t.next,i))}(function e(t,i){var n={type:""},r=1;t:for(;i<t.length;){var s=t.charAt(i++);switch(s){case"#":r=3,n.id="";break;case".":r=2,null!=n.klass?n.klass+=" ":n.klass="";break;case":":r=5,null==n.attributes&&(n.attributes=[]),n.attributes.push("");break;case"*":r=4,n.repeat="";break;case">":n.child=e(t,i),i=n.child.i;break t;case"(":n.child=e(t,i),i=n.child.i;break;case")":break t;case"+":n.next=e(t,i),i=n.next.i;break t;default:switch(r){case 1:n.type+=s;break;case 2:n.klass+=s;break;case 3:n.id+=s;break;case 4:n.repeat=parseInt(String(n.repeat)+s,10);break;case 5:n.attributes.push(n.attributes.pop()+s)}}}return n.i=i,n}(this.cmd("buffer_substring",n,r).trim(),0),(...e)=>i+=e.join(""))}catch(e){throw new u("The Zen is not strong today :-/")}this.cmd("delete_region",n,r),this.cmd("insert",i),n=this.createMarker(n,!1,"xml_zen");var s=this.createMarker(this.point(),!0,"xml_zen"),o=[];for(this.cmd("goto_char",n.getPosition());this.cmd("search_forward","|",s.getPosition());)this.cmd("backward_delete_char"),o.push(this.createMarker(this.point(),!0,"xml_zen_start")),o.push(this.createMarker(this.point(),!1,"xml_zen_end"));this.cmd("indent_region",n.getPosition(),s.getPosition()),o.length>0?(this.cmd("goto_char",o[0]),o.unshift(n),o.push(s),this.setq("xml_zen_markers",o),this.pushKeymap(e),this.addEventListener("afterInteractiveCommand",t)):(n.destroy(),s.destroy())}),xml_zen_stop:d(function(){var i=this.getq("xml_zen_markers");i&&(i.map(e=>e.destroy()),this.setq("xml_zen_markers",null)),this.popKeymap(e),this.removeEventListener("afterInteractiveCommand",t)}),xml_zen_next_poi:d(function(){let e=this.getq("xml_zen_markers"),t=this.point();for(let i=0;i<e.length;++i){let n=e[i];if(n.getPosition()>t){this.cmd("goto_char",n.getPosition());break}}}),xml_zen_prev_poi:d(function(){let e=this.getq("xml_zen_markers"),t=this.point();for(let i=e.length;--i>=0;){let n=e[i];if(n.getPosition()<t){this.cmd("goto_char",n.getPosition());break}}}),xml_newline_and_indent:d(function(){let e=this.looking_at("</")&&this.looking_back(">");this.cmd("newline_and_indent"),e&&(this.cmd("newline_and_indent"),this.cmd("backward_line"),this.cmd("indent_line"))})})}();export{K as Ymacs,A as Ymacs_Buffer,f as Ymacs_Keymap,x as Ymacs_Keymap_Emacs,W as Ymacs_Tokenizer,d as Ymacs_Interactive,u as Ymacs_Exception};
//# sourceMappingURL=ymacs.mjs.map
